--- Archivo: ./templates/index.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Bienvenido{% endblock %}

{% block extra_css %}
<style>
    .welcome-section {
        position: relative;
        min-height: 70vh;
        overflow: hidden;
        display: flex;
        align-items: center;
        padding: 2rem 0;
    }
    
    .background-carousel {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        overflow: hidden;
    }
    
    .background-slide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    
    .background-slide.active {
        opacity: 0.3;
    }
    
    .welcome-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(26, 26, 46, 0.85) 0%, rgba(39, 68, 114, 0.85) 100%);
        z-index: 1;
    }
    
    .welcome-content {
        position: relative;
        z-index: 2;
        color: white;
    }
    
    .welcome-title {
        color: white !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .axion-store-title {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: bold;
    }
    
    .welcome-section p {
        color: rgba(255, 255, 255, 0.95) !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .btn-invitado, .btn-register {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .icon-feature {
        color: var(--primary);
    }
    
    @media (max-width: 768px) {
        .welcome-section {
            min-height: 60vh;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="welcome-section">
    <!-- Carrusel de fondo - RUTAS CORREGIDAS -->
    <div class="background-carousel" id="bgCarousel">
        <div class="background-slide active" style="background-image: url('{{ url_for('static', filename='img/bg1.webp') }}');"></div>
        <div class="background-slide" style="background-image: url('{{ url_for('static', filename='img/bg2.webp') }}');"></div>
        <div class="background-slide" style="background-image: url('{{ url_for('static', filename='img/bg3.webp') }}');"></div>
    </div>
    
    <div class="welcome-overlay"></div>
    
    <div class="container welcome-content">
        <div class="row align-items-center">
            <div class="col-lg-12 text-center">
                <h1 class="display-3 fw-bold mb-4 welcome-title">
                    Te damos la bienvenida a <span class="axion-store-title">Axion Store</span>
                </h1>
                <p class="lead mb-4">La mejor tienda de tecnología. Encuentra los productos más innovadores al mejor precio.</p>
                <p class="fs-5 mb-5">¡Regístrate ahora mismo y disfruta de ofertas exclusivas!</p>
                
                <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
                    <a href="{{ url_for('home') }}" class="btn btn-dark btn-lg px-5 btn-invitado">
                        <i class="fas fa-door-open icon-invitado"></i> <span class="text-invitado">Entrar como Invitado</span>
                    </a>
                    <a href="{{ url_for('register') }}" class="btn btn-outline-light btn-lg px-5 btn-register">
                        <i class="fas fa-user-plus icon-register"></i> <span class="text-register">Registrarse</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row mt-5 mb-5">
        <div class="col-md-4 text-center mb-4">
            <div class="card card-custom h-100 border-0">
                <div class="card-body">
                    <i class="fas fa-shipping-fast fa-3x mb-3 icon-feature"></i>
                    <h5 class="card-title">Envío Rápido</h5>
                    <p class="card-text">Recibe tus productos en tiempo récord</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 text-center mb-4">
            <div class="card card-custom h-100 border-0">
                <div class="card-body">
                    <i class="fas fa-shield-alt fa-3x mb-3 icon-feature"></i>
                    <h5 class="card-title">Compra Segura</h5>
                    <p class="card-text">Tus datos protegidos siempre</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 text-center mb-4">
            <div class="card card-custom h-100 border-0">
                <div class="card-body">
                    <i class="fas fa-headset fa-3x mb-3 icon-feature"></i>
                    <h5 class="card-title">Soporte 24/7</h5>
                    <p class="card-text">Asistencia cuando la necesites</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const slides = document.querySelectorAll('.background-slide');
    if (!slides || slides.length === 0) return;
    
    let currentSlide = 0;
    
    function nextSlide() {
        slides[currentSlide].classList.remove('active');
        currentSlide = (currentSlide + 1) % slides.length;
        slides[currentSlide].classList.add('active');
    }
    
    // Cambiar slide cada 5 segundos
    setInterval(nextSlide, 5000);
});
</script>
{% endblock %}

--- Archivo: ./templates/home.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Productos{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .product-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .product-image-container {
        position: relative;
        background: var(--ps-card);
        border-radius: 8px 8px 0 0;
        padding: 1rem;
    }
    
    .product-image {
        max-height: 200px;
        object-fit: contain;
        transition: transform 0.3s ease;
    }
    
    .product-card:hover .product-image {
        transform: scale(1.05);
    }
    
    .product-placeholder {
        opacity: 0.5;
    }
    
    /* Botón Wishlist */
    .btn-wishlist {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.95);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        text-decoration: none;
    }
    
    .btn-wishlist:hover {
        background: #dc3545;
        transform: scale(1.1);
    }
    
    .btn-wishlist:hover i {
        color: #fff !important;
    }
    
    .btn-wishlist i {
        color: #dc3545;
        font-size: 1.1rem;
        transition: color 0.3s ease;
    }
    
    .btn-wishlist.in-wishlist {
        background: #dc3545;
    }
    
    .btn-wishlist.in-wishlist i {
        color: #fff !important;
    }
    
    /* Estados de stock */
    .out-of-stock {
        opacity: 0.7;
    }
    
    .out-of-stock-overlay,
    .stock-warning-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }
    
    .out-of-stock-overlay .badge,
    .stock-warning-overlay .badge {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
    }
    
    .badge-available {
        background: var(--success);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
    }
    
    .badge-unavailable {
        background: var(--danger);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
    }

    /* Sidebar de categorías */
    .list-group-item.active {
        background-color: #007bff;
        border-color: #007bff;
        font-weight: 600;
    }
    
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .list-group-item.active:hover {
        background-color: #0056b3;
    }
    
    .list-group-item.ps-5 {
        background-color: #f8f9fa;
        border-left: 3px solid #007bff;
    }
    
    .list-group-item.ps-5.active {
        background-color: #007bff;
        color: white;
    }
    
    .breadcrumb {
        background-color: var(--ps-bg);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
    }
    
    /* Modo oscuro para sidebar */
    .dark-mode .list-group-item {
        background-color: var(--ps-card);
        color: var(--ps-text);
        border-color: rgba(255,255,255,0.1);
    }
    
    .dark-mode .list-group-item:hover {
        background-color: rgba(255,255,255,0.05);
    }
    
    .dark-mode .list-group-item.active {
        background-color: var(--ps-accent);
        border-color: var(--ps-accent);
    }
    
    .dark-mode .product-image-container {
        background: var(--ps-card);
    }
    
    .dark-mode .btn-wishlist {
        background: rgba(35, 35, 67, 0.95);
    }
    
    .dark-mode .btn-wishlist i {
        color: #ff6b6b;
    }
    
    .dark-mode .btn-wishlist:hover {
        background: #dc3545;
    }
    
    @media (max-width: 768px) {
        .product-card:hover {
            transform: none;
        }
        
        .card-title {
            font-size: 1.1rem;
        }
        
        .price {
            font-size: 1.5rem;
        }
        
        .sticky-top {
            position: relative !important;
        }
    }
    
    .col {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-5">
    <div class="row">
        <!-- SIDEBAR DE CATEGORÍAS -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card card-custom border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i> Categorías
                    </h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('home') }}" 
                       class="list-group-item list-group-item-action {% if not categoria_actual %}active{% endif %}">
                        <i class="fas fa-th"></i> Todas las categorías
                    </a>
                    
                    {% if productos_sin_categoria > 0 %}
                    <a href="{{ url_for('home', categoria=-1) }}" 
                       class="list-group-item list-group-item-action {% if categoria_actual == -1 %}active{% endif %}">
                        <i class="fas fa-question-circle"></i> Sin categoría
                        <span class="badge bg-warning text-dark float-end">{{ productos_sin_categoria }}</span>
                    </a>
                    {% endif %}
                    
                    {% for categoria in categorias %}
                    <a href="{{ url_for('home', categoria=categoria.ID_Categoria) }}" 
                       class="list-group-item list-group-item-action {% if categoria_actual == categoria.ID_Categoria %}active{% endif %}">
                        <i class="{{ categoria.icono or 'fas fa-box' }}"></i> {{ categoria.nombre }}
                        <span class="badge bg-secondary float-end">{{ categoria.productos|length }}</span>
                    </a>
                    
                    {% if categoria_actual == categoria.ID_Categoria and categoria.subcategorias %}
                        {% for sub in categoria.subcategorias if sub.activa %}
                        <a href="{{ url_for('home', categoria=categoria.ID_Categoria, subcategoria=sub.ID_Subcategoria) }}" 
                           class="list-group-item list-group-item-action ps-5 {% if subcategoria_actual == sub.ID_Subcategoria %}active{% endif %}"
                           style="font-size: 0.9em;">
                            <i class="fas fa-angle-right"></i> {{ sub.nombre }}
                            <span class="badge bg-info float-end">{{ sub.productos|length }}</span>
                        </a>
                        {% endfor %}
                    {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Enlace rápido a Wishlist -->
                {% if session.get('user_id') %}
                <div class="card-footer">
                    <a href="{{ url_for('wishlist') }}" class="btn btn-outline-danger w-100">
                        <i class="fas fa-heart"></i> Mi Lista de Deseos
                        {% if wishlist_count and wishlist_count > 0 %}
                        <span class="badge bg-danger">{{ wishlist_count }}</span>
                        {% endif %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="col-lg-9 col-md-8">
            <!-- Breadcrumb -->
            {% if categoria_actual or subcategoria_actual or search_query %}
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Inicio</a></li>
                    {% if categoria_actual and categoria_actual != -1 %}
                        {% for cat in categorias if cat.ID_Categoria == categoria_actual %}
                        <li class="breadcrumb-item {% if not subcategoria_actual %}active{% endif %}">
                            {% if subcategoria_actual %}
                            <a href="{{ url_for('home', categoria=cat.ID_Categoria) }}">{{ cat.nombre }}</a>
                            {% else %}
                            {{ cat.nombre }}
                            {% endif %}
                        </li>
                        {% endfor %}
                    {% elif categoria_actual == -1 %}
                        <li class="breadcrumb-item active">Sin categoría</li>
                    {% endif %}
                    {% if subcategoria_actual %}
                        {% for cat in categorias if cat.ID_Categoria == categoria_actual %}
                            {% for sub in cat.subcategorias if sub.ID_Subcategoria == subcategoria_actual %}
                            <li class="breadcrumb-item active">{{ sub.nombre }}</li>
                            {% endfor %}
                        {% endfor %}
                    {% endif %}
                    {% if search_query %}
                    <li class="breadcrumb-item active">Búsqueda: "{{ search_query }}"</li>
                    {% endif %}
                </ol>
            </nav>
            {% endif %}

            <!-- Barra de Búsqueda y Filtros -->
            <div class="card card-custom border-0 mb-4">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('home') }}" class="row g-3 align-items-end">
                        {% if categoria_actual %}
                        <input type="hidden" name="categoria" value="{{ categoria_actual }}">
                        {% endif %}
                        {% if subcategoria_actual %}
                        <input type="hidden" name="subcategoria" value="{{ subcategoria_actual }}">
                        {% endif %}
                        
                        <div class="col-md-4">
                            <label for="search" class="form-label">
                                <i class="fas fa-search"></i> Buscar productos
                            </label>
                            <input type="text" 
                                class="form-control" 
                                id="search" 
                                name="search" 
                                data-autocomplete="product"
                                placeholder="Nombre del producto..."
                                value="{{ search_query }}">
                        </div>
                        
                        <div class="col-md-3">
                            <label for="sort" class="form-label">
                                <i class="fas fa-sort"></i> Ordenar por
                            </label>
                            <select class="form-select" id="sort" name="sort" onchange="this.form.submit()">
                                <option value="nombre" {% if sort_by == 'nombre' %}selected{% endif %}>Nombre (A-Z)</option>
                                <option value="precio_asc" {% if sort_by == 'precio_asc' %}selected{% endif %}>Precio (Menor a Mayor)</option>
                                <option value="precio_desc" {% if sort_by == 'precio_desc' %}selected{% endif %}>Precio (Mayor a Menor)</option>
                                <option value="stock" {% if sort_by == 'stock' %}selected{% endif %}>Disponibilidad</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary-custom w-100">
                                <i class="fas fa-filter"></i> Aplicar Filtros
                            </button>
                        </div>
                        
                        <div class="col-md-2">
                            <a href="{{ url_for('home') }}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-refresh"></i> Limpiar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Resultados -->
            {% if search_query %}
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle"></i> 
                Resultados para: <strong>"{{ search_query }}"</strong> 
                - {{ productos.total if productos.total is defined else productos|length }} producto(s)
            </div>
            {% endif %}

            {% if categoria_actual or subcategoria_actual %}
            <div class="alert alert-success mb-4">
                <i class="fas fa-filter"></i> 
                Filtrando por: 
                {% if categoria_actual and categoria_actual != -1 %}
                    {% for cat in categorias if cat.ID_Categoria == categoria_actual %}
                    <strong><i class="{{ cat.icono }}"></i> {{ cat.nombre }}</strong>
                    {% endfor %}
                    {% if subcategoria_actual %}
                        {% for cat in categorias if cat.ID_Categoria == categoria_actual %}
                            {% for sub in cat.subcategorias if sub.ID_Subcategoria == subcategoria_actual %}
                            → <strong>{{ sub.nombre }}</strong>
                            {% endfor %}
                        {% endfor %}
                    {% endif %}
                {% elif categoria_actual == -1 %}
                    <strong>Sin categoría</strong>
                {% endif %}
                <a href="{{ url_for('home') }}" class="btn btn-sm btn-outline-success ms-2">
                    <i class="fas fa-times"></i> Quitar filtro
                </a>
            </div>
            {% endif %}

            <!-- Grid de Productos -->
            {% if productos %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for producto in productos %}
                <div class="col">
                    <div class="card card-custom h-100 border-0 product-card {% if not producto.disponible or producto.stock <= 0 %}out-of-stock{% endif %}">
                        <div class="text-center product-image-container">
                            <!-- ✅ BOTÓN WISHLIST -->
                            {% if session.get('user_id') %}
                            <a href="{{ url_for('add_to_wishlist', producto_id=producto.ID_Producto) }}" 
                               class="btn-wishlist" 
                               title="Agregar a favoritos">
                                <i class="fas fa-heart"></i>
                            </a>
                            {% endif %}
                            
                            {% if producto.imagen %}
                                <a href="{{ url_for('product_detail', producto_id=producto.ID_Producto) }}">
                                    <img src="{{ url_for('static', filename=producto.imagen) }}" loading="lazy"
                                         class="img-fluid product-image" 
                                         alt="{{ producto.nombre }}"
                                         onerror="this.src='https://via.placeholder.com/300x200?text=Imagen+No+Disponible'">
                                </a>
                            {% else %}
                                <a href="{{ url_for('product_detail', producto_id=producto.ID_Producto) }}">
                                    <i class="fas fa-image fa-5x text-muted product-placeholder"></i>
                                </a>
                            {% endif %}
                            
                            {% if not producto.disponible or producto.stock <= 0 %}
                                <div class="out-of-stock-overlay">
                                    <span class="badge bg-danger">AGOTADO</span>
                                </div>
                            {% elif producto.stock <= 5 %}
                                <div class="stock-warning-overlay">
                                    <span class="badge bg-warning text-dark">ÚLTIMAS UNIDADES</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold product-name">
                                <a href="{{ url_for('product_detail', producto_id=producto.ID_Producto) }}" 
                                   class="text-decoration-none text-reset">{{ producto.nombre }}</a>
                            </h5>
                            
                            {% if producto.categoria %}
                            <p class="mb-2">
                                <small class="badge bg-primary">
                                    <i class="{{ producto.categoria.icono }}"></i> {{ producto.categoria.nombre }}
                                </small>
                                {% if producto.subcategoria %}
                                <br>
                                <small class="badge bg-secondary mt-1">{{ producto.subcategoria.nombre }}</small>
                                {% endif %}
                            </p>
                            {% endif %}
                            
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="fs-4 fw-bold text-primary price">
                                        ${{ "%.2f"|format(producto.precio) }}
                                    </span>
                                    
                                    {% if producto.disponible and producto.stock > 0 %}
                                        <span class="badge badge-available">
                                            <i class="fas fa-check-circle"></i> Disponible
                                        </span>
                                    {% else %}
                                        <span class="badge badge-unavailable">
                                            <i class="fas fa-times-circle"></i> Agotado
                                        </span>
                                    {% endif %}
                                </div>
                                
                                {% if producto.stock > 0 %}
                                    <p class="text-muted mb-3 stock-info">
                                        <i class="fas fa-box"></i> 
                                        {% if producto.stock > 10 %}
                                            <span class="text-success">Stock: {{ producto.stock }} unidades</span>
                                        {% elif producto.stock > 5 %}
                                            <span class="text-warning">Stock: {{ producto.stock }} unidades</span>
                                        {% else %}
                                            <span class="text-danger">¡Solo quedan {{ producto.stock }}!</span>
                                        {% endif %}
                                    </p>
                                {% endif %}
                                
                                <!-- Botones de acción -->
                                <div class="d-flex gap-2">
                                    {% if producto.disponible and producto.stock > 0 %}
                                        <a href="{{ url_for('add_to_cart', producto_id=producto.ID_Producto) }}" 
                                           class="btn btn-primary-custom flex-grow-1 add-to-cart-btn">
                                            <i class="fas fa-cart-plus"></i> Agregar
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary flex-grow-1" disabled>
                                            <i class="fas fa-ban"></i> No Disponible
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Paginación -->
            {% if productos.pages > 1 %}
            <nav class="mt-5">
                <ul class="pagination justify-content-center">
                    {% if productos.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('home', page=productos.prev_num, search=search_query, sort=sort_by, categoria=categoria_actual, subcategoria=subcategoria_actual) }}">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in productos.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                        <li class="page-item {% if page_num == productos.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('home', page=page_num, search=search_query, sort=sort_by, categoria=categoria_actual, subcategoria=subcategoria_actual) }}">{{ page_num }}</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if productos.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('home', page=productos.next_num, search=search_query, sort=sort_by, categoria=categoria_actual, subcategoria=subcategoria_actual) }}">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-5x text-muted mb-4"></i>
                <h3 class="text-muted mb-3">
                    {% if search_query or categoria_actual or subcategoria_actual %}
                        No se encontraron productos
                    {% else %}
                        No hay productos disponibles
                    {% endif %}
                </h3>
                <p class="mb-4">
                    {% if search_query %}
                        No hay productos que coincidan con "{{ search_query }}"
                    {% elif categoria_actual %}
                        No hay productos en esta categoría
                    {% else %}
                        Vuelve pronto para ver nuestras ofertas
                    {% endif %}
                </p>
                <a href="{{ url_for('home') }}" class="btn btn-primary-custom">
                    <i class="fas fa-arrow-left"></i> Ver Todos los Productos
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

--- Archivo: ./templates/perfil.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Mi Perfil{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header del Perfil -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-custom border-0">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
                                 style="width: 100px; height: 100px; font-size: 2.5rem;">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h2 class="fw-bold mb-1">{{ usuario.nombre }}</h2>
                            <p class="text-muted mb-2">
                                <i class="fas fa-envelope"></i> {{ usuario.email }}
                            </p>
                            <p class="mb-0">
                                <span class="badge
                                    {% if usuario.segmento_cliente == 'activo' %}bg-success
                                    {% elif usuario.segmento_cliente == 'inactivo' %}bg-secondary
                                    {% else %}bg-primary{% endif %} me-2">
                                    <i class="fas fa-star"></i> {{ usuario.segmento_cliente|capitalize }}
                                </span>
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i>
                                    Miembro desde {{ usuario.fecha_registro.strftime('%d/%m/%Y') if usuario.fecha_registro else 'N/A' }}
                                </small>
                            </p>
                        </div>
                        <div class="col-md-3 text-md-end mt-3 mt-md-0">
                            <a href="{{ url_for('editar_perfil') }}" class="btn btn-primary-custom">
                                <i class="fas fa-edit"></i> Editar Perfil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Estadísticas -->
        <div class="col-md-4 mb-4">
            <div class="card card-custom border-0 h-100">
                <div class="card-body text-center">
                    <i class="fas fa-wallet fa-3x mb-3" style="color: var(--primary);"></i>
                    <h3 class="fw-bold">${{ "%.2f"|format(wallet.saldo if wallet else 0) }}</h3>
                    <p class="text-muted mb-3">Saldo Disponible</p>
                    <a href="{{ url_for('wallet') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus"></i> Recargar
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card card-custom border-0 h-100">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-bag fa-3x mb-3" style="color: var(--primary);"></i>
                    <h3 class="fw-bold">{{ usuario.total_compras }}</h3>
                    <p class="text-muted mb-3">Compras Realizadas</p>
                    <a href="{{ url_for('historial') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-history"></i> Ver Historial
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card card-custom border-0 h-100">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-3x mb-3" style="color: var(--primary);"></i>
                    <h3 class="fw-bold">${{ "%.2f"|format(usuario.total_gastado) }}</h3>
                    <p class="text-muted mb-3">Total Gastado</p>
                    <p class="small text-muted mb-0">
                        Ticket promedio: ${{ "%.2f"|format(usuario.ticket_promedio) }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Últimos Pedidos -->
        <div class="col-md-6 mb-4">
            <div class="card card-custom border-0 h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt"></i> Últimos Pedidos
                    </h5>
                </div>
                <div class="card-body">
                    {% if ultimos_pedidos %}
                        {% for pedido in ultimos_pedidos %}
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                            <div>
                                <strong>Pedido #{{ pedido.ID_Pedido }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="fw-bold text-success">${{ "%.2f"|format(pedido.total) }}</span>
                                <br>
                                <span class="badge bg-success">{{ pedido.estado }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-4">
                            <i class="fas fa-shopping-bag fa-2x mb-2 d-block"></i>
                            No tienes pedidos aún
                        </p>
                    {% endif %}

                    <a href="{{ url_for('historial') }}" class="btn btn-outline-primary w-100 mt-2">
                        Ver Todos los Pedidos
                    </a>
                </div>
            </div>
        </div>

        <!-- Últimas Transacciones -->
        <div class="col-md-6 mb-4">
            <div class="card card-custom border-0 h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt"></i> Últimas Transacciones
                    </h5>
                </div>
                <div class="card-body">
                    {% if ultimas_transacciones %}
                        {% for trans in ultimas_transacciones %}
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                            <div>
                                <span class="badge
                                    {% if trans.tipo == 'recarga' %}bg-success
                                    {% elif trans.tipo == 'compra' %}bg-primary
                                    {% else %}bg-warning text-dark{% endif %} me-2">
                                    {{ trans.tipo|capitalize }}
                                </span>
                                <br>
                                <small class="text-muted">
                                    {{ trans.fecha.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="fw-bold {% if trans.monto > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "+" if trans.monto > 0 else "" }}${{ "%.2f"|format(trans.monto) }}
                                </span>
                                <br>
                                <small class="text-muted">
                                    Saldo: ${{ "%.2f"|format(trans.saldo_nuevo) }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-4">
                            <i class="fas fa-wallet fa-2x mb-2 d-block"></i>
                            No tienes transacciones aún
                        </p>
                    {% endif %}

                    <a href="{{ url_for('wallet') }}" class="btn btn-outline-primary w-100 mt-2">
                        Ir a Mi Wallet
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Información Adicional -->
    <div class="row">
        <div class="col-12">
            <div class="card card-custom border-0">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Resumen de Actividad
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <h4 class="fw-bold text-primary">{{ usuario.total_recargas }}</h4>
                            <small class="text-muted">Recargas Realizadas</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h4 class="fw-bold text-success">${{ "%.2f"|format(usuario.dinero_recargado_total) }}</h4>
                            <small class="text-muted">Total Recargado</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h4 class="fw-bold text-info">{{ usuario.productos_carrito_actual }}</h4>
                            <small class="text-muted">Productos en Carrito</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h4 class="fw-bold text-warning">{{ "%.1f"|format(usuario.tasa_conversion) }}%</h4>
                            <small class="text-muted">Tasa de Conversión</small>
                        </div>
                    </div>

                    {% if usuario.ultimo_pedido_fecha %}
                    <hr>
                    <p class="text-muted text-center mb-0">
                        <i class="fas fa-clock"></i>
                        Última compra: {{ usuario.ultimo_pedido_fecha.strftime('%d/%m/%Y %H:%M') }}
                        {% if usuario.dias_desde_ultima_compra %}
                        (hace {{ usuario.dias_desde_ultima_compra }} días)
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Preferencias de Tema -->
    <div class="row mt-4">
        <div class="col-md-6 offset-md-3">
            <div class="card card-custom border-0">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0"><i class="fas fa-adjust"></i> Preferencias de Tema</h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted">Selecciona tu preferencia de tema. Se aplicará inmediatamente.</p>
                    <div class="d-flex gap-2">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="axion_theme" id="theme-light" value="light">
                            <label class="form-check-label" for="theme-light">Tema Claro</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="axion_theme" id="theme-system" value="system">
                            <label class="form-check-label" for="theme-system">Tema del dispositivo</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="axion_theme" id="theme-dark" value="dark">
                            <label class="form-check-label" for="theme-dark">Tema Oscuro</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function getSavedTheme() { return localStorage.getItem('axion-theme') || 'system'; }

    function reflectSelection(t) {
        document.getElementById('theme-light').checked = (t === 'light');
        document.getElementById('theme-dark').checked = (t === 'dark');
        document.getElementById('theme-system').checked = (t === 'system');
    }

    var initial = getSavedTheme();
    reflectSelection(initial);

    document.querySelectorAll('input[name="axion_theme"]').forEach(function(r) {
        r.addEventListener('change', function() {
            var v = this.value;
            if (window.setAxionTheme) {
                window.setAxionTheme(v);
            } else {
                localStorage.setItem('axion-theme', v);
                location.reload();
            }
            reflectSelection(v);
        });
    });
});
</script>
{% endblock %}

--- Archivo: ./templates/register.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Registro{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center align-items-center" style="min-height: 70vh;">
        <div class="col-md-6">
            <div class="card card-custom shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-plus fa-4x" style="color: var(--primary);"></i>
                        <h2 class="mt-3 fw-bold">Crear Cuenta</h2>
                        <p class="text-muted">Únete a la familia Axion Store</p>
                    </div>
                    
                    <form method="POST" action="{{ url_for('register') }}" id="registerForm">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">
                                <i class="fas fa-user"></i> Nombre Completo
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="nombre" 
                                   name="nombre" 
                                   placeholder="Juan Pérez" 
                                   required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope"></i> Correo Electrónico
                            </label>
                            <input type="email" 
                                   class="form-control form-control-lg" 
                                   id="email" 
                                   name="email" 
                                   placeholder="tu@email.com" 
                                   required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock"></i> Contraseña
                            </label>
                            <div class="password-wrapper">
                                <input type="password"
                                       class="form-control form-control-lg password-input"
                                       id="password"
                                       name="password"
                                       placeholder="••••••••"
                                       required
                                       minlength="6">
                                <button type="button" class="password-toggle" aria-pressed="false" aria-label="Mostrar contraseña" title="Mostrar contraseña">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">Mínimo 6 caracteres</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="confirm_password" class="form-label">
                                <i class="fas fa-lock"></i> Confirmar Contraseña
                            </label>
                            <div class="password-wrapper">
                                <input type="password"
                                       class="form-control form-control-lg password-input"
                                       id="confirm_password"
                                       name="confirm_password"
                                       placeholder="••••••••"
                                       required>
                                <button type="button" class="password-toggle" aria-pressed="false" aria-label="Mostrar contraseña" title="Mostrar contraseña">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="terms" required>
                            <label class="form-check-label" for="terms">
                                Acepto los <a href="#">términos y condiciones</a>
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary-custom btn-lg w-100 mb-3">
                            <i class="fas fa-user-check"></i> Registrarse
                        </button>
                    </form>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <p class="mb-0">¿Ya tienes cuenta? 
                            <a href="{{ url_for('login') }}" class="fw-bold text-decoration-none" style="color: var(--primary);">
                                Inicia sesión aquí
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('registerForm').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (password !== confirmPassword) {
        e.preventDefault();
        alert('Las contraseñas no coinciden');
    }
});
</script>
{% endblock %}
--- Archivo: ./templates/historial.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Mis Pedidos{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="display-4 fw-bold mb-4">
        <i class="fas fa-history"></i> Historial de Pedidos
    </h1>
    
    {% if pedidos %}
    <div class="row">
        {% for pedido in pedidos %}
        <div class="col-12 mb-4">
            <div class="card card-custom border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-receipt"></i> Pedido #{{ pedido.ID_Pedido }}
                        </h5>
                        <span class="badge bg-success">{{ pedido.estado }}</span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1">
                                <i class="fas fa-calendar"></i> 
                                <strong>Fecha:</strong> {{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <p class="mb-1">
                                <i class="fas fa-dollar-sign"></i> 
                                <strong>Total:</strong> 
                                <span class="fs-5 fw-bold" style="color: var(--primary);">
                                    ${{ "%.2f"|format(pedido.total) }}
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    {% if pedido.detalles %}
                    <hr>
                    <h6 class="mb-3">Productos:</h6>
                    <ul class="list-unstyled">
                        {% for detalle in pedido.detalles %}
                        <li class="mb-2">
                            <i class="fas fa-box text-muted"></i>
                            {{ detalle.cantidad }}x 
                            <strong>Producto ID: {{ detalle.ID_Producto }}</strong>
                            - ${{ "%.2f"|format(detalle.precio_unitario) }} c/u
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-shopping-bag fa-5x text-muted mb-4"></i>
        <h3 class="text-muted mb-3">No tienes pedidos aún</h3>
        <p class="mb-4">Realiza tu primera compra</p>
        <a href="{{ url_for('home') }}" class="btn btn-primary-custom btn-lg">
            <i class="fas fa-store"></i> Ir a la Tienda
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
--- Archivo: ./templates/editar_perfil.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Editar Perfil{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card card-custom border-0">
                <div class="card-header bg-transparent border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-user-edit"></i> Editar Perfil
                        </h4>
                        <a href="{{ url_for('perfil') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('editar_perfil') }}">
                        <!-- Información Básica -->
                        <h5 class="mb-3 text-muted">Información Básica</h5>

                        <div class="mb-3">
                            <label for="nombre" class="form-label">
                                <i class="fas fa-user"></i> Nombre Completo
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="nombre"
                                   name="nombre"
                                   value="{{ usuario.nombre }}"
                                   required
                                   minlength="3">
                        </div>

                        <div class="mb-4">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope"></i> Correo Electrónico
                            </label>
                            <input type="email"
                                   class="form-control"
                                   id="email"
                                   name="email"
                                   value="{{ usuario.email }}"
                                   required>
                        </div>

                        <hr class="my-4">

                        <!-- Cambiar Contraseña -->
                        <h5 class="mb-3 text-muted">Cambiar Contraseña <small class="text-muted">(opcional)</small></h5>

                        <div class="mb-3">
                            <label for="password_actual" class="form-label">
                                <i class="fas fa-lock"></i> Contraseña Actual
                            </label>
                            <div class="password-wrapper">
                                <input type="password"
                                       class="form-control password-input"
                                       id="password_actual"
                                       name="password_actual"
                                       placeholder="Ingresa tu contraseña actual">
                                <button type="button" class="password-toggle" aria-pressed="false" aria-label="Mostrar contraseña">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="password_nueva" class="form-label">
                                <i class="fas fa-key"></i> Nueva Contraseña
                            </label>
                            <div class="password-wrapper">
                                <input type="password"
                                       class="form-control password-input"
                                       id="password_nueva"
                                       name="password_nueva"
                                       placeholder="Mínimo 6 caracteres"
                                       minlength="6">
                                <button type="button" class="password-toggle" aria-pressed="false" aria-label="Mostrar contraseña">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                Deja en blanco si no deseas cambiar la contraseña
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-custom btn-lg">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                            <a href="{{ url_for('perfil') }}" class="btn btn-outline-secondary">
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Información de la Cuenta -->
            <div class="card card-custom border-0 mt-4">
                <div class="card-body">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-info-circle"></i> Información de la Cuenta
                    </h6>
                    <ul class="list-unstyled small text-muted mb-0">
                        <li><i class="fas fa-calendar me-2"></i> Registrado: {{ usuario.fecha_registro.strftime('%d/%m/%Y') if usuario.fecha_registro else 'N/A' }}</li>
                        <li><i class="fas fa-user-tag me-2"></i> Segmento: {{ usuario.segmento_cliente|capitalize }}</li>
                        <li><i class="fas fa-shield-alt me-2"></i> Rol: {% if usuario.es_admin %}Administrador{% else %}Usuario{% endif %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


--- Archivo: ./templates/wallet.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Mi Wallet{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wallet.css') }}">
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header de la Wallet -->
    <div class="wallet-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-wallet"></i> Mi Wallet
                </h1>
                <p class="lead mb-0">Gestiona tu saldo y realiza recargas</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="wallet-balance">${{ "%.2f"|format(wallet.saldo) }}</div>
                <small class="opacity-75">Saldo actual</small>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sección de Recarga -->
        <div class="col-lg-8">
            <div class="card wallet-card mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">
                        <i class="fas fa-plus-circle text-primary"></i> Recargar Saldo
                    </h3>

                    <!-- Opciones de recarga rápida -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Recarga Rápida</label>
                        <div class="recarga-options" id="recargaOpciones">
                            <div class="recarga-option" data-monto="10">
                                <div class="recarga-amount">$10</div>
                                <div class="recarga-bonus">+$0 bonus</div>
                            </div>
                            <div class="recarga-option" data-monto="20">
                                <div class="recarga-amount">$20</div>
                                <div class="recarga-bonus">+$0 bonus</div>
                            </div>
                            <div class="recarga-option" data-monto="50">
                                <div class="recarga-amount">$50</div>
                                <div class="recarga-bonus">+$5 bonus</div>
                            </div>
                            <div class="recarga-option" data-monto="100">
                                <div class="recarga-amount">$100</div>
                                <div class="recarga-bonus">+$15 bonus</div>
                            </div>
                        </div>
                    </div>

                    <!-- Monto personalizado -->
                    <div class="custom-amount">
                        <label for="montoPersonalizado" class="form-label fw-bold">Monto Personalizado</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="montoPersonalizado"
                                   name="monto"
                                   min="1" 
                                   max="10000" 
                                   step="0.01"
                                   placeholder="0.00"
                                   required>
                        </div>
                        <div class="form-text">
                            Ingresa un monto entre $1 y $10,000
                        </div>
                    </div>

                    <!-- Información de límites -->
                    <div class="limites-info">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-info-circle"></i> Información Importante
                        </h6>
                        <ul class="mb-0">
                            <li>Mínimo de recarga: $1</li>
                            <li>Máximo de recarga: $10,000</li>
                            <li>Las recargas se procesan instantáneamente</li>
                            <li>El saldo no tiene fecha de expiración</li>
                        </ul>
                    </div>

                    <!-- Botón de recarga -->
                    <form method="POST" action="{{ url_for('recargar_saldo') }}" id="recargaForm">
                        <input type="hidden" name="monto" id="montoFinal">
                        <button type="submit" class="btn btn-primary-custom btn-lg w-100 mt-4 recarga-btn">
                            <i class="fas fa-bolt"></i> Recargar Wallet
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Información Adicional -->
        <div class="col-lg-4">
            <!-- Beneficios -->
            <div class="card wallet-card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-gift text-primary"></i> Beneficios
                    </h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Compras más rápidas
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Pago seguro integrado
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Control de gastos
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Historial de transacciones
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="card wallet-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-rocket text-primary"></i> Acciones Rápidas
                    </h5>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('home') }}" class="btn btn-outline-primary">
                            <i class="fas fa-shopping-bag"></i> Ir de Compras
                        </a>
                        <a href="{{ url_for('historial') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-history"></i> Ver Historial
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const opcionesRecarga = document.querySelectorAll('.recarga-option');
    const inputMonto = document.getElementById('montoPersonalizado');
    const montoFinal = document.getElementById('montoFinal');
    const formRecarga = document.getElementById('recargaForm');

    // Manejar selección de opciones de recarga rápida
    opcionesRecarga.forEach(opcion => {
        opcion.addEventListener('click', function() {
            // Remover selección anterior
            opcionesRecarga.forEach(o => o.classList.remove('selected'));
            
            // Seleccionar actual
            this.classList.add('selected');
            
            // Establecer monto
            const monto = this.getAttribute('data-monto');
            inputMonto.value = monto;
            montoFinal.value = monto;
        });
    });

    // Actualizar monto final cuando cambia el input
    inputMonto.addEventListener('input', function() {
        montoFinal.value = this.value;
        
        // Remover selección de opciones rápidas si se ingresa monto manual
        if (this.value) {
            opcionesRecarga.forEach(o => o.classList.remove('selected'));
        }
    });

    // Validación del formulario
    formRecarga.addEventListener('submit', function(e) {
        const monto = parseFloat(montoFinal.value);
        
        if (!monto || monto < 1) {
            e.preventDefault();
            alert('Por favor ingresa un monto válido (mínimo $1)');
            return;
        }
        
        if (monto > 10000) {
            e.preventDefault();
            alert('El monto máximo de recarga es $10,000');
            return;
        }
        
        // Confirmación de recarga
        if (!confirm(`¿Estás seguro de que quieres recargar $${monto.toFixed(2)} a tu wallet?`)) {
            e.preventDefault();
            return;
        }
        
        // Mostrar loading
        const btn = this.querySelector('button[type="submit"]');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
        btn.disabled = true;
    });

    // Seleccionar primera opción por defecto
    if (opcionesRecarga.length > 0) {
        opcionesRecarga[0].click();
    }
});
</script>
{% endblock %}
--- Archivo: ./templates/cart.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Carrito{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="display-4 fw-bold mb-4">
        <i class="fas fa-shopping-cart"></i> Mi Carrito
    </h1>
    
    {% if productos %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card card-custom border-0 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Productos en tu carrito</h5>
                        <span class="badge bg-primary">{{ productos|length }} producto(s)</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Precio Unit.</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in productos %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-box me-3 text-muted"></i>
                                            <div>
                                                <strong>{{ item.nombre }}</strong>
                                                {% if item.stock_disponible <= 5 and item.stock_disponible > 0 %}
                                                    <br><small class="stock-warning">
                                                        <i class="fas fa-exclamation-triangle"></i> 
                                                        Solo quedan {{ item.stock_disponible }}
                                                    </small>
                                                {% elif item.stock_disponible == 0 %}
                                                    <br><small class="stock-danger">
                                                        <i class="fas fa-times-circle"></i> 
                                                        Agotado
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">${{ "%.2f"|format(item.precio) }}</td>
                                    <td class="text-center">
                                        <div class="d-flex align-items-center justify-content-center">
                                            <form method="POST" action="{{ url_for('update_cart_quantity', cart_id=item.ID_Carrito) }}" 
                                                  class="d-flex align-items-center quantity-form">
                                                <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn" 
                                                        data-action="decrease" data-cart-id="{{ item.ID_Carrito }}"
                                                        {% if item.cantidad <= 1 %}disabled{% endif %}>
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                
                                                <input type="number" 
                                                       name="cantidad" 
                                                       value="{{ item.cantidad }}" 
                                                       min="1" 
                                                       max="{{ item.stock_disponible }}"
                                                       class="form-control form-control-sm mx-2 quantity-input"
                                                       data-cart-id="{{ item.ID_Carrito }}"
                                                       onchange="this.form.submit()">
                                                
                                                <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn" 
                                                        data-action="increase" data-cart-id="{{ item.ID_Carrito }}"
                                                        {% if item.cantidad >= item.stock_disponible %}disabled{% endif %}>
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </form>
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            Máx: {{ item.stock_disponible }} unidades
                                        </small>
                                    </td>
                                    <td class="text-end fw-bold">${{ "%.2f"|format(item.subtotal) }}</td>
                                    <td class="text-center">
                                        <a href="{{ url_for('remove_from_cart', cart_id=item.ID_Carrito) }}" 
                                           class="btn btn-sm btn-danger remove-btn"
                                           onclick="return confirm('¿Estás seguro de que quieres eliminar este producto del carrito?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card card-custom border-0 cart-summary">
                <div class="card-body">
                    <h5 class="card-title mb-4">Resumen del Pedido</h5>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span class="fw-bold">${{ "%.2f"|format(total) }}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Envío:</span>
                        <span class="text-success fw-bold">Gratis</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span class="fs-5 fw-bold">Total:</span>
                        <span class="fs-5 fw-bold text-primary">${{ "%.2f"|format(total) }}</span>
                    </div>
                    
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-wallet"></i> 
                        Saldo disponible: <strong>${{ "%.2f"|format(saldo) }}</strong>
                    </div>
                    
                    {% if saldo >= total %}
                        <form method="POST" action="{{ url_for('comprar') }}">
                            <button type="submit" class="btn btn-primary-custom btn-lg w-100 mb-3">
                                <i class="fas fa-credit-card"></i> Proceder al Pago
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            Saldo insuficiente. Recarga tu wallet para completar la compra.
                        </div>
                        <a href="{{ url_for('wallet') }}" class="btn btn-warning btn-lg w-100 mb-3">
                            <i class="fas fa-coins"></i> Recargar Saldo
                        </a>
                    {% endif %}
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('clear_cart') }}" 
                           class="btn btn-outline-danger"
                           onclick="return confirm('¿Estás seguro de que quieres vaciar todo el carrito?')">
                            <i class="fas fa-trash"></i> Vaciar Carrito
                        </a>
                        
                        <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Seguir Comprando
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <div class="empty-cart">
        <i class="fas fa-shopping-cart text-muted"></i>
        <h3 class="text-muted mb-3">Tu carrito está vacío</h3>
        <p class="mb-4">Agrega productos para comenzar tu compra</p>
        <a href="{{ url_for('home') }}" class="btn btn-primary-custom btn-lg">
            <i class="fas fa-store"></i> Ir a la Tienda
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para manejar los botones de cantidad
    function handleQuantityChange(action, cartId) {
        const input = document.querySelector(`.quantity-input[data-cart-id="${cartId}"]`);
        let currentValue = parseInt(input.value);
        const max = parseInt(input.max);
        const min = parseInt(input.min);
        
        if (action === 'increase' && currentValue < max) {
            input.value = currentValue + 1;
            input.form.submit();
        } else if (action === 'decrease' && currentValue > min) {
            input.value = currentValue - 1;
            input.form.submit();
        }
    }
    
    // Event listeners para los botones de cantidad
    document.querySelectorAll('.quantity-btn').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            const cartId = this.getAttribute('data-cart-id');
            handleQuantityChange(action, cartId);
        });
    });
    
    // Validación del input de cantidad
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('blur', function() {
            const value = parseInt(this.value);
            const max = parseInt(this.max);
            const min = parseInt(this.min);
            
            if (isNaN(value) || value < min) {
                this.value = min;
            } else if (value > max) {
                this.value = max;
                alert(`Solo hay ${max} unidades disponibles de este producto`);
            }
        });
        
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.blur();
            }
        });
    });
});
</script>
{% endblock %}
--- Archivo: ./templates/product.html ---
{% extends "base.html" %}

{% block title %}{{ producto.nombre }} - Axion Store{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <div class="col-md-6">
      <div class="card card-custom">
        <div class="card-body text-center">
          {% if producto.imagen %}
            <div class="product-image-zoom-wrapper" style="display:inline-block;position:relative;">
              <img id="product-main-image" src="{{ url_for('static', filename=producto.imagen) }}" alt="{{ producto.nombre }}" class="img-fluid" style="max-height:420px; object-fit:contain; cursor:zoom-in;" onerror="this.src='https://via.placeholder.com/600x400?text=Imagen+No+Disponible'">
              <div id="img-magnifier" style="display:none; position:absolute; pointer-events:none; border:1px solid rgba(0,0,0,0.1); box-shadow:0 6px 18px rgba(0,0,0,0.15); border-radius:6px; background-repeat:no-repeat; z-index:1050;"></div>
            </div>
          {% else %}
            <i class="fas fa-image fa-7x text-muted"></i>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <h2 class="fw-bold">{{ producto.nombre }}</h2>
      <p class="text-muted mb-1">
        {% if categoria %}
          <small class="badge bg-primary"><i class="{{ categoria.icono }}"></i> {{ categoria.nombre }}</small>
        {% endif %}
        {% if subcategoria %}
          <small class="badge bg-secondary ms-1">{{ subcategoria.nombre }}</small>
        {% endif %}
      </p>

      <h3 class="text-primary mt-3">${{ "%.2f"|format(producto.precio) }}</h3>

      {% if producto.disponible and producto.stock > 0 %}
        <p class="text-success">Stock: {{ producto.stock }} unidades</p>
        <a href="{{ url_for('add_to_cart', producto_id=producto.ID_Producto) }}" class="btn btn-primary-custom btn-lg w-100">
          <i class="fas fa-cart-plus"></i> Agregar al carrito
        </a>
      {% else %}
        <p class="text-danger">Producto no disponible</p>
        <button class="btn btn-secondary w-100" disabled><i class="fas fa-ban"></i> No disponible</button>
      {% endif %}

      <hr>
      <h5>Descripción</h5>
      <p class="text-muted">{{ producto.descripcion or 'No hay descripción disponible.' }}</p>

      {% if related_products %}
      <hr>
      <h5>Productos relacionados</h5>
      <div class="row g-3 mt-2">
          {% for rp in related_products %}
          <div class="col-6 col-md-4">
              <div class="card card-custom h-100">
                  <a href="{{ url_for('product_detail', producto_id=rp.ID_Producto) }}">
                    {% if rp.imagen %}
                      <img src="{{ url_for('static', filename=rp.imagen) }}" loading="lazy" class="img-fluid" style="height:120px;object-fit:contain;" alt="{{ rp.nombre }}">
                    {% else %}
                      <div class="d-flex align-items-center justify-content-center" style="height:120px;background:#f5f5f5;"><i class="fas fa-image text-muted"></i></div>
                    {% endif %}
                  </a>
                  <div class="card-body p-2">
                      <a href="{{ url_for('product_detail', producto_id=rp.ID_Producto) }}" class="text-decoration-none text-reset">
                        <div class="small fw-bold">{{ rp.nombre }}</div>
                      </a>
                      <div class="small text-muted">${{ "%.2f"|format(rp.precio) }}</div>
                  </div>
              </div>
          </div>
          {% endfor %}
      </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}

  {% block extra_js %}
  <style>
    /* Estilos del magnificador */
    #img-magnifier {
      width: 220px;
      height: 220px;
      background-size: 800px 800px; /* se ajustará dinámicamente */
      transition: opacity 0.12s ease;
      opacity: 0.98;
    }

    /* Modal image container tweaks */
    .zoom-modal-img {
      cursor: grab;
      touch-action: none;
      max-width: 100%;
      max-height: 80vh;
      transform-origin: 0 0;
    }
  </style>

  <!-- Modal para vista ampliada con pan/zoom -->
  <div class="modal fade" id="zoomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ producto.nombre }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="zoom-modal-image" src="{{ url_for('static', filename=producto.imagen) }}" alt="{{ producto.nombre }}" class="zoom-modal-img" />
        </div>
        <div class="modal-footer">
          <small class="text-muted me-auto">Usa la rueda del ratón para acercar/alejar. Arrastra para desplazar.</small>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const img = document.getElementById('product-main-image');
    const magnifier = document.getElementById('img-magnifier');
    const wrapper = document.querySelector('.product-image-zoom-wrapper');

    if (img && magnifier && wrapper) {
      let zoom = 2.2; // factor de zoom del lente
      let imgNaturalW = 0, imgNaturalH = 0;

      // Cuando la imagen cargue, establecemos background-size
      function refreshNatural() {
        imgNaturalW = img.naturalWidth || img.width;
        imgNaturalH = img.naturalHeight || img.height;
        magnifier.style.backgroundImage = `url(${img.src})`;
        magnifier.style.backgroundSize = `${imgNaturalW * zoom}px ${imgNaturalH * zoom}px`;
      }

      if (img.complete) refreshNatural();
      img.addEventListener('load', refreshNatural);

      // Movimientos del ratón para actualizar pos del lente
      function onMove(e) {
        const rect = img.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        if (x < 0 || y < 0 || x > rect.width || y > rect.height) {
          magnifier.style.display = 'none';
          return;
        }
        magnifier.style.display = '';
        const magW = magnifier.offsetWidth;
        const magH = magnifier.offsetHeight;
        const percentX = x / rect.width;
        const percentY = y / rect.height;

        // posicion del magnifier dentro del wrapper (mantener centrado en cursor)
        const left = Math.max(0, Math.min(rect.width - magW, x - magW / 2));
        const top = Math.max(0, Math.min(rect.height - magH, y - magH / 2));
        magnifier.style.left = left + 'px';
        magnifier.style.top = top + 'px';

        // background-position calculado sobre la imagen natural y el factor zoom
        const bgX = Math.round((imgNaturalW * percentX * zoom) - magW / 2);
        const bgY = Math.round((imgNaturalH * percentY * zoom) - magH / 2);
        magnifier.style.backgroundPosition = `-${bgX}px -${bgY}px`;
      }

      // Mostrar lente al mover y ocultar cuando sale
      wrapper.addEventListener('mouseenter', function(e) {
        magnifier.style.display = '';
      });
      wrapper.addEventListener('mousemove', onMove);
      wrapper.addEventListener('touchmove', onMove, { passive: true });
      wrapper.addEventListener('mouseleave', function() { magnifier.style.display = 'none'; });

      // Clic abre modal con zoom y drag
      wrapper.addEventListener('click', function() {
        const modalEl = document.getElementById('zoomModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      });

      // Modal: manejo zoom con rueda y arrastre
      (function setupModalZoom() {
        const modalImg = document.getElementById('zoom-modal-image');
        let scale = 1;
        let originX = 0, originY = 0;
        let isPanning = false;
        let startX = 0, startY = 0;
        let translateX = 0, translateY = 0;

        function applyTransform() {
          modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }

        modalImg.addEventListener('wheel', function(e) {
          e.preventDefault();
          const delta = -e.deltaY;
          const factor = delta > 0 ? 1.08 : 0.92;
          const prevScale = scale;
          scale = Math.min(6, Math.max(1, scale * factor));

          // ajustar translate para zoom relativo al cursor
          const rect = modalImg.getBoundingClientRect();
          const cx = e.clientX - rect.left;
          const cy = e.clientY - rect.top;
          // calcular cambio en escala y ajustar translate
          translateX -= (cx - translateX) * (scale / prevScale - 1);
          translateY -= (cy - translateY) * (scale / prevScale - 1);
          applyTransform();
        }, { passive: false });

        modalImg.addEventListener('pointerdown', function(e) {
          if (scale <= 1) return;
          isPanning = true;
          startX = e.clientX;
          startY = e.clientY;
          modalImg.style.cursor = 'grabbing';
          modalImg.setPointerCapture(e.pointerId);
        });

        modalImg.addEventListener('pointermove', function(e) {
          if (!isPanning) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          startX = e.clientX; startY = e.clientY;
          translateX += dx;
          translateY += dy;
          applyTransform();
        });

        modalImg.addEventListener('pointerup', function(e) {
          isPanning = false;
          modalImg.style.cursor = 'grab';
          try { modalImg.releasePointerCapture(e.pointerId); } catch (err) {}
        });

        // Reset transform when modal hides
        const modalEl = document.getElementById('zoomModal');
        modalEl.addEventListener('hidden.bs.modal', function() {
          scale = 1; translateX = 0; translateY = 0; applyTransform();
        });
      })();
    }
  });
  </script>
  {% endblock %}

--- Archivo: ./templates/errors/403.html ---
{% extends 'base.html' %}

{% block title %}Error 403 - Acceso denegado{% endblock %}

{% block content %}
<div class="container text-center my-5">
	<h1 class="display-4">403 — Acceso denegado</h1>
	<p class="lead">No tienes permisos para ver este recurso.</p>
	<p>Si crees que deberías tener acceso, inicia sesión con una cuenta autorizada o contacta al administrador.</p>

	<a href="{{ url_for('login') }}" class="btn btn-primary mt-3"><i class="fas fa-sign-in-alt"></i> Iniciar sesión</a>
	<a href="{{ url_for('home') }}" class="btn btn-outline-secondary mt-3 ms-2">Ir al inicio</a>

	<hr class="my-4">
	<p class="text-muted">Contacto: <a href="mailto:admin@axionstore.com">admin@axionstore.com</a></p>
</div>
{% endblock %}


--- Archivo: ./templates/errors/500.html ---
{% extends 'base.html' %}

{% block title %}Error 500 - Error interno{% endblock %}

{% block content %}
<div class="container text-center my-5">
	<h1 class="display-4">500 — Error interno del servidor</h1>
	<p class="lead">Lo sentimos, algo salió mal en el servidor.</p>
	<p>Estamos trabajando para resolverlo. Por favor intenta más tarde.</p>

	<a href="{{ url_for('home') }}" class="btn btn-primary mt-3"><i class="fas fa-home"></i> Ir al inicio</a>
	<a href="javascript:location.reload()" class="btn btn-outline-secondary mt-3 ms-2">Reintentar</a>

	<hr class="my-4">
	<p class="text-muted">Si este error persiste, envía los detalles al equipo técnico: <a href="mailto:support@axionstore.com">support@axionstore.com</a></p>
</div>
{% endblock %}


--- Archivo: ./templates/errors/404.html ---
{% extends 'base.html' %}

{% block title %}Error 404 - Página no encontrada{% endblock %}

{% block content %}
<div class="container text-center my-5">
	<h1 class="display-4">404 — Página no encontrada</h1>
	<p class="lead">Lo sentimos, no hemos podido encontrar la página que buscabas.</p>
	<p>Es posible que la URL sea incorrecta o que la página haya sido movida o eliminada.</p>

	<a href="{{ url_for('home') }}" class="btn btn-primary mt-3"><i class="fas fa-home"></i> Ir al inicio</a>
	<a href="{{ url_for('index') }}" class="btn btn-outline-secondary mt-3 ms-2">Volver a la portada</a>

	<hr class="my-4">
	<p class="text-muted">Si crees que esto es un error, por favor contáctanos: <a href="mailto:support@axionstore.com">support@axionstore.com</a></p>
</div>
{% endblock %}


--- Archivo: ./templates/errors/400.html ---
{% extends 'base.html' %}

{% block title %}Error 400 - Solicitud incorrecta{% endblock %}

{% block content %}
<div class="container text-center my-5">
	<h1 class="display-4">400 — Solicitud incorrecta</h1>
	<p class="lead">La petición que realizaste no pudo ser procesada.</p>
	<p>Verifica los datos enviados o intenta nuevamente más tarde.</p>

	<a href="{{ url_for('home') }}" class="btn btn-primary mt-3"><i class="fas fa-home"></i> Volver al inicio</a>
	<a href="javascript:history.back()" class="btn btn-outline-secondary mt-3 ms-2">Volver</a>

	<hr class="my-4">
	<p class="text-muted">Si el problema persiste, contacta soporte: <a href="mailto:support@axionstore.com">support@axionstore.com</a></p>
</div>
{% endblock %}


--- Archivo: ./templates/base.html ---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Axion Store{% endblock %}</title>
    
    <!-- ✅ PREVENIR FLASH DE TEMA - Debe ir ANTES del CSS -->
    <script>
        (function() {
            var theme = localStorage.getItem('axion-theme');
            function applyDark() {
                document.documentElement.classList.add('dark-mode');
                document.documentElement.style.backgroundColor = '#0F1217';
            }
            function applyLight() {
                document.documentElement.classList.remove('dark-mode');
                document.documentElement.style.backgroundColor = '';
            }

            if (theme === 'dark') {
                applyDark();
            } else if (theme === 'light') {
                applyLight();
            } else if (theme === 'system') {
                // seguir preferencia del sistema
                var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) applyDark(); else applyLight();
            }
        })();
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='Marca/logo.png') }}" alt="Axion Store" class="navbar-logo">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('home') }}">
                            <i class="fas fa-home"></i> Inicio
                        </a>
                    </li>
                    
                    {% if session.get('user_id') %}
                        
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('historial') }}">
                                <i class="fas fa-history"></i> Mis Pedidos
                            </a>
                        </li>
                        
                        {% if session.get('is_admin') %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                                <i class="fas fa-cog"></i> Panel Admin
                            </a>
                        </li>
                        {% endif %}

                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user"></i> {{ session['user_name'] }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{{ url_for('perfil') }}"><i class="fas fa-user"></i>Mi Perfil</a></li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('wishlist') }}">
                                        <i class="fas fa-heart"></i>Mi Lista de Deseos
                                        {% if wishlist_count and wishlist_count > 0 %}
                                        <span class="badge bg-danger">{{ wishlist_count }}</span>
                                        {% endif %}
                                    </a>
                                </li>
                                <li><a class="dropdown-item" href="{{ url_for('wallet') }}"><i class="fas fa-wallet"></i>Mi Wallet</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('historial') }}"><i class="fas fa-history"></i>Mis Pedidos</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i>Cerrar Sesión</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">
                                <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('register') }}">
                                <i class="fas fa-user-plus"></i> Registrarse
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
            
            <!-- Icono carrito (siempre visible) -->
            <a id="cart-button" href="{{ url_for('cart') }}" class="btn btn-outline-light ms-3 position-relative" title="Ver carrito">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size:0.65rem; {% if not (cart_count and cart_count>0) %}display:none;{% endif %}">
                    {{ cart_count or 0 }}
                </span>
            </a>
        </div>
    </nav>

    <!-- Mensajes Flash -->
    <div class="container mt-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Contenido Principal -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="text-center">
        <div class="container">
            <p class="mb-0">&copy; 2025 Axion Store. Dando lo mejor a nuestros clientes.</p>
            <p class="mb-0"><small>Desarrollado con Flask & Bootstrap</small></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/password-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cart-inline.js') }}"></script>
    <script src="{{ url_for('static', filename='js/skeletons.js') }}"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Auto-cerrar alertas (más rápido)
        const alerts = document.querySelectorAll('.alert');
        if (alerts && alerts.length > 0) {
            setTimeout(function () {
                alerts.forEach(function (el) {
                    try {
                        var bsAlert = bootstrap.Alert.getOrCreateInstance(el);
                        bsAlert.close();
                    } catch (e) {
                        el.classList.remove('show');
                        el.style.display = 'none';
                    }
                });
            }, 3000);
        }

        // Theme control: expose a global setter `setAxionTheme(theme)` where theme is 'light'|'dark'|'system'
        window.setAxionTheme = function(theme) {
            try {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('axion-theme', 'dark');
                } else if (theme === 'light') {
                    document.documentElement.classList.remove('dark-mode');
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('axion-theme', 'light');
                } else if (theme === 'system') {
                    // seguir preferencia de sistema
                    localStorage.setItem('axion-theme', 'system');
                    var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.documentElement.classList.add('dark-mode');
                        document.body.classList.add('dark-mode');
                    } else {
                        document.documentElement.classList.remove('dark-mode');
                        document.body.classList.remove('dark-mode');
                    }
                }
            } catch (e) {
                console.error('Error aplicando tema', e);
            }
        };

        // Escuchar cambios en la preferencia del sistema para modo 'system'
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                var t = localStorage.getItem('axion-theme');
                if (t === 'system') {
                    if (e.matches) {
                        document.documentElement.classList.add('dark-mode');
                        document.body.classList.add('dark-mode');
                    } else {
                        document.documentElement.classList.remove('dark-mode');
                        document.body.classList.remove('dark-mode');
                    }
                }
            });
        }
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>

--- Archivo: ./templates/wishlist.html ---
{% extends "base.html" %}

{% block title %}Mi Lista de Deseos - Axion Store{% endblock %}

{% block content %}
<div class="container my-5 wishlist">
    <h1 class="mb-4">
        <i class="fas fa-heart text-danger"></i> Mi Lista de Deseos
    </h1>
    
    {% if productos %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
        {% for producto in productos %}
        <div class="col">
            <div class="card card-custom h-100 border-0 product-card">
                <div class="text-center p-4 product-image-container wishlist-image">
                    {% if producto.imagen %}
                        <a href="{{ url_for('product_detail', producto_id=producto.ID_Producto) }}">
                            <img src="{{ url_for('static', filename=producto.imagen) }}" 
                                 class="img-fluid product-image" 
                                 alt="{{ producto.nombre }}"
                                 loading="lazy"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=Sin+Imagen'">
                        </a>
                    {% else %}
                        <a href="{{ url_for('product_detail', producto_id=producto.ID_Producto) }}">
                            <i class="fas fa-image fa-5x text-muted product-placeholder"></i>
                        </a>
                    {% endif %}
                    
                    {% if not producto.disponible or producto.stock <= 0 %}
                        <div class="position-absolute top-0 start-0 m-2">
                            <span class="badge bg-danger">AGOTADO</span>
                        </div>
                    {% endif %}
                </div>
                
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold">
                        <a href="{{ url_for('product_detail', producto_id=producto.ID_Producto) }}" 
                           class="text-decoration-none text-reset">
                            {{ producto.nombre }}
                        </a>
                    </h5>
                    
                    <div class="mt-auto">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="fs-4 fw-bold price">
                                ${{ "%.2f"|format(producto.precio) }}
                            </span>
                            
                            {% if producto.disponible and producto.stock > 0 %}
                                <span class="badge bg-success">Disponible</span>
                            {% else %}
                                <span class="badge bg-danger">Agotado</span>
                            {% endif %}
                        </div>
                        
                        <small class="text-muted d-block mb-3">
                            <i class="fas fa-clock"></i> Agregado: {{ producto.fecha_agregado.strftime('%d/%m/%Y') }}
                        </small>
                        
                        <div class="d-flex gap-2">
                            {% if producto.disponible and producto.stock > 0 %}
                                <a href="{{ url_for('wishlist_to_cart', producto_id=producto.ID_Producto) }}" 
                                   class="btn btn-primary flex-grow-1">
                                    <i class="fas fa-cart-plus"></i> Al Carrito
                                </a>
                            {% else %}
                                <button class="btn btn-secondary flex-grow-1" disabled>
                                    <i class="fas fa-ban"></i> No Disponible
                                </button>
                            {% endif %}
                            
                            <a href="{{ url_for('remove_from_wishlist', producto_id=producto.ID_Producto) }}" 
                               class="btn btn-outline-danger" 
                               title="Eliminar de la lista">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-heart-broken fa-5x text-muted mb-4"></i>
        <h3 class="text-muted mb-3">Tu lista de deseos está vacía</h3>
        <p class="mb-4">Explora nuestros productos y agrega tus favoritos</p>
        <a href="{{ url_for('home') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-shopping-bag"></i> Explorar Productos
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Fondo negro para imágenes en wishlist */
    .wishlist-image,
    .wishlist .product-image-container {
        background: #f8f9fa;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .dark-mode .wishlist-image,
    .dark-mode .wishlist .product-image-container {
        background: #000000 !important;
    }
    
    .dark-mode .wishlist .product-placeholder {
        color: #333 !important;
    }
</style>
{% endblock %}

--- Archivo: ./templates/login.html ---

{% extends "base.html" %}

{% block title %}Axion Store - Iniciar Sesión{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center align-items-center" style="min-height: 70vh;">
        <div class="col-md-5">
            <div class="card card-custom shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-circle fa-4x" style="color: var(--primary);"></i>
                        <h2 class="mt-3 fw-bold">Iniciar Sesión</h2>
                        <p class="text-muted">Accede a tu cuenta de Axion Store</p>
                    </div>
                    
                    <form method="POST" action="{{ url_for('login') }}">
                        <div class="mb-3">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope"></i> Correo Electrónico
                            </label>
                            <input type="email" 
                                   class="form-control form-control-lg" 
                                   id="email" 
                                   name="email" 
                                   placeholder="tu@email.com" 
                                   required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock"></i> Contraseña
                            </label>
                            <div class="password-wrapper">
                                <input type="password"
                                       class="form-control form-control-lg password-input"
                                       id="password"
                                       name="password"
                                       placeholder="••••••••"
                                       required>
                                <button type="button" class="password-toggle" aria-pressed="false" aria-label="Mostrar contraseña" title="Mostrar contraseña">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="remember">
                            <label class="form-check-label" for="remember">
                                Recordarme
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary-custom btn-lg w-100 mb-3">
                            <i class="fas fa-sign-in-alt"></i> Entrar
                        </button>
                        
                        <div class="text-center">
                            <a href="#" class="text-decoration-none">¿Olvidaste tu contraseña?</a>
                        </div>
                    </form>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <p class="mb-0">¿No tienes cuenta? 
                            <a href="{{ url_for('register') }}" class="fw-bold text-decoration-none" style="color: var(--primary);">
                                Regístrate aquí
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
--- Archivo: ./templates/admin/dashboard.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Panel de Administración{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-4 fw-bold">
            <i class="fas fa-tachometer-alt"></i> Panel de Administración
        </h1>
        <span class="badge bg-primary fs-6">Administrador</span>
    </div>

    <!-- Tarjetas de Estadísticas Principales -->
    <div class="row mb-4">
        <div class="col-md-3 mb-4">
            <div class="card card-custom border-0 text-center h-100 stat-card">
                <div class="card-body">
                    <i class="fas fa-users fa-3x mb-3 stat-icon"></i>
                    <h3 class="fw-bold stat-number">{{ total_usuarios }}</h3>
                    <p class="mb-0 stat-label">Usuarios Registrados</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card card-custom border-0 text-center h-100 stat-card">
                <div class="card-body">
                    <i class="fas fa-box fa-3x mb-3 stat-icon"></i>
                    <h3 class="fw-bold stat-number">{{ total_productos }}</h3>
                    <p class="mb-0 stat-label">Productos</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card card-custom border-0 text-center h-100 stat-card">
                <div class="card-body">
                    <i class="fas fa-shopping-bag fa-3x mb-3 stat-icon"></i>
                    <h3 class="fw-bold stat-number">{{ total_pedidos }}</h3>
                    <p class="mb-0 stat-label">Pedidos Totales</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card card-custom border-0 text-center h-100 stat-card">
                <div class="card-body">
                    <i class="fas fa-dollar-sign fa-3x mb-3 stat-icon"></i>
                    <h3 class="fw-bold stat-number">${{ "%.2f"|format(total_ventas) }}</h3>
                    <p class="mb-0 stat-label">Ventas Totales</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ NUEVA GRÁFICA COMPARATIVA -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-custom border-0">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-area"></i> Análisis Comparativo de Comportamiento
                    </h5>

                    <!-- Métricas rápidas -->
                    <div class="row text-center mb-4">
                        <div class="col-md-4">
                            <div class="p-3 border rounded">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h4 class="fw-bold">{{ total_productos_vendidos }}</h4>
                                <small class="text-muted">Productos Vendidos</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded">
                                <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                                <h4 class="fw-bold">{{ total_abandonos }}</h4>
                                <small class="text-muted">Productos Abandonados</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded">
                                <i class="fas fa-shopping-cart fa-2x text-warning mb-2"></i>
                                <h4 class="fw-bold">{{ productos_en_carritos }}</h4>
                                <small class="text-muted">En Carritos Activos</small>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfica de líneas -->
                    <div style="height: 350px;">
                        <canvas id="comparativaChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Acciones Rápidas -->
        <div class="col-md-6 mb-4">
            <div class="card card-custom border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-bolt"></i> Acciones Rápidas
                    </h5>
                    <div class="d-grid gap-3">
                        <a href="{{ url_for('admin_analytics') }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-chart-line"></i> Panel de Analytics Completo
                        </a>
                        <a href="{{ url_for('admin_productos') }}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-box"></i> Gestionar Productos
                        </a>
                        <a href="{{ url_for('admin_categorias') }}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-tags"></i> Gestionar Categorías
                        </a>
                        <a href="{{ url_for('admin_usuarios') }}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-users"></i> Gestionar Usuarios
                        </a>
                        <a href="{{ url_for('admin_pedidos') }}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-shopping-bag"></i> Ver Pedidos
                        </a>
                        <a href="{{ url_for('admin_agregar_producto') }}" class="btn btn-success btn-lg">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pedidos Recientes -->
        <div class="col-md-6 mb-4">
            <div class="card card-custom border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-history"></i> Pedidos Recientes
                    </h5>

                    {% if pedidos_recientes %}
                        {% for pedido in pedidos_recientes %}
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 pedido-item">
                            <div>
                                <h6 class="mb-1">Pedido #{{ pedido.ID_Pedido }}</h6>
                                <small class="text-muted">
                                    {{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            </div>
                            <div class="text-end">
                                <strong>${{ "%.2f"|format(pedido.total) }}</strong>
                                <br>
                                <span class="badge bg-success">{{ pedido.estado }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">No hay pedidos recientes</p>
                    {% endif %}

                    <a href="{{ url_for('admin_pedidos') }}" class="btn btn-outline-secondary w-100 mt-3">
                        Ver Todos los Pedidos
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas Rápidas de Categorías -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card card-custom border-0">
                <div class="card-header category-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Resumen de Categorías
                    </h5>
                    <a href="{{ url_for('admin_analytics') }}" class="btn btn-sm btn-outline-light">
                        Ver Detalles <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 category-table">
                            <thead>
                                <tr>
                                    <th>Categoría</th>
                                    <th class="text-center">Productos</th>
                                    <th class="text-center">Vendidos</th>
                                    <th class="text-end">Ingresos</th>
                                    <th class="text-center">Conversión</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for categoria in categorias_metricas %}
                                <tr>
                                    <td>
                                        <i class="{{ categoria.icono or 'fas fa-box' }}"></i>
                                        {{ categoria.nombre }}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">{{ categoria.productos_activos or 0 }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ categoria.total_vendidos or 0 }}</span>
                                    </td>
                                    <td class="text-end">
                                        <strong>${{ "%.2f"|format(categoria.ingresos or 0) }}</strong>
                                    </td>
                                    <td class="text-center">
                                        {% if categoria.tasa_conversion %}
                                            {% if categoria.tasa_conversion >= 50 %}
                                            <span class="badge bg-success">{{ "%.1f"|format(categoria.tasa_conversion) }}%</span>
                                            {% elif categoria.tasa_conversion >= 20 %}
                                            <span class="badge bg-warning text-dark">{{ "%.1f"|format(categoria.tasa_conversion) }}%</span>
                                            {% else %}
                                            <span class="badge bg-danger">{{ "%.1f"|format(categoria.tasa_conversion) }}%</span>
                                            {% endif %}
                                        {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        No hay datos de categorías disponibles
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="text-center p-3">
                        <a href="{{ url_for('admin_actualizar_metricas_categorias') }}" class="btn btn-outline-primary">
                            <i class="fas fa-sync"></i> Actualizar Métricas
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exportar Datos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card card-custom border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-download"></i> Exportar Datos
                    </h5>
                    <div class="d-flex gap-3 flex-wrap align-items-center">
                        <a href="{{ url_for('exportar_usuarios_csv') }}" class="btn btn-outline-success">
                            <i class="fas fa-file-csv"></i> Exportar Usuarios (CSV)
                        </a>
                        <a href="{{ url_for('exportar_productos_csv') }}" class="btn btn-outline-success">
                            <i class="fas fa-file-csv"></i> Exportar Productos (CSV)
                        </a>

                        <form class="d-flex align-items-center" method="GET" action="{{ url_for('exportar_ventas_csv') }}">
                            <label class="me-2 mb-0 small text-muted">Desde</label>
                            <input type="date" name="desde" class="form-control form-control-sm me-2" />
                            <label class="me-2 mb-0 small text-muted">Hasta</label>
                            <input type="date" name="hasta" class="form-control form-control-sm me-2" />
                            <button class="btn btn-outline-success me-2" type="submit"><i class="fas fa-file-csv"></i> Detallado</button>
                        </form>

                        <form class="d-flex align-items-center" method="GET" action="{{ url_for('exportar_ventas_simple_csv') }}">
                            <label class="me-2 mb-0 small text-muted">Desde</label>
                            <input type="date" name="desde" class="form-control form-control-sm me-2" />
                            <label class="me-2 mb-0 small text-muted">Hasta</label>
                            <input type="date" name="hasta" class="form-control form-control-sm me-2" />
                            <button class="btn btn-outline-success me-2" type="submit"><i class="fas fa-file-csv"></i> Simple</button>
                        </form>

                        <div class="btn-group" role="group">
                            <a href="{{ url_for('exportar_ventas_csv') }}?desde={{ last7 }}&hasta={{ now }}" class="btn btn-sm btn-secondary">Detallado 7d</a>
                            <a href="{{ url_for('exportar_ventas_simple_csv') }}?desde={{ last7 }}&hasta={{ now }}" class="btn btn-sm btn-outline-secondary">Simple 7d</a>
                            <a href="{{ url_for('exportar_ventas_csv') }}?desde={{ last30 }}&hasta={{ now }}" class="btn btn-sm btn-secondary">Detallado 30d</a>
                            <a href="{{ url_for('exportar_ventas_simple_csv') }}?desde={{ last30 }}&hasta={{ now }}" class="btn btn-sm btn-outline-secondary">Simple 30d</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ✅ NUEVA GRÁFICA COMPARATIVA
    const ctx = document.getElementById('comparativaChart');
    if (ctx) {
        // Preparar datos de ventas
        const ventasDatos = [
            {% for venta in ventas_diarias %}
            { fecha: '{{ venta.fecha }}', valor: {{ venta.vendidos }} },
            {% endfor %}
        ];

        // Preparar datos de abandonos
        const abandonosDatos = [
            {% for abandono in abandonos_diarios %}
            { fecha: '{{ abandono.fecha }}', valor: {{ abandono.abandonados }} },
            {% endfor %}
        ];

        // Generar array completo de fechas (últimos 30 días)
        const fechas = [];
        const hoy = new Date();
        for (let i = 29; i >= 0; i--) {
            const fecha = new Date(hoy);
            fecha.setDate(fecha.getDate() - i);
            fechas.push(fecha.toISOString().split('T')[0]);
        }

        // Mapear datos a las fechas
        const ventasMap = new Map(ventasDatos.map(d => [d.fecha, d.valor]));
        const abandonosMap = new Map(abandonosDatos.map(d => [d.fecha, d.valor]));

        const ventasArray = fechas.map(f => ventasMap.get(f) || 0);
        const abandonosArray = fechas.map(f => abandonosMap.get(f) || 0);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: fechas.map(f => {
                    const d = new Date(f);
                    return d.getDate() + '/' + (d.getMonth() + 1);
                }),
                datasets: [
                    {
                        label: 'Productos Vendidos',
                        data: ventasArray,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Productos Abandonados',
                        data: abandonosArray,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'En Carritos Activos',
                        data: Array(30).fill({{ productos_en_carritos }}),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        borderDash: [5, 5],
                        tension: 0,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-icon {
        color: var(--color-primary);
    }
    .stat-number {
        color: var(--color-text);
    }
    .stat-label {
        color: var(--color-text-sec);
    }

    .pedido-item {
        background: var(--color-bg);
        border-radius: 8px;
        border: 1px solid var(--color-border);
    }

    .category-header {
        background: var(--color-primary);
        color: #fff;
    }

    .category-table th {
        background: transparent;
        border-bottom: 2px solid var(--color-border);
    }

    .dark-mode .stat-icon {
        color: var(--color-accent) !important;
    }

    .dark-mode .pedido-item {
        background: rgba(255,255,255,0.03);
        border-color: var(--color-border);
    }

    .dark-mode .category-header {
        background: #1A1F27;
    }
</style>
{% endblock %}

--- Archivo: ./templates/admin/editar_subcategoria.html ---
{% extends 'base.html' %}
{% block title %}Editar Subcategoría - Admin{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit"></i> Editar Subcategoría
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary">
                        <strong>Editando:</strong> {{ subcategoria.nombre }}
                        <span class="badge bg-dark">ID: {{ subcategoria.ID_Subcategoria }}</span>
                        <br>
                        <small>
                            <strong>Categoría actual:</strong> 
                            <i class="{{ subcategoria.categoria.icono }}"></i> 
                            {{ subcategoria.categoria.nombre }}
                        </small>
                    </div>

                    <form method="POST">
                        
                        <div class="mb-3">
                            <label class="form-label">Categoría Principal *</label>
                            <select name="ID_Categoria" class="form-select form-select-lg" required>
                                {% for cat in categorias %}
                                <option value="{{ cat.ID_Categoria }}"
                                        {% if cat.ID_Categoria == subcategoria.ID_Categoria %}selected{% endif %}>
                                    [ID: {{ cat.ID_Categoria }}] {{ cat.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre de la Subcategoría *</label>
                            <input type="text" 
                                   name="nombre" 
                                   class="form-control" 
                                   value="{{ subcategoria.nombre }}"
                                   required
                                   maxlength="100">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea name="descripcion" 
                                      class="form-control" 
                                      rows="3">{{ subcategoria.descripcion or '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Orden</label>
                            <input type="number" 
                                   name="orden" 
                                   class="form-control" 
                                   value="{{ subcategoria.orden }}"
                                   min="0">
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="activa" 
                                   id="activa" 
                                   {% if subcategoria.activa %}checked{% endif %}>
                            <label class="form-check-label" for="activa">
                                <strong>Subcategoría activa</strong>
                            </label>
                        </div>

                        <hr>

                        <div class="alert alert-info">
                            <strong>Productos en esta subcategoría:</strong> 
                            <span class="badge bg-primary">{{ subcategoria.productos|length }}</span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                            <a href="{{ url_for('admin_categorias') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Productos asociados -->
            {% if subcategoria.productos %}
            <div class="card shadow mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-box"></i> 
                        Productos en esta subcategoría ({{ subcategoria.productos|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for producto in subcategoria.productos[:10] %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                {% if producto.imagen %}
                                <img src="{{ url_for('static', filename=producto.imagen) }}" 
                                     class="me-2" 
                                     style="width: 40px; height: 40px; object-fit: cover;"
                                     onerror="this.style.display='none'">
                                {% endif %}
                                <div>
                                    <small><strong>{{ producto.nombre }}</strong></small>
                                    <br>
                                    <small class="text-muted">${{ "%.2f"|format(producto.precio) }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if subcategoria.productos|length > 10 %}
                    <small class="text-muted">
                        ... y {{ subcategoria.productos|length - 10 }} más
                    </small>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

--- Archivo: ./templates/admin/usuarios.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Gestión de Usuarios{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-4 fw-bold">
            <i class="fas fa-users"></i> Gestión de Usuarios
        </h1>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Panel
        </a>
    </div>

    <div class="card card-custom border-0">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Fecha Registro</th>
                            <th>Rol</th>
                            <th>Saldo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usuario in usuarios %}
                        <tr>
                            <td>{{ usuario.ID_Users }}</td>
                            <td>{{ usuario.nombre }}</td>
                            <td>{{ usuario.email }}</td>
                            <td>{{ usuario.fecha_registro.strftime('%d/%m/%Y') if usuario.fecha_registro else 'N/A' }}</td>
                            <td>
                                {% if usuario.es_admin %}
                                    <span class="badge bg-danger">Admin</span>
                                {% else %}
                                    <span class="badge bg-primary">Usuario</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if usuario.wallet %}
                                    <strong class="text-success">${{ "%.2f"|format(usuario.wallet.saldo) }}</strong>
                                {% else %}
                                    <span class="text-muted">Sin wallet</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('admin_usuario_metricas', usuario_id=usuario.ID_Users) }}"
                                       class="btn btn-sm btn-outline-info" title="Ver métricas detalladas">
                                        <i class="fas fa-chart-bar"></i> Métricas
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal" data-bs-target="#modalRecarga{{ usuario.ID_Users }}">
                                        <i class="fas fa-coins"></i> Recargar
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modales de recarga (fuera de la tabla) -->
{% for usuario in usuarios %}
<div class="modal fade" id="modalRecarga{{ usuario.ID_Users }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Recargar Saldo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_agregar_saldo', usuario_id=usuario.ID_Users) }}">
                <div class="modal-body">
                    <p>Usuario: <strong>{{ usuario.nombre }}</strong></p>
                    <p>Saldo actual: <strong>${{ "%.2f"|format(usuario.wallet.saldo) if usuario.wallet else 0 }}</strong></p>
                    
                    <div class="mb-3">
                        <label for="monto{{ usuario.ID_Users }}" class="form-label">Monto a recargar:</label>
                        <input type="number" class="form-control" id="monto{{ usuario.ID_Users }}" 
                               name="monto" min="1" max="10000" step="0.01" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary-custom">Recargar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

--- Archivo: ./templates/admin/categorias.html ---
{% extends 'base.html' %}

{% block title %}Gestión de Categorías - Admin{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-tags"></i> Gestión de Categorías</h2>
        <div>
            <a href="{{ url_for('admin_agregar_categoria') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Nueva Categoría
            </a>
            <a href="{{ url_for('admin_agregar_subcategoria') }}" class="btn btn-info">
                <i class="fas fa-plus"></i> Nueva Subcategoría
            </a>
            <a href="{{ url_for('admin_categorias_referencia') }}" class="btn btn-secondary" target="_blank">
                <i class="fas fa-book"></i> Referencia
            </a>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    {% if categorias %}
        {% for categoria in categorias %}
        <div class="card mb-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center"
                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h4 class="mb-0">
                    <i class="{{ categoria.icono or 'fa-box' }}"></i> 
                    {{ categoria.nombre }}
                    <span class="badge bg-light text-dark ms-2">ID: {{ categoria.ID_Categoria }}</span>
                    {% if not categoria.activa %}
                        <span class="badge bg-warning text-dark">Inactiva</span>
                    {% endif %}
                </h4>
                <div>
                    <a href="{{ url_for('admin_editar_categoria', categoria_id=categoria.ID_Categoria) }}" 
                       class="btn btn-sm btn-light">
                        <i class="fas fa-edit"></i> Editar
                    </a>
                    <a href="{{ url_for('admin_eliminar_categoria', categoria_id=categoria.ID_Categoria) }}" 
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('¿Seguro que deseas eliminar esta categoría?\n\nNOTA: Solo se puede eliminar si no tiene productos asociados.')">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if categoria.descripcion %}
                <p class="text-muted mb-3">
                    <i class="fas fa-info-circle"></i> {{ categoria.descripcion }}
                </p>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="alert alert-info mb-0">
                            <strong>Total Productos:</strong> 
                            <span class="badge bg-primary">{{ categoria.productos|length }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-secondary mb-0">
                            <strong>Subcategorías:</strong> 
                            <span class="badge bg-dark">{{ categoria.subcategorias|length }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-success mb-0">
                            <strong>Orden:</strong> 
                            <span class="badge bg-success">{{ categoria.orden }}</span>
                        </div>
                    </div>
                </div>
                
                <h5 class="mt-4 mb-3">
                    <i class="fas fa-list"></i> Subcategorías 
                    <small class="text-muted">({{ categoria.subcategorias|length }})</small>
                </h5>
                
                {% if categoria.subcategorias %}
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="80" class="text-center">ID</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th width="100" class="text-center">Productos</th>
                                <th width="80" class="text-center">Orden</th>
                                <th width="100" class="text-center">Estado</th>
                                <th width="150" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in categoria.subcategorias|sort(attribute='orden') %}
                            <tr>
                                <td class="text-center">
                                    <strong class="badge bg-secondary">{{ sub.ID_Subcategoria }}</strong>
                                </td>
                                <td>
                                    <strong>{{ sub.nombre }}</strong>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ sub.descripcion or '-' }}
                                    </small>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ sub.productos|length }}</span>
                                </td>
                                <td class="text-center">{{ sub.orden }}</td>
                                <td class="text-center">
                                    {% if sub.activa %}
                                    <span class="badge bg-success">Activa</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inactiva</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{{ url_for('admin_editar_subcategoria', subcategoria_id=sub.ID_Subcategoria) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('admin_eliminar_subcategoria', subcategoria_id=sub.ID_Subcategoria) }}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('¿Eliminar la subcategoría \'{{ sub.nombre }}\'?')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    No hay subcategorías en esta categoría. 
                    <a href="{{ url_for('admin_agregar_subcategoria') }}" class="alert-link">Crear una ahora</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="alert alert-info text-center py-5">
        <i class="fas fa-info-circle fa-3x mb-3"></i>
        <h4>No hay categorías creadas</h4>
        <p>Comienza creando tu primera categoría para organizar tus productos.</p>
        <a href="{{ url_for('admin_agregar_categoria') }}" class="btn btn-success btn-lg mt-3">
            <i class="fas fa-plus"></i> Crear Primera Categoría
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

--- Archivo: ./templates/admin/analytics.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Analytics{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary);
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }

    .badge-segment {
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        margin: 5px;
    }

    .table-analytics {
        font-size: 0.9rem;
    }

    .product-img-small {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 5px;
    }

    .nav-tabs .nav-link {
        font-weight: 600;
    }

    .nav-tabs .nav-link.active {
        background: var(--color-primary) !important;
        color: #fff !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5 fw-bold">
            <i class="fas fa-chart-line"></i> Panel de Analytics Completo
        </h1>
        <div>
            <a href="{{ url_for('exportar_usuarios_csv') }}" class="btn btn-success me-2">
                <i class="fas fa-file-excel"></i> Exportar Usuarios
            </a>
            <a href="{{ url_for('exportar_productos_csv') }}" class="btn btn-success me-2">
                <i class="fas fa-file-excel"></i> Exportar Productos
            </a>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <!-- Métricas Principales -->
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card bg-white">
                <i class="fas fa-users fa-2x mb-2" style="color: #3b82f6;"></i>
                <div class="stat-value">{{ total_usuarios }}</div>
                <div class="stat-label">Total Usuarios</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-white">
                <i class="fas fa-shopping-bag fa-2x mb-2" style="color: #10b981;"></i>
                <div class="stat-value">{{ total_pedidos }}</div>
                <div class="stat-label">Total Pedidos</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-white">
                <i class="fas fa-dollar-sign fa-2x mb-2" style="color: #f59e0b;"></i>
                <div class="stat-value">${{ "%.2f"|format(total_ventas) }}</div>
                <div class="stat-label">Total Ventas</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-white">
                <i class="fas fa-receipt fa-2x mb-2" style="color: #8b5cf6;"></i>
                <div class="stat-value">${{ "%.2f"|format(ticket_promedio_global) }}</div>
                <div class="stat-label">Ticket Promedio</div>
            </div>
        </div>
    </div>

    <!-- ✅ TABS PARA ORGANIZAR EL CONTENIDO -->
    <ul class="nav nav-tabs mt-4" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#general">
                <i class="fas fa-chart-bar"></i> General
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#categorias">
                <i class="fas fa-tags"></i> Categorías
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#productos">
                <i class="fas fa-box"></i> Productos
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#clientes">
                <i class="fas fa-users"></i> Clientes
            </a>
        </li>
    </ul>

    <div class="tab-content mt-3">

        <!-- ===== TAB: GENERAL ===== -->
        <div id="general" class="tab-pane fade show active">

            <!-- Segmentación de Clientes -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-users-cog"></i> Segmentación de Clientes
                            </h5>
                            <div class="mt-3">
                                {% for segmento, cantidad in segmentacion.items() %}
                                <span class="badge badge-segment
                                    {% if segmento == 'activo' %}bg-success
                                    {% elif segmento == 'inactivo' %}bg-secondary
                                    {% else %}bg-primary{% endif %}">
                                    {{ segmento|capitalize }}: {{ cantidad }}
                                </span>
                                {% endfor %}
                            </div>

                            <div class="mt-4">
                                <canvas id="segmentacionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-wallet"></i> Métricas de Wallet
                            </h5>
                            <table class="table table-sm mt-3">
                                <tr>
                                    <td>Total Recargado:</td>
                                    <td class="fw-bold">${{ "%.2f"|format(total_recargado) }}</td>
                                </tr>
                                <tr>
                                    <td>Total Recargas:</td>
                                    <td class="fw-bold">{{ total_recargas }}</td>
                                </tr>
                                <tr>
                                    <td>Recarga Promedio:</td>
                                    <td class="fw-bold">${{ "%.2f"|format(recarga_promedio_global) }}</td>
                                </tr>
                                <tr>
                                    <td>Saldo Total Usuarios:</td>
                                    <td class="fw-bold text-success">${{ "%.2f"|format(saldo_total_usuarios) }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversión y Abandonos -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-chart-pie"></i> Análisis de Conversión
                            </h5>
                            <div class="row text-center mt-3">
                                <div class="col-md-4">
                                    <div class="stat-card bg-light">
                                        <div class="stat-value text-success">{{ "%.1f"|format(tasa_conversion_global) }}%</div>
                                        <div class="stat-label">Tasa de Conversión Global</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-card bg-light">
                                        <div class="stat-value text-warning">{{ total_abandonos }}</div>
                                        <div class="stat-label">Carritos Abandonados</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-card bg-light">
                                        <div class="stat-value text-danger">${{ "%.2f"|format(valor_abandonos) }}</div>
                                        <div class="stat-label">Valor Perdido en Abandonos</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ===== TAB: CATEGORÍAS ===== -->
        <div id="categorias" class="tab-pane fade">

            <!-- Categorías por Ingresos -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-chart-bar"></i> Ranking de Categorías por Ingresos
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover table-analytics">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Categoría</th>
                                            <th>Ingresos</th>
                                            <th>Vendidos</th>
                                            <th>Pedidos</th>
                                            <th>Conversión</th>
                                            <th>Abandonos</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cat in categorias_por_ingresos %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>
                                                <i class="{{ cat.icono or 'fas fa-box' }}"></i>
                                                {{ cat.nombre }}
                                            </td>
                                            <td class="fw-bold text-success">${{ "%.2f"|format(cat.ingresos_totales or 0) }}</td>
                                            <td><span class="badge bg-primary">{{ cat.total_productos_vendidos or 0 }}</span></td>
                                            <td>{{ cat.total_pedidos or 0 }}</td>
                                            <td>
                                                <span class="badge {% if cat.tasa_conversion >= 50 %}bg-success{% elif cat.tasa_conversion >= 20 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                    {{ "%.1f"|format(cat.tasa_conversion or 0) }}%
                                                </span>
                                            </td>
                                            <td class="text-danger">${{ "%.2f"|format(cat.valor_abandonos or 0) }}</td>
                                            <td>
                                                <a href="{{ url_for('admin_analytics_categoria_detalle', categoria_id=cat.ID_Categoria) }}" class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-eye"></i> Detalle
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribución de Ventas -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-chart-pie"></i> Distribución de Ventas por Categoría
                            </h5>
                            <canvas id="distribucionVentasChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-trophy"></i> Métricas Destacadas
                            </h5>

                            {% if mejor_conversion %}
                            <div class="alert alert-success">
                                <strong><i class="{{ mejor_conversion.icono }}"></i> Mejor Conversión:</strong><br>
                                {{ mejor_conversion.nombre }} - {{ "%.1f"|format(mejor_conversion.tasa_conversion) }}%
                                <br><small>{{ mejor_conversion.total_productos_vendidos }} vendidos de {{ mejor_conversion.total_agregados_carrito }} agregados</small>
                            </div>
                            {% endif %}

                            {% if mas_abandonos %}
                            <h6 class="mt-3">Top Abandonos:</h6>
                            <ul class="list-unstyled">
                                {% for cat in mas_abandonos %}
                                <li class="mb-2">
                                    <i class="{{ cat.icono }}"></i> {{ cat.nombre }}
                                    <span class="badge bg-danger float-end">${{ "%.2f"|format(cat.valor_abandonos) }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Productos por Categoría -->
            {% if productos_top_por_categoria %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-star"></i> Top Productos por Categoría
                            </h5>

                            {% for cat_nombre, productos in productos_top_por_categoria.items() %}
                            <h6 class="mt-3 mb-2">{{ cat_nombre }}</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Precio</th>
                                            <th>Vendidos</th>
                                            <th>Ingresos</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for prod in productos[:5] %}
                                        <tr>
                                            <td>
                                                {% if prod.imagen %}
                                                <img src="{{ url_for('static', filename=prod.imagen) }}" class="product-img-small me-2" onerror="this.style.display='none'">
                                                {% endif %}
                                                {{ prod.nombre }}
                                            </td>
                                            <td>${{ "%.2f"|format(prod.precio) }}</td>
                                            <td><span class="badge bg-primary">{{ prod.total_vendido }}</span></td>
                                            <td class="fw-bold text-success">${{ "%.2f"|format(prod.ingresos) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- ===== TAB: PRODUCTOS ===== -->
        <div id="productos" class="tab-pane fade">

            <div class="row mt-4">
                <!-- Productos más vendidos -->
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-trophy"></i> Top 10 Productos Más Vendidos
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover table-analytics">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Producto</th>
                                            <th>Vendidos</th>
                                            <th>Ingresos</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for producto in productos_mas_vendidos %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>
                                                {% if producto.imagen %}
                                                <img src="{{ url_for('static', filename=producto.imagen) }}" class="product-img-small me-2" onerror="this.style.display='none'">
                                                {% endif %}
                                                {{ producto.nombre[:30] }}...
                                            </td>
                                            <td><span class="badge bg-primary">{{ producto.total_vendido }}</span></td>
                                            <td class="fw-bold text-success">${{ "%.2f"|format(producto.ingresos) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Productos abandonados -->
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-shopping-cart"></i> Top 10 Productos Abandonados
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover table-analytics">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Producto</th>
                                            <th>Veces</th>
                                            <th>Valor Perdido</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for producto in productos_abandonados %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>{{ producto.nombre[:30] }}...</td>
                                            <td><span class="badge bg-warning text-dark">{{ producto.veces_agregado }}</span></td>
                                            <td class="fw-bold text-danger">${{ "%.2f"|format(producto.valor_perdido) }}</td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No hay datos</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos bajo stock -->
            {% if productos_bajo_stock %}
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card card-custom border-warning">
                        <div class="card-body">
                            <h5 class="card-title text-warning">
                                <i class="fas fa-exclamation-triangle"></i> Alerta: Productos con Bajo Stock
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Stock Actual</th>
                                            <th>Precio</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for producto in productos_bajo_stock %}
                                        <tr>
                                            <td>{{ producto.nombre }}</td>
                                            <td>
                                                <span class="badge {% if producto.stock <= 5 %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                                    {{ producto.stock }} unidades
                                                </span>
                                            </td>
                                            <td>${{ "%.2f"|format(producto.precio) }}</td>
                                            <td>
                                                <a href="{{ url_for('admin_editar_producto', producto_id=producto.ID_Producto) }}" class="btn btn-sm btn-warning">
                                                    <i class="fas fa-edit"></i> Reabastecer
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- ===== TAB: CLIENTES ===== -->
        <div id="clientes" class="tab-pane fade">

            <!-- Top Clientes -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-crown"></i> Top 10 Clientes
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Cliente</th>
                                            <th>Segmento</th>
                                            <th>Compras</th>
                                            <th>Total Gastado</th>
                                            <th>Ticket Promedio</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cliente in top_clientes %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>
                                                <strong>{{ cliente.nombre }}</strong><br>
                                                <small class="text-muted">{{ cliente.email }}</small>
                                            </td>
                                            <td>
                                                <span class="badge
                                                    {% if cliente.segmento_cliente == 'activo' %}bg-success
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ cliente.segmento_cliente|capitalize }}
                                                </span>
                                            </td>
                                            <td>{{ cliente.total_compras }}</td>
                                            <td class="fw-bold text-success">${{ "%.2f"|format(cliente.total_gastado) }}</td>
                                            <td>${{ "%.2f"|format(cliente.ticket_promedio) }}</td>
                                            <td>
                                                <a href="{{ url_for('admin_usuario_metricas', usuario_id=cliente.ID_Users) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-chart-bar"></i> Ver Métricas
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gráfico de Segmentación
const ctx = document.getElementById('segmentacionChart');
if (ctx) {
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for segmento in segmentacion.keys() %}
                '{{ segmento|capitalize }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for cantidad in segmentacion.values() %}
                    {{ cantidad }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: ['#3b82f6', '#10b981', '#6b7280']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Gráfico de Distribución de Ventas
const ctxDist = document.getElementById('distribucionVentasChart');
if (ctxDist) {
    new Chart(ctxDist, {
        type: 'pie',
        data: {
            labels: [
                {% for cat in distribucion_ventas %}
                '{{ cat.nombre }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for cat in distribucion_ventas %}
                    {{ cat.ingresos }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return label + ': $' + value.toFixed(2) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}

--- Archivo: ./templates/admin/agregar_subcategoria.html ---
{% extends 'base.html' %}
{% block title %}Nueva Subcategoría - Admin{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Crear Nueva Subcategoría
                    </h4>
                </div>
                <div class="card-body">
                    
                    {% if not categorias %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>No hay categorías disponibles.</strong>
                        Primero debes <a href="{{ url_for('admin_agregar_categoria') }}" class="alert-link">crear una categoría</a> antes de agregar subcategorías.
                    </div>
                    <a href="{{ url_for('admin_agregar_categoria') }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Crear Categoría
                    </a>
                    <a href="{{ url_for('admin_categorias') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                    {% else %}
                    
                    <form method="POST" action="{{ url_for('admin_agregar_subcategoria') }}">
                        
                        <div class="mb-3">
                            <label class="form-label">Categoría Principal *</label>
                            <select name="ID_Categoria" class="form-select form-select-lg" required>
                                <option value="">-- Seleccionar Categoría --</option>
                                {% for cat in categorias %}
                                <option value="{{ cat.ID_Categoria }}">
                                    <i class="{{ cat.icono }}"></i> [ID: {{ cat.ID_Categoria }}] {{ cat.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                La subcategoría pertenecerá a esta categoría
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre de la Subcategoría *</label>
                            <input type="text" 
                                   name="nombre" 
                                   class="form-control" 
                                   placeholder="Ej: Tarjetas Gráficas, Procesadores, Ratones"
                                   required
                                   maxlength="100">
                            <small class="text-muted">
                                Debe ser único dentro de la categoría
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea name="descripcion" 
                                      class="form-control" 
                                      rows="3"
                                      placeholder="Descripción breve de la subcategoría"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Orden de visualización</label>
                            <input type="number" 
                                   name="orden" 
                                   class="form-control" 
                                   value="0"
                                   min="0">
                            <small class="text-muted">
                                Orden dentro de su categoría (menor = aparece primero)
                            </small>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="activa" 
                                   id="activa" 
                                   checked>
                            <label class="form-check-label" for="activa">
                                <strong>Subcategoría activa</strong>
                            </label>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-info text-white btn-lg">
                                <i class="fas fa-save"></i> Crear Subcategoría
                            </button>
                            <a href="{{ url_for('admin_categorias') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>

                    {% endif %}
                </div>
            </div>

            <!-- Panel de referencia -->
            {% if categorias %}
            <div class="card shadow mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-book"></i> Categorías Disponibles
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for cat in categorias %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6>
                                        <i class="{{ cat.icono }}"></i> {{ cat.nombre }}
                                        <span class="badge bg-secondary">ID: {{ cat.ID_Categoria }}</span>
                                    </h6>
                                    <small class="text-muted">{{ cat.descripcion or 'Sin descripción' }}</small>
                                    <hr>
                                    <small>
                                        <strong>Subcategorías actuales:</strong> {{ cat.subcategorias|length }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

--- Archivo: ./templates/admin/editar_producto.html ---
{% extends 'base.html' %}
{% block title %}Editar Producto - Admin{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit"></i> Editar Producto
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary">
                        <strong>Editando:</strong> {{ producto.nombre }}
                        <span class="badge bg-dark">ID: {{ producto.ID_Producto }}</span>
                    </div>

                    <form method="POST" enctype="multipart/form-data">
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto *</label>
                            <input type="text" name="nombre" class="form-control" value="{{ producto.nombre }}" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Precio ($) *</label>
                                    <input type="number" step="0.01" name="precio" class="form-control" value="{{ producto.precio }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Stock *</label>
                                    <input type="number" name="stock" class="form-control" value="{{ producto.stock }}" required>
                                </div>
                            </div>
                        </div>

                        <!-- CATEGORÍAS -->
                        <div class="card mb-3 bg-light border">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-tags"></i> Categorización
                                    <a href="{{ url_for('admin_categorias_referencia') }}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-outline-info float-end">
                                        <i class="fas fa-book"></i> Ver Referencia
                                    </a>
                                </h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">Categoría Principal</label>
                                    <select name="ID_Categoria" id="selectCategoria" class="form-select" onchange="cargarSubcategorias()">
                                        <option value="">-- Sin categoría --</option>
                                        {% for cat in categorias %}
                                        <option value="{{ cat.ID_Categoria }}" 
                                                data-subcategorias='[{% for sub in cat.subcategorias %}{"ID_Subcategoria": {{ sub.ID_Subcategoria }}, "nombre": "{{ sub.nombre|e }}", "activa": {{ "true" if sub.activa else "false" }}}{% if not loop.last %},{% endif %}{% endfor %}]'
                                                {% if producto.ID_Categoria == cat.ID_Categoria %}selected{% endif %}>
                                            [ID: {{ cat.ID_Categoria }}] {{ cat.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Subcategoría</label>
                                    <select name="ID_Subcategoria" id="selectSubcategoria" class="form-select">
                                        <option value="">-- Sin subcategoría --</option>
                                    </select>
                                </div>

                                {% if producto.categoria or producto.subcategoria %}
                                <div class="alert alert-info">
                                    <strong>Categorización actual:</strong>
                                    {% if producto.categoria %}
                                        <i class="{{ producto.categoria.icono }}"></i> {{ producto.categoria.nombre }}
                                        {% if producto.subcategoria %}
                                            → {{ producto.subcategoria.nombre }}
                                        {% endif %}
                                    {% else %}
                                        Sin categoría
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- IMAGEN -->
                        <div class="mb-3">
                            <label class="form-label">Imagen del Producto</label>
                            
                            {% if producto.imagen %}
                            <div class="mb-2">
                                <img src="{{ url_for('static', filename=producto.imagen) }}" 
                                     class="img-thumbnail" 
                                     style="max-height: 150px;"
                                     onerror="this.src='{{ url_for('static', filename='img/no-image.png') }}'; this.onerror=null;">
                                <p class="small text-muted mb-0">Imagen actual</p>
                            </div>
                            {% endif %}
                            
                            <input type="file" name="imagen_file" class="form-control" accept="image/*" onchange="previewImagen(event)">
                            <small class="text-muted">Formatos: PNG, JPG, JPEG, GIF, WEBP (máx 2MB)</small>
                            
                            <div class="mt-2">
                                <small class="text-muted">O ingresa URL de imagen:</small>
                                <input type="text" name="imagen" class="form-control" 
                                       value="{{ producto.imagen or '' }}" 
                                       placeholder="https://ejemplo.com/imagen.jpg">
                            </div>
                            
                            <div id="imagePreview" class="mt-2"></div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="disponible" 
                                   id="disponible" {% if producto.disponible %}checked{% endif %}>
                            <label class="form-check-label" for="disponible">
                                <strong>Producto disponible para la venta</strong>
                            </label>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                            <a href="{{ url_for('admin_productos') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- PANEL DE INFORMACIÓN -->
        <div class="col-md-4">
            <div class="card shadow mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información</h5>
                </div>
                <div class="card-body">
                    <p><strong>ID Producto:</strong> {{ producto.ID_Producto }}</p>
                    <p><strong>Precio actual:</strong> ${{ "%.2f"|format(producto.precio) }}</p>
                    <p><strong>Stock actual:</strong> {{ producto.stock }}</p>
                    <p>
                        <strong>Estado:</strong> 
                        {% if producto.disponible %}
                        <span class="badge bg-success">Disponible</span>
                        {% else %}
                        <span class="badge bg-danger">No disponible</span>
                        {% endif %}
                    </p>
                    
                    <hr>
                    
                    <h6>Categorías Disponibles:</h6>
                    <ul class="list-unstyled small">
                        {% for cat in categorias %}
                        <li class="mb-2">
                            <i class="{{ cat.icono }}"></i> 
                            {{ cat.nombre }}
                            <span class="badge bg-secondary">{{ cat.ID_Categoria }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Consejo</h5>
                </div>
                <div class="card-body">
                    <small>
                        Si el stock es 0, considera marcar el producto como "No disponible" 
                        para que no aparezca en la tienda.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Precargar subcategorías al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    cargarSubcategorias();
    
    // Seleccionar subcategoría actual si existe
    const subcategoriaActual = {{ producto.ID_Subcategoria or 'null' }};
    if (subcategoriaActual) {
        setTimeout(() => {
            document.getElementById('selectSubcategoria').value = subcategoriaActual;
        }, 100);
    }
});

function cargarSubcategorias() {
    const selectCat = document.getElementById('selectCategoria');
    const selectSub = document.getElementById('selectSubcategoria');
    
    const selectedOption = selectCat.options[selectCat.selectedIndex];
    const categoriaId = selectCat.value;
    
    // Limpiar
    selectSub.innerHTML = '<option value="">-- Sin subcategoría --</option>';
    
    if (!categoriaId) {
        selectSub.disabled = true;
        return;
    }
    
    selectSub.disabled = false;
    
    try {
        const subcategorias = JSON.parse(selectedOption.dataset.subcategorias || '[]');
        
        subcategorias.forEach(sub => {
            if (sub.activa) {
                const option = document.createElement('option');
                option.value = sub.ID_Subcategoria;
                option.textContent = `[ID: ${sub.ID_Subcategoria}] ${sub.nombre}`;
                selectSub.appendChild(option);
            }
        });
    } catch (e) {
        console.error('Error:', e);
    }
}

function previewImagen(event) {
    const preview = document.getElementById('imagePreview');
    const file = event.target.files[0];
    
    if (file) {
        if (file.size > 2 * 1024 * 1024) {
            alert('La imagen es muy grande. Máximo 2MB.');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px;">`;
        }
        reader.readAsDataURL(file);
    }
}
</script>
{% endblock %}

--- Archivo: ./templates/admin/pedidos.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Gestión de Pedidos{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-4 fw-bold">
            <i class="fas fa-shopping-bag"></i> Gestión de Pedidos
        </h1>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Panel
        </a>
    </div>

    <div class="card card-custom border-0">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID Pedido</th>
                            <th>Usuario</th>
                            <th>Total</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr>
                            <td><strong>#{{ pedido.ID_Pedido }}</strong></td>
                            <td>
                                {% if pedido.usuario %}
                                    {{ pedido.usuario.nombre }}
                                    <br><small class="text-muted">{{ pedido.usuario.email }}</small>
                                {% else %}
                                    <span class="text-muted">Usuario no encontrado</span>
                                {% endif %}
                            </td>
                            <td>${{ "%.2f"|format(pedido.total) }}</td>
                            <td>{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                                <span class="badge bg-success">{{ pedido.estado }}</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalDetalles{{ pedido.ID_Pedido }}">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </td>
                        </tr>

                        <!-- modal placeholder moved out of table to avoid layout issues -->
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Modales de detalles (renderizados fuera de la tabla para mantener la tabla estable) -->
            {% for pedido in pedidos %}
            <div class="modal fade" id="modalDetalles{{ pedido.ID_Pedido }}" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Detalles del Pedido #{{ pedido.ID_Pedido }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Usuario:</strong> {{ pedido.usuario.nombre if pedido.usuario else 'N/A' }}<br>
                                    <strong>Email:</strong> {{ pedido.usuario.email if pedido.usuario else 'N/A' }}
                                </div>
                                <div class="col-md-6">
                                    <strong>Fecha:</strong> {{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}<br>
                                    <strong>Estado:</strong> <span class="badge bg-success">{{ pedido.estado }}</span>
                                </div>
                            </div>

                            <h6>Productos:</h6>
                            {% if pedido.detalles %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Producto</th>
                                                <th>Cantidad</th>
                                                <th>Precio Unit.</th>
                                                <th>Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for detalle in pedido.detalles %}
                                            <tr>
                                                <td>
                                                    {% if detalle.producto %}
                                                        {{ detalle.producto.nombre }}
                                                    {% else %}
                                                        Producto ID: {{ detalle.ID_Producto }}
                                                    {% endif %}
                                                </td>
                                                <td>{{ detalle.cantidad }}</td>
                                                <td>${{ "%.2f"|format(detalle.precio_unitario) }}</td>
                                                <td>${{ "%.2f"|format(detalle.cantidad * detalle.precio_unitario) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">No hay detalles disponibles</p>
                            {% endif %}

                            <div class="text-end mt-3">
                                <h5>Total: ${{ "%.2f"|format(pedido.total) }}</h5>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
--- Archivo: ./templates/admin/agregar_categoria.html ---
{% extends 'base.html' %}
{% block title %}Nueva Categoría - Admin{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Crear Nueva Categoría
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_agregar_categoria') }}">
                        
                        <div class="mb-3">
                            <label class="form-label">
                                Nombre de la Categoría *
                            </label>
                            <input type="text" 
                                   name="nombre" 
                                   class="form-control" 
                                   placeholder="Ej: Componentes PC, Periféricos, Monitores"
                                   required
                                   maxlength="100">
                            <small class="text-muted">Debe ser único</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea name="descripcion" 
                                      class="form-control" 
                                      rows="3"
                                      placeholder="Descripción breve de la categoría"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Icono (Font Awesome)
                                        <a href="https://fontawesome.com/icons" target="_blank" class="text-muted">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </label>
                                    <input type="text" 
                                           name="icono" 
                                           class="form-control" 
                                           value="fa-box" 
                                           placeholder="fa-desktop">
                                    <small class="text-muted">
                                        Ejemplos: fa-desktop, fa-keyboard, fa-microchip, fa-hdd
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Orden de visualización
                                    </label>
                                    <input type="number" 
                                           name="orden" 
                                           class="form-control" 
                                           value="0"
                                           min="0">
                                    <small class="text-muted">
                                        Menor número = aparece primero
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="activa" 
                                   id="activa" 
                                   checked>
                            <label class="form-check-label" for="activa">
                                <strong>Categoría activa</strong>
                                <br>
                                <small class="text-muted">
                                    Las categorías inactivas no se muestran en la tienda
                                </small>
                            </label>
                        </div>

                        <hr>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Nota:</strong> Después de crear la categoría, podrás agregar subcategorías.
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Crear Categoría
                            </button>
                            <a href="{{ url_for('admin_categorias') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Panel de ayuda -->
            <div class="card shadow mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Sugerencias</h5>
                </div>
                <div class="card-body">
                    <h6>Iconos populares de Font Awesome:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-microchip"></i> <code>fa-microchip</code> - Componentes</li>
                                <li><i class="fas fa-keyboard"></i> <code>fa-keyboard</code> - Periféricos</li>
                                <li><i class="fas fa-desktop"></i> <code>fa-desktop</code> - Monitores</li>
                                <li><i class="fas fa-hdd"></i> <code>fa-hdd</code> - Almacenamiento</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-headphones"></i> <code>fa-headphones</code> - Audio</li>
                                <li><i class="fas fa-fan"></i> <code>fa-fan</code> - Refrigeración</li>
                                <li><i class="fas fa-bolt"></i> <code>fa-bolt</code> - Fuentes</li>
                                <li><i class="fas fa-box"></i> <code>fa-box</code> - Gabinetes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- Archivo: ./templates/admin/agregar_producto.html ---
{% extends 'base.html' %}
{% block title %}Agregar Producto - Admin{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- FORMULARIO PRINCIPAL -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Agregar Nuevo Producto
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_agregar_producto') }}" enctype="multipart/form-data">
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto *</label>
                            <input type="text" name="nombre" class="form-control" required maxlength="200">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Precio ($) *</label>
                                    <input type="number" step="0.01" name="precio" class="form-control" required min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Stock *</label>
                                    <input type="number" name="stock" class="form-control" required min="0">
                                </div>
                            </div>
                        </div>

                        <!-- CATEGORÍAS -->
                        <div class="card mb-3 bg-light border">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-tags"></i> Categorización
                                    <a href="{{ url_for('admin_categorias_referencia') }}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-outline-info float-end">
                                        <i class="fas fa-book"></i> Ver Referencia
                                    </a>
                                </h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">
                                        Categoría Principal
                                        <small class="text-muted">(Opcional)</small>
                                    </label>
                                    <select name="ID_Categoria" id="selectCategoria" class="form-select" onchange="cargarSubcategorias()">
                                        <option value="">-- Sin categoría --</option>
                                        {% for cat in categorias %}
                                        <option value="{{ cat.ID_Categoria }}" 
                                                data-subcategorias='[{% for sub in cat.subcategorias %}{"ID_Subcategoria": {{ sub.ID_Subcategoria }}, "nombre": "{{ sub.nombre|e }}", "activa": {{ "true" if sub.activa else "false" }}}{% if not loop.last %},{% endif %}{% endfor %}]'>
                                            [ID: {{ cat.ID_Categoria }}] {{ cat.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Subcategoría
                                        <small class="text-muted">(Opcional)</small>
                                    </label>
                                    <select name="ID_Subcategoria" id="selectSubcategoria" class="form-select" disabled>
                                        <option value="">-- Primero selecciona una categoría --</option>
                                    </select>
                                    <small class="text-muted">
                                        Selecciona primero una categoría para ver sus subcategorías
                                    </small>
                                </div>

                                <div id="previewCategoria" class="alert alert-secondary d-none">
                                    <strong>Seleccionado:</strong> <span id="textCategoria"></span>
                                </div>
                            </div>
                        </div>

                        <!-- IMAGEN -->
                        <div class="mb-3">
                            <label class="form-label">Imagen del Producto</label>
                            <input type="file" name="imagen_file" class="form-control" accept="image/*" onchange="previewImagen(event)">
                            <small class="text-muted">Formatos permitidos: PNG, JPG, JPEG, GIF, WEBP (máx 2MB)</small>
                            <div class="mt-2">
                                <small class="text-muted">O ingresa URL de imagen:</small>
                                <input type="text" name="imagen" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                            </div>
                            <div id="imagePreview" class="mt-2"></div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="disponible" id="disponible" checked>
                            <label class="form-check-label" for="disponible">
                                <strong>Producto disponible para la venta</strong>
                            </label>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Agregar Producto
                            </button>
                            <a href="{{ url_for('admin_productos') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- PANEL DE AYUDA -->
        <div class="col-md-4">
            <div class="card shadow mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Ayuda
                    </h5>
                </div>
                <div class="card-body">
                    <h6>Categorías Disponibles:</h6>
                    
                    {% if categorias %}
                    <ul class="list-unstyled">
                        {% for cat in categorias %}
                        <li class="mb-3">
                            <i class="{{ cat.icono or 'fa-box' }}"></i> 
                            <strong>{{ cat.nombre }}</strong>
                            <span class="badge bg-secondary">ID: {{ cat.ID_Categoria }}</span>
                            
                            {% if cat.subcategorias %}
                            <ul class="mt-2 small">
                                {% for sub in cat.subcategorias|sort(attribute='orden') %}
                                <li>
                                    {{ sub.nombre }}
                                    <span class="badge bg-light text-dark">ID: {{ sub.ID_Subcategoria }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="alert alert-warning">
                        No hay categorías creadas.
                        <a href="{{ url_for('admin_agregar_categoria') }}" class="alert-link">Crear ahora</a>
                    </div>
                    {% endif %}
                    
                    <hr>
                    
                    <h6>Consejos:</h6>
                    <ul class="small">
                        <li>Si no asignas categoría, el producto aparecerá en "Sin categoría"</li>
                        <li>Puedes asignar solo categoría principal sin subcategoría</li>
                        <li>La subcategoría es opcional</li>
                        <li>Usa la referencia para ver todos los IDs</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Importante
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li>Los campos con (*) son obligatorios</li>
                        <li>El precio debe ser mayor a 0</li>
                        <li>El stock puede ser 0 (sin stock)</li>
                        <li>Si el stock es 0, considera marcar como "No disponible"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function cargarSubcategorias() {
    const selectCat = document.getElementById('selectCategoria');
    const selectSub = document.getElementById('selectSubcategoria');
    const preview = document.getElementById('previewCategoria');
    const textCategoria = document.getElementById('textCategoria');
    
    const selectedOption = selectCat.options[selectCat.selectedIndex];
    const categoriaId = selectCat.value;
    const categoriaNombre = selectedOption.text;
    
    // Limpiar subcategorías
    selectSub.innerHTML = '<option value="">-- Seleccionar subcategoría (opcional) --</option>';
    
    if (!categoriaId) {
        selectSub.disabled = true;
        preview.classList.add('d-none');
        return;
    }
    
    selectSub.disabled = false;
    
    // Obtener subcategorías del atributo data
    try {
        const subcategorias = JSON.parse(selectedOption.dataset.subcategorias || '[]');
        
        if (subcategorias.length > 0) {
            subcategorias.forEach(sub => {
                if (sub.activa) {
                    const option = document.createElement('option');
                    option.value = sub.ID_Subcategoria;
                    option.textContent = `[ID: ${sub.ID_Subcategoria}] ${sub.nombre}`;
                    selectSub.appendChild(option);
                }
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '-- No hay subcategorías disponibles --';
            selectSub.appendChild(option);
        }
    } catch (e) {
        console.error('Error cargando subcategorías:', e);
    }
    
    // Mostrar preview
    preview.classList.remove('d-none');
    textCategoria.textContent = categoriaNombre;
}

// Actualizar preview cuando cambia subcategoría
document.getElementById('selectSubcategoria').addEventListener('change', function() {
    const selectCat = document.getElementById('selectCategoria');
    const textCategoria = document.getElementById('textCategoria');
    
    const categoriaNombre = selectCat.options[selectCat.selectedIndex].text;
    const subcategoriaNombre = this.options[this.selectedIndex].text;
    
    if (this.value) {
        textCategoria.textContent = `${categoriaNombre} → ${subcategoriaNombre}`;
    } else {
        textCategoria.textContent = categoriaNombre;
    }
});

function previewImagen(event) {
    const preview = document.getElementById('imagePreview');
    const file = event.target.files[0];
    
    if (file) {
        // Validar tamaño
        if (file.size > 2 * 1024 * 1024) {
            alert('La imagen es muy grande. Máximo 2MB.');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px;">`;
        }
        reader.readAsDataURL(file);
    }
}
</script>
{% endblock %}

--- Archivo: ./templates/admin/categorias_referencia.html ---
{% extends 'base.html' %}

{% block title %}Referencia de Categorías{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-book"></i> Referencia Rápida de Categorías</h2>
        <div>
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <button onclick="window.close()" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
    </div>

    <div class="alert alert-info no-print">
        <i class="fas fa-info-circle"></i>
        <strong>Usa esta referencia al crear o editar productos.</strong>
        Aquí puedes ver todos los IDs de categorías y subcategorías disponibles.
    </div>

    {% if categorias %}
        {% for categoria in categorias %}
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="{{ categoria.icono or 'fa-box' }}"></i> 
                    {{ categoria.nombre }}
                    <span class="badge bg-light text-dark ms-2">ID: {{ categoria.ID_Categoria }}</span>
                </h4>
                <small>{{ categoria.descripcion or 'Sin descripción' }}</small>
            </div>
            <div class="card-body">
                {% if categoria.subcategorias %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="100" class="text-center">ID</th>
                                <th>Nombre Subcategoría</th>
                                <th>Descripción</th>
                                <th width="120" class="text-center">Productos</th>
                                <th width="100" class="text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in categoria.subcategorias|sort(attribute='orden') %}
                            <tr>
                                <td class="text-center">
                                    <strong class="badge bg-secondary fs-6">{{ sub.ID_Subcategoria }}</strong>
                                </td>
                                <td><strong>{{ sub.nombre }}</strong></td>
                                <td><small>{{ sub.descripcion or '-' }}</small></td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ sub.productos|length }}</span>
                                </td>
                                <td class="text-center">
                                    {% if sub.activa %}
                                    <span class="badge bg-success">Activa</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inactiva</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No hay subcategorías en esta categoría.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        No hay categorías creadas aún.
    </div>
    {% endif %}
</div>

<style>
@media print {
    .no-print, .btn { display: none !important; }
    .card { page-break-inside: avoid; border: 1px solid #000; }
    .card-header { background-color: #333 !important; color: white !important; }
}
</style>
{% endblock %}

--- Archivo: ./templates/admin/productos.html ---
{% extends 'base.html' %}

{% block title %}Gestión de Productos - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-box"></i> Gestión de Productos</h2>
        <div>
            <a href="{{ url_for('admin_agregar_producto') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Nuevo Producto
            </a>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    {% if productos %}
    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th width="50">ID</th>
                            <th width="80">Imagen</th>
                            <th>Nombre</th>
                            <th width="200">Categoría</th>
                            <th width="100">Precio</th>
                            <th width="80">Stock</th>
                            <th width="100">Disponible</th>
                            <th width="150">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos %}
                        <tr>
                            <td>{{ producto.ID_Producto }}</td>
                            <td>
                                {% if producto.imagen %}
                                <img src="{{ url_for('static', filename=producto.imagen) }}" 
                                     style="width: 50px; height: 50px; object-fit: cover;"
                                     onerror="this.innerHTML='<i class=\'fas fa-image text-muted\'></i>'">
                                {% else %}
                                <i class="fas fa-image text-muted"></i>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ producto.nombre }}</strong>
                            </td>
                            <td>
                                {% if producto.categoria %}
                                    <span class="badge bg-primary">
                                        <i class="{{ producto.categoria.icono }}"></i>
                                        {{ producto.categoria.nombre }}
                                    </span>
                                    {% if producto.subcategoria %}
                                    <br>
                                    <small class="badge bg-secondary mt-1">
                                        {{ producto.subcategoria.nombre }}
                                    </small>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-warning text-dark">Sin categoría</span>
                                {% endif %}
                            </td>
                            <td><strong>${{ "%.2f"|format(producto.precio) }}</strong></td>
                            <td>
                                {% if producto.stock == 0 %}
                                <span class="badge bg-danger">{{ producto.stock }}</span>
                                {% elif producto.stock < 10 %}
                                <span class="badge bg-warning text-dark">{{ producto.stock }}</span>
                                {% else %}
                                <span class="badge bg-success">{{ producto.stock }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if producto.disponible %}
                                <span class="badge bg-success">Sí</span>
                                {% else %}
                                <span class="badge bg-danger">No</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('admin_editar_producto', producto_id=producto.ID_Producto) }}" 
                                   class="btn btn-sm btn-primary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('admin_eliminar_producto', producto_id=producto.ID_Producto) }}" 
                                   class="btn btn-sm btn-danger"
                                   onclick="return confirm('¿Eliminar \'{{ producto.nombre }}\'?')"
                                   title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <p class="text-muted">
            <strong>Total de productos:</strong> {{ productos|length }}
        </p>
    </div>
    {% else %}
    <div class="alert alert-info text-center py-5">
        <i class="fas fa-box-open fa-3x mb-3"></i>
        <h4>No hay productos registrados</h4>
        <p>Comienza agregando tu primer producto.</p>
        <a href="{{ url_for('admin_agregar_producto') }}" class="btn btn-success btn-lg mt-3">
            <i class="fas fa-plus"></i> Agregar Primer Producto
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

--- Archivo: ./templates/admin/editar_categoria.html ---
{% extends 'base.html' %}
{% block title %}Editar Categoría - Admin{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit"></i> Editar Categoría
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary">
                        <strong>Editando:</strong> {{ categoria.nombre }}
                        <span class="badge bg-dark">ID: {{ categoria.ID_Categoria }}</span>
                    </div>

                    <form method="POST">
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre de la Categoría *</label>
                            <input type="text" 
                                   name="nombre" 
                                   class="form-control" 
                                   value="{{ categoria.nombre }}"
                                   required
                                   maxlength="100">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea name="descripcion" 
                                      class="form-control" 
                                      rows="3">{{ categoria.descripcion or '' }}</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Icono (Font Awesome)</label>
                                    <input type="text" 
                                           name="icono" 
                                           class="form-control" 
                                           value="{{ categoria.icono or 'fa-box' }}">
                                    <small class="text-muted">
                                        Vista previa: <i class="{{ categoria.icono or 'fa-box' }}"></i>
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Orden</label>
                                    <input type="number" 
                                           name="orden" 
                                           class="form-control" 
                                           value="{{ categoria.orden }}"
                                           min="0">
                                </div>
                            </div>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="activa" 
                                   id="activa" 
                                   {% if categoria.activa %}checked{% endif %}>
                            <label class="form-check-label" for="activa">
                                <strong>Categoría activa</strong>
                            </label>
                        </div>

                        <hr>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="alert alert-info mb-0">
                                    <strong>Productos:</strong> 
                                    <span class="badge bg-primary">{{ categoria.productos|length }}</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-secondary mb-0">
                                    <strong>Subcategorías:</strong> 
                                    <span class="badge bg-dark">{{ categoria.subcategorias|length }}</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-warning mb-0">
                                    <strong>Creada:</strong> 
                                    {{ categoria.fecha_creacion.strftime('%d/%m/%Y') if categoria.fecha_creacion else 'N/A' }}
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                            <a href="{{ url_for('admin_categorias') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Información adicional -->
            {% if categoria.subcategorias %}
            <div class="card shadow mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> 
                        Subcategorías de esta categoría ({{ categoria.subcategorias|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for sub in categoria.subcategorias|sort(attribute='orden') %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ sub.nombre }}
                            <div>
                                <span class="badge bg-info">{{ sub.productos|length }} productos</span>
                                <span class="badge bg-secondary">ID: {{ sub.ID_Subcategoria }}</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

--- Archivo: ./templates/admin/usuario_metricas.html ---
{% extends "base.html" %}

{% block title %}Axion Store - Métricas de {{ usuario.nombre }}{% endblock %}

{% block extra_css %}
<style>
    .metric-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .timeline-item {
        border-left: 3px solid #667eea;
        padding-left: 20px;
        margin-bottom: 20px;
        position: relative;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -8px;
        top: 0;
        width: 13px;
        height: 13px;
        border-radius: 50%;
        background: #667eea;
        border: 3px solid white;
    }

    .badge-accion {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
    }

    .badge-agregar { background: #10b981; color: white; }
    .badge-quitar { background: #f59e0b; color: white; }
    .badge-comprar { background: #3b82f6; color: white; }
    .badge-abandonar { background: #ef4444; color: white; }

    .stat-card-small {
        padding: 15px;
        border-radius: 8px;
        background: #f8f9fa;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-6 fw-bold">
                <i class="fas fa-user-chart"></i> Métricas Detalladas
            </h1>
            <p class="text-muted mb-0">
                Usuario: <strong>{{ usuario.nombre }}</strong> ({{ usuario.email }})
            </p>
        </div>
        <div>
            <a href="{{ url_for('admin_usuarios') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Usuarios
            </a>
        </div>
    </div>

    <!-- Resumen del Usuario -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-box">
                <div class="metric-value">{{ usuario.total_compras }}</div>
                <div class="metric-label">Total Compras</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="metric-value">${{ "%.2f"|format(usuario.total_gastado) }}</div>
                <div class="metric-label">Total Gastado</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="metric-value">{{ usuario.total_recargas }}</div>
                <div class="metric-label">Total Recargas</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="metric-value">{{ "%.1f"|format(usuario.tasa_conversion) }}%</div>
                <div class="metric-label">Tasa de Conversión</div>
            </div>
        </div>
    </div>

    <!-- Información General -->
    <div class="row">
        <div class="col-md-6">
            <div class="card card-custom">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle"></i> Información General
                    </h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>ID Usuario:</strong></td>
                            <td>{{ usuario.ID_Users }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Registro:</strong></td>
                            <td>{{ usuario.fecha_registro.strftime('%d/%m/%Y %H:%M') }}</td>
                        </tr>
                        <tr>
                            <td><strong>Segmento:</strong></td>
                            <td>
                                <span class="badge
                                    {% if usuario.segmento_cliente == 'vip' %}bg-warning text-dark
                                    {% elif usuario.segmento_cliente == 'activo' %}bg-success
                                    {% elif usuario.segmento_cliente == 'inactivo' %}bg-secondary
                                    {% else %}bg-primary{% endif %}">
                                    {{ usuario.segmento_cliente|capitalize }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Última Actividad:</strong></td>
                            <td>{{ usuario.ultima_actividad.strftime('%d/%m/%Y %H:%M') if usuario.ultima_actividad else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Ticket Promedio:</strong></td>
                            <td class="fw-bold text-success">${{ "%.2f"|format(usuario.ticket_promedio) }}</td>
                        </tr>
                        <tr>
                            <td><strong>Recarga Promedio:</strong></td>
                            <td class="fw-bold text-primary">${{ "%.2f"|format(usuario.recarga_promedio) }}</td>
                        </tr>
                        {% if promedio_dias_entre_compras > 0 %}
                        <tr>
                            <td><strong>Días entre Compras:</strong></td>
                            <td>{{ "%.0f"|format(promedio_dias_entre_compras) }} días</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card card-custom">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-shopping-cart"></i> Estado del Carrito
                    </h5>
                    <div class="stat-card-small">
                        <div class="d-flex justify-content-between">
                            <span>Productos en Carrito Actual:</span>
                            <strong>{{ usuario.productos_carrito_actual }}</strong>
                        </div>
                    </div>
                    <div class="stat-card-small">
                        <div class="d-flex justify-content-between">
                            <span>Valor del Carrito:</span>
                            <strong class="text-success">${{ "%.2f"|format(usuario.valor_carrito_actual) }}</strong>
                        </div>
                    </div>
                    <div class="stat-card-small">
                        <div class="d-flex justify-content-between">
                            <span>Total Productos Agregados:</span>
                            <strong>{{ usuario.productos_agregados_carrito_total }}</strong>
                        </div>
                    </div>
                    <div class="stat-card-small">
                        <div class="d-flex justify-content-between">
                            <span>Carritos Abandonados:</span>
                            <strong class="text-danger">{{ usuario.carritos_abandonados }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos Favoritos -->
    {% if productos_favoritos %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card card-custom">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-heart"></i> Top 10 Productos Más Comprados
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Producto</th>
                                    <th>Unidades Compradas</th>
                                    <th>Gasto Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos_favoritos %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        {% if producto.imagen %}
                                        <img src="{{ url_for('static', filename=producto.imagen) }}"
                                             style="width:40px;height:40px;object-fit:cover;border-radius:5px;"
                                             class="me-2"
                                             onerror="this.style.display='none'">
                                        {% endif %}
                                        {{ producto.nombre }}
                                    </td>
                                    <td><span class="badge bg-primary">{{ producto.total_comprado }}</span></td>
                                    <td class="fw-bold text-success">${{ "%.2f"|format(producto.gasto_total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Productos No Comprados (Abandonados) -->
    {% if productos_no_comprados %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card card-custom border-warning">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        <i class="fas fa-exclamation-circle"></i> Productos Agregados pero No Comprados
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Producto</th>
                                    <th>Precio</th>
                                    <th>Veces Agregado</th>
                                    <th>Valor Perdido</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos_no_comprados %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ producto.nombre }}</td>
                                    <td>${{ "%.2f"|format(producto.precio) }}</td>
                                    <td><span class="badge bg-warning text-dark">{{ producto.veces_agregado }}</span></td>
                                    <td class="fw-bold text-danger">${{ "%.2f"|format(producto.valor_total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Historial de Transacciones Wallet -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card card-custom">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-wallet"></i> Historial de Transacciones Wallet
                        <span class="badge bg-info ms-2">{{ transacciones|length }} transacciones</span>
                    </h5>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mt-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#todas">
                                Todas ({{ transacciones|length }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#recargas">
                                Recargas ({{ recargas|length }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#compras">
                                Compras ({{ compras|length }})
                            </a>
                        </li>
                        {% if admin_recargas %}
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#admin">
                                Admin ({{ admin_recargas|length }})
                            </a>
                        </li>
                        {% endif %}
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-3">
                        <!-- Todas -->
                        <div id="todas" class="tab-pane fade show active">
                            {% if transacciones %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                            <th>Monto</th>
                                            <th>Saldo Anterior</th>
                                            <th>Saldo Nuevo</th>
                                            <th>Descripción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaccion in transacciones %}
                                        <tr>
                                            <td>{{ transaccion.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                                            <td>
                                                <span class="badge
                                                    {% if transaccion.tipo == 'recarga' %}bg-success
                                                    {% elif transaccion.tipo == 'compra' %}bg-primary
                                                    {% else %}bg-warning text-dark{% endif %}">
                                                    {{ transaccion.tipo|capitalize }}
                                                </span>
                                            </td>
                                            <td class="fw-bold {% if transaccion.monto > 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ "+" if transaccion.monto > 0 else "" }}${{ "%.2f"|format(transaccion.monto) }}
                                            </td>
                                            <td>${{ "%.2f"|format(transaccion.saldo_anterior) }}</td>
                                            <td class="fw-bold">${{ "%.2f"|format(transaccion.saldo_nuevo) }}</td>
                                            <td><small>{{ transaccion.descripcion }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">No hay transacciones</p>
                            {% endif %}
                        </div>

                        <!-- Recargas -->
                        <div id="recargas" class="tab-pane fade">
                            {% if recargas %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Monto</th>
                                            <th>Saldo Nuevo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaccion in recargas %}
                                        <tr>
                                            <td>{{ transaccion.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                                            <td class="fw-bold text-success">+${{ "%.2f"|format(transaccion.monto) }}</td>
                                            <td>${{ "%.2f"|format(transaccion.saldo_nuevo) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">No hay recargas</p>
                            {% endif %}
                        </div>

                        <!-- Compras -->
                        <div id="compras" class="tab-pane fade">
                            {% if compras %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Pedido</th>
                                            <th>Monto</th>
                                            <th>Saldo Nuevo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaccion in compras %}
                                        <tr>
                                            <td>{{ transaccion.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                                            <td>#{{ transaccion.ID_Pedido }}</td>
                                            <td class="fw-bold text-danger">${{ "%.2f"|format(transaccion.monto) }}</td>
                                            <td>${{ "%.2f"|format(transaccion.saldo_nuevo) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">No hay compras</p>
                            {% endif %}
                        </div>

                        <!-- Admin -->
                        {% if admin_recargas %}
                        <div id="admin" class="tab-pane fade">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Monto</th>
                                            <th>Descripción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaccion in admin_recargas %}
                                        <tr>
                                            <td>{{ transaccion.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                                            <td class="fw-bold text-warning">+${{ "%.2f"|format(transaccion.monto) }}</td>
                                            <td>{{ transaccion.descripcion }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Carrito -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card card-custom">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-history"></i> Historial de Actividad en Carrito
                        <span class="badge bg-secondary ms-2">Últimas 100 acciones</span>
                    </h5>

                    <!-- Resumen de acciones -->
                    <div class="row text-center mt-3 mb-3">
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <span class="badge-accion badge-agregar">Agregados</span>
                                <div class="fw-bold mt-2">{{ agregados|length }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <span class="badge-accion badge-comprar">Comprados</span>
                                <div class="fw-bold mt-2">{{ comprados|length }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <span class="badge-accion badge-quitar">Quitados</span>
                                <div class="fw-bold mt-2">{{ quitados|length }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <span class="badge-accion badge-abandonar">Abandonados</span>
                                <div class="fw-bold mt-2">{{ abandonados|length }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline de acciones -->
                    {% if historial_carrito %}
                    <div style="max-height: 500px; overflow-y: auto;">
                        {% for item, nombre_producto in historial_carrito[:50] %}
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="badge-accion badge-{{ item.accion }}">
                                        {{ item.accion|capitalize }}
                                    </span>
                                    <strong class="ms-2">{{ nombre_producto }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        {{ item.cantidad }} unidad(es) × ${{ "%.2f"|format(item.precio_momento) }}
                                        = ${{ "%.2f"|format(item.valor_total) }}
                                    </small>
                                </div>
                                <small class="text-muted">
                                    {{ item.fecha.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No hay historial de carrito</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- Archivo: ./static/js/autocomplete.js ---
// static/js/autocomplete.js - Búsqueda en tiempo real

document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.querySelector('[data-autocomplete="product"]');
  if (!searchInput) return;

  // Crear contenedor de resultados
  let resultsContainer = document.getElementById('search-autocomplete-list');
  if (!resultsContainer) {
    resultsContainer = document.createElement('ul');
    resultsContainer.id = 'search-autocomplete-list';
    resultsContainer.className = 'autocomplete-results';
    resultsContainer.style.display = 'none';

    // Insertar después del input
    const wrapper = searchInput.parentElement;
    wrapper.style.position = 'relative';
    wrapper.appendChild(resultsContainer);
  }

  let debounceTimer;
  let currentFocus = -1;

  searchInput.addEventListener('input', function() {
    const query = this.value.trim();

    clearTimeout(debounceTimer);

    if (query.length < 2) {
      resultsContainer.style.display = 'none';
      resultsContainer.innerHTML = '';
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`/api/search_autocomplete?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        resultsContainer.innerHTML = '';
        currentFocus = -1;

        if (data.length === 0) {
          resultsContainer.innerHTML = '<li class="autocomplete-item no-results">No se encontraron resultados</li>';
          resultsContainer.style.display = 'block';
          return;
        }

        data.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'autocomplete-item';
          li.dataset.index = index;
          li.innerHTML = `
          <img src="${item.imagen ? '/static/' + item.imagen : 'https://via.placeholder.com/40x40?text=?'}"
          alt="${item.nombre}"
          onerror="this.src='https://via.placeholder.com/40x40?text=?'">
          <div class="item-info">
          <div class="item-name">${highlightMatch(item.nombre, query)}</div>
          <div class="item-price">$${item.precio.toFixed(2)}</div>
          ${item.categoria ? `<div class="item-category">${item.categoria}</div>` : ''}
          </div>
          `;

          li.addEventListener('click', function() {
            window.location.href = `/product/${item.id}`;
          });

          resultsContainer.appendChild(li);
        });

        resultsContainer.style.display = 'block';
      })
      .catch(error => {
        console.error('Error en autocomplete:', error);
        resultsContainer.style.display = 'none';
      });
    }, 300);
  });

  // Navegación con teclado
  searchInput.addEventListener('keydown', function(e) {
    const items = resultsContainer.querySelectorAll('.autocomplete-item:not(.no-results)');

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      currentFocus++;
      if (currentFocus >= items.length) currentFocus = 0;
      setActive(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      currentFocus--;
      if (currentFocus < 0) currentFocus = items.length - 1;
      setActive(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (currentFocus > -1 && items[currentFocus]) {
        items[currentFocus].click();
      }
    } else if (e.key === 'Escape') {
      resultsContainer.style.display = 'none';
    }
  });

  function setActive(items) {
    items.forEach((item, index) => {
      item.classList.remove('active');
      if (index === currentFocus) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest' });
      }
    });
  }

  function highlightMatch(text, query) {
    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
  }

  function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Cerrar al hacer clic fuera
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
      resultsContainer.style.display = 'none';
    }
  });

  // Mantener abierto al hacer focus
  searchInput.addEventListener('focus', function() {
    if (resultsContainer.innerHTML && this.value.trim().length >= 2) {
      resultsContainer.style.display = 'block';
    }
  });
});

--- Archivo: ./static/js/cart-inline.js ---
document.addEventListener('DOMContentLoaded', function() {
  // Interceptar clicks en botones 'add-to-cart' para confirmar inline
  document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const href = btn.getAttribute('href');
      if (!href) return;

      // Mostrar feedback inmediato
      showInlineConfirmation('Agregando al carrito...');

      fetch(href, { method: 'GET', credentials: 'same-origin' })
        .then(resp => {
          if (resp.ok) {
            // Incrementar contador visual del carrito si existe
            const cartCountEl = document.getElementById('cart-count');
            if (cartCountEl) {
              const val = parseInt(cartCountEl.textContent) || 0;
              cartCountEl.textContent = val + 1;
              // asegurarse que la insignia sea visible
              cartCountEl.style.display = '';
            }
            showInlineConfirmation('✓ Producto agregado al carrito');
          } else {
            showInlineConfirmation('Error al agregar al carrito', true);
          }
        }).catch(err => {
          console.error(err);
          showInlineConfirmation('Error de red', true);
        });
    });
  });

  function showInlineConfirmation(text, isError) {
    const containerId = 'inline-confirmations';
    let container = document.getElementById(containerId);
    if (!container) {
      container = document.createElement('div');
      container.id = containerId;
      container.style.position = 'fixed';
      container.style.right = '20px';
      container.style.bottom = '80px';
      container.style.zIndex = 1070;
      document.body.appendChild(container);
    }

    const card = document.createElement('div');
    card.className = 'card p-2 mb-2';
    card.style.minWidth = '220px';
    card.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
    card.innerHTML = `<div class="d-flex align-items-center"><div class="flex-grow-1">${escapeHtml(text)}</div><button class="btn-close ms-2" aria-label="cerrar"></button></div>`;
    if (isError) card.style.borderLeft = '4px solid #dc3545';
    else card.style.borderLeft = '4px solid #28a745';

    container.appendChild(card);

    // Close button
    card.querySelector('.btn-close').addEventListener('click', () => card.remove());

    setTimeout(() => {
      card.remove();
    }, 4500);
  }

  function escapeHtml(unsafe) {
    return unsafe.replace(/[&<>"'`]/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;'})[m]; });
  }
});

--- Archivo: ./static/js/password-toggle.js ---
// password-toggle.js
document.addEventListener('DOMContentLoaded', function () {
  // Attach event via delegation to support dynamic fields if needed
  document.querySelectorAll('.password-toggle').forEach(function (btn) {
    btn.addEventListener('click', function (e) {
      var wrapper = btn.closest('.password-wrapper');
      if (!wrapper) return;
      var input = wrapper.querySelector('.password-input');
      if (!input) return;

      var isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';

      // Update icon if using FontAwesome
      var icon = btn.querySelector('i');
      if (icon) {
        // support fa / fas / fa-solid classes
        if (isPassword) {
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      }

      // Update aria attributes
      btn.setAttribute('aria-pressed', isPassword ? 'true' : 'false');
      btn.setAttribute('aria-label', isPassword ? 'Ocultar contraseña' : 'Mostrar contraseña');
    });
  });
});

--- Archivo: ./static/js/skeletons.js ---
document.addEventListener('DOMContentLoaded', function() {
  // Replace product images with a skeleton until they load
  const productImages = document.querySelectorAll('img.product-image, img.img-fluid');
  productImages.forEach(img => {
    // Skip images without a src
    if (!img.src) return;
    // Create skeleton overlay
    const wrapper = document.createElement('div');
    wrapper.className = 'skeleton-wrapper';
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton-card';
    // Insert wrapper before img
    img.parentNode.insertBefore(wrapper, img);
    wrapper.appendChild(img);
    wrapper.insertBefore(skeleton, img);

    // When image loads, remove skeleton
    if (img.complete && img.naturalWidth !== 0) {
      skeleton.style.display = 'none';
    } else {
      img.addEventListener('load', function() {
        skeleton.style.display = 'none';
      });
      img.addEventListener('error', function() {
        skeleton.style.display = 'none';
      });
    }
  });
});

--- Archivo: ./static/js/notifications.js ---
document.addEventListener('DOMContentLoaded', function() {
  // Solo inicializar si el navegador soporta EventSource
  if (!window.EventSource) return;

  // Crear contenedor de notificaciones en la UI
  function ensureContainer() {
    let c = document.getElementById('notifications-container');
    if (!c) {
      c = document.createElement('div');
      c.id = 'notifications-container';
      c.style.position = 'fixed';
      c.style.right = '20px';
      c.style.bottom = '20px';
      c.style.zIndex = 1060;
      document.body.appendChild(c);
    }
    return c;
  }

  const container = ensureContainer();
  const es = new EventSource('/notifications/stream');

  es.onmessage = function(evt) {
    try {
      const payload = JSON.parse(evt.data);
      const msg = payload.message || 'Notificación';
      showNotification(msg);
    } catch (e) {
      console.error('Invalid SSE payload', e);
    }
  };

  es.onerror = function(err) {
    // reconectar automático por EventSource; mostrar estado
    console.warn('SSE connection error', err);
  };

  function showNotification(text) {
    const card = document.createElement('div');
    card.className = 'card shadow-sm mb-2';
    card.style.minWidth = '260px';
    card.innerHTML = `<div class="card-body p-2"><small class="text-muted">Notificación</small><div>${escapeHtml(text)}</div></div>`;
    container.appendChild(card);
    // Mostrar por menos tiempo para una experiencia menos intrusiva
    setTimeout(() => {
      card.classList.add('fade-out');
      setTimeout(() => card.remove(), 300);
    }, 3000);
  }

  function escapeHtml(unsafe) {
    return unsafe.replace(/[&<>"'`]/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;'})[m]; });
  }

});

--- Archivo: ./static/css/style.css ---
/* ============================================================
   AXION STORE — CSS PROFESIONAL UNIFICADO v3
   Paleta Claro / Oscuro + Todas las Correcciones
   ============================================================ */

/* ==================== PREVENIR FLASH DE TEMA ==================== */
/* Este bloque evita el flash blanco al cargar en modo oscuro */
html.dark-mode,
html.dark-mode body {
    background: #0F1217 !important;
    color: #E9ECF1 !important;
}

/* ==================== MODO CLARO (DEFAULT) ==================== */
:root {
    --color-bg: #F3F5F7;
    --color-card: #FFFFFF;
    --color-text: #1A1C1E;
    --color-text-sec: #6D737A;
    --color-border: #E2E5E9;
    --color-primary: #21324A;
    --color-accent: #4A6FA5;
    --color-success: #28a745;
    --color-danger: #dc3545;
    --color-warning: #ffc107;
    --color-info: #17a2b8;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --transition: 0.3s ease;
}

/* ==================== MODO OSCURO ==================== */
.dark-mode {
    --color-bg: #0F1217;
    --color-card: #161B22;
    --color-text: #E9ECF1;
    --color-text-sec: #9AA3AD;
    --color-border: #2D3748;
    --color-primary: #4F7BEA;
    --color-accent: #6B8DD6;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.4);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.5);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.6);
}

/* ============================================================
   RESET Y ESTILOS BASE
   ============================================================ */
*, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: var(--color-bg) !important;
    color: var(--color-text) !important;
    font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    line-height: 1.6;
    transition: background 0.2s ease, color 0.2s ease;
}

.dark-mode,
.dark-mode body {
    background: var(--color-bg) !important;
    color: var(--color-text) !important;
}

/* Scrollbar */
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: var(--color-bg); }
::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 5px; }

/* ============================================================
   TIPOGRAFÍA
   ============================================================ */
h1, h2, h3, h4, h5, h6 {
    color: var(--color-text);
    font-weight: 700;
}

p { color: var(--color-text-sec); }

a {
    color: var(--color-primary);
    text-decoration: none;
    transition: color var(--transition);
}

a:hover { color: var(--color-accent); text-decoration: none; }

.dark-mode h1, .dark-mode h2, .dark-mode h3, 
.dark-mode h4, .dark-mode h5, .dark-mode h6,
.dark-mode .card-title, .dark-mode label, 
.dark-mode .form-label, .dark-mode th, .dark-mode td,
.dark-mode strong, .dark-mode b {
    color: var(--color-text) !important;
}

.dark-mode p, .dark-mode .card-text, .dark-mode small:not(.badge) {
    color: var(--color-text-sec) !important;
}

.dark-mode a:not(.btn):not(.nav-link):not(.dropdown-item):not(.list-group-item) { 
    color: var(--color-accent) !important; 
}

/* ============================================================
   NAVBAR
   ============================================================ */
.navbar-custom {
    background: var(--color-primary) !important;
    border-bottom: 1px solid var(--color-border);
    padding: 0.8rem 2rem;
}

.dark-mode .navbar-custom {
    background: #11151C !important;
}

.navbar-custom .navbar-brand,
.navbar-custom .nav-link {
    color: #ffffff !important;
}

.navbar-custom .nav-link:hover {
    color: var(--color-accent) !important;
    background: rgba(255,255,255,0.1);
    border-radius: var(--radius-sm);
}

img.navbar-logo,
.navbar-brand img.navbar-logo {
    width: 72px !important;
    height: auto !important;
    max-height: 72px !important;
}

/* ============================================================
   DROPDOWN MENU
   ============================================================ */
.dropdown-menu {
    background: var(--color-card) !important;
    border: 1px solid var(--color-border) !important;
    border-radius: var(--radius-md) !important;
    box-shadow: var(--shadow-lg) !important;
    padding: 0.5rem 0 !important;
    min-width: 200px !important;
    max-width: 260px !important;
    overflow: hidden !important;
}

.dropdown-item {
    color: var(--color-text) !important;
    padding: 0.6rem 1rem !important;
    display: flex !important;
    align-items: center !important;
    gap: 0.5rem !important;
    transition: background var(--transition) !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

.dropdown-item i {
    width: 18px !important;
    text-align: center !important;
    flex-shrink: 0 !important;
    color: var(--color-text-sec) !important;
}

.dropdown-item:hover {
    background: rgba(0,0,0,0.05) !important;
    color: var(--color-primary) !important;
}

.dropdown-divider {
    border-color: var(--color-border) !important;
    margin: 0.3rem 0 !important;
}

.dropdown-item .badge {
    margin-left: auto !important;
    flex-shrink: 0 !important;
}

.dark-mode .dropdown-menu {
    background: #1E2530 !important;
    border-color: #3D4756 !important;
}

.dark-mode .dropdown-item {
    color: var(--color-text) !important;
}

.dark-mode .dropdown-item i {
    color: var(--color-text-sec) !important;
}

.dark-mode .dropdown-item:hover {
    background: rgba(255,255,255,0.08) !important;
    color: var(--color-accent) !important;
}

.dark-mode .dropdown-divider {
    border-color: #3D4756 !important;
}

/* ============================================================
   BOTONES
   ============================================================ */
.btn {
    padding: 0.7rem 1.4rem;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 600;
    transition: all var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

/* Botón Primary Sólido */
.btn-primary,
.btn-primary-custom {
    background: var(--color-primary) !important;
    color: #fff !important;
    border: 2px solid var(--color-primary) !important;
}

.btn-primary:hover,
.btn-primary-custom:hover {
    background: var(--color-accent) !important;
    border-color: var(--color-accent) !important;
    transform: translateY(-2px);
}

.btn-primary i,
.btn-primary-custom i {
    color: #fff !important;
}

/* Botón Outline Primary */
.btn-outline-primary {
    background: transparent !important;
    border: 2px solid var(--color-primary) !important;
    color: var(--color-primary) !important;
}

.btn-outline-primary:hover {
    background: var(--color-primary) !important;
    color: #fff !important;
}

.btn-outline-primary i {
    color: inherit !important;
}

/* Botón Success Sólido */
.btn-success {
    background: var(--color-success) !important;
    color: #fff !important;
    border: 2px solid var(--color-success) !important;
}

.btn-success:hover {
    background: #218838 !important;
    border-color: #218838 !important;
}

.btn-success i {
    color: #fff !important;
}

/* Botón Outline Success */
.btn-outline-success {
    background: transparent !important;
    border: 2px solid var(--color-success) !important;
    color: var(--color-success) !important;
}

.btn-outline-success:hover {
    background: var(--color-success) !important;
    color: #fff !important;
}

/* Botón Info */
.btn-info {
    background: var(--color-info) !important;
    color: #fff !important;
    border: 2px solid var(--color-info) !important;
}

.btn-info i {
    color: #fff !important;
}

/* Botón Outline Secondary */
.btn-outline-secondary {
    background: transparent !important;
    border: 2px solid var(--color-text-sec) !important;
    color: var(--color-text-sec) !important;
}

.btn-outline-secondary:hover {
    background: var(--color-text-sec) !important;
    color: #fff !important;
}

/* Botón Danger */
.btn-danger {
    background: var(--color-danger) !important;
    color: #fff !important;
    border: 2px solid var(--color-danger) !important;
}

.btn-danger i {
    color: #fff !important;
}

/* Botón Outline Danger */
.btn-outline-danger {
    background: transparent !important;
    border: 2px solid var(--color-danger) !important;
    color: var(--color-danger) !important;
}

.btn-outline-danger:hover {
    background: var(--color-danger) !important;
    color: #fff !important;
}

/* Botón Warning */
.btn-warning {
    background: var(--color-warning) !important;
    color: #000 !important;
    border: 2px solid var(--color-warning) !important;
}

.btn-warning i {
    color: #000 !important;
}

/* Botón Outline Warning */
.btn-outline-warning {
    background: transparent !important;
    border: 2px solid var(--color-warning) !important;
    color: var(--color-warning) !important;
}

.btn-outline-warning:hover {
    background: var(--color-warning) !important;
    color: #000 !important;
}

/* Botón Outline Light */
.btn-outline-light {
    background: transparent !important;
    border: 2px solid rgba(255,255,255,0.6) !important;
    color: #fff !important;
}

.btn-outline-light:hover {
    background: rgba(255,255,255,0.15) !important;
    border-color: #fff !important;
}

/* Botón Invitado */
.btn-invitado {
    background: var(--color-primary) !important;
    color: #ffffff !important;
    border: 2px solid var(--color-primary) !important;
}

.btn-invitado:hover {
    background: var(--color-accent) !important;
    border-color: var(--color-accent) !important;
}

/* Botón Secondary (gris) */
.btn-secondary {
    background: #6c757d !important;
    color: #fff !important;
    border: 2px solid #6c757d !important;
}

.btn-secondary i {
    color: #fff !important;
}

/* MODO OSCURO - Botones */
.dark-mode .btn-primary,
.dark-mode .btn-primary-custom {
    background: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
    color: #fff !important;
}

.dark-mode .btn-outline-primary {
    border-color: var(--color-accent) !important;
    color: var(--color-accent) !important;
    background: transparent !important;
}

.dark-mode .btn-outline-primary:hover {
    background: var(--color-accent) !important;
    color: #fff !important;
}

.dark-mode .btn-outline-primary i {
    color: inherit !important;
}

.dark-mode .btn-outline-secondary {
    border-color: var(--color-text-sec) !important;
    color: var(--color-text-sec) !important;
}

.dark-mode .btn-outline-secondary:hover {
    background: var(--color-text-sec) !important;
    color: var(--color-bg) !important;
}

.dark-mode .btn-invitado {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
    color: var(--color-text) !important;
}

.dark-mode .btn-invitado:hover {
    background: var(--color-accent) !important;
    border-color: var(--color-accent) !important;
    color: #fff !important;
}

/* ============================================================
   CARDS
   ============================================================ */
.card,
.card-custom {
    background: var(--color-card) !important;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border) !important;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition);
    overflow: hidden;
}

.card:hover,
.card-custom:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

/* ============================================================
   CARD HEADERS - TEMA CLARO Y OSCURO
   ============================================================ */
.card-header {
    background: var(--color-primary) !important;
    color: #fff !important;
    border-bottom: 1px solid var(--color-border);
    padding: 1rem 1.25rem;
}

/* IMPORTANTE: Texto claro en headers oscuros (TEMA CLARO) */
.card-header,
.card-header *,
.card-header h1,
.card-header h2,
.card-header h3,
.card-header h4,
.card-header h5,
.card-header h6,
.card-header p,
.card-header span,
.card-header .mb-0,
.card-header i {
    color: #fff !important;
}

.card-header.bg-dark,
.card-header.bg-dark *,
.card-header.bg-primary,
.card-header.bg-primary * {
    color: #fff !important;
}

.card-body {
    padding: 1.5rem;
    background: var(--color-card) !important;
}

.card-footer {
    background: var(--color-card) !important;
    border-top: 1px solid var(--color-border);
    padding: 1rem 1.25rem;
}

.dark-mode .card,
.dark-mode .card-custom {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .card-header,
.dark-mode .card-header.bg-dark {
    background: #1A1F27 !important;
    border-bottom-color: var(--color-border) !important;
}

.dark-mode .card-header *,
.dark-mode .card-header h5,
.dark-mode .card-header i {
    color: #fff !important;
}

.dark-mode .card-body {
    background: var(--color-card) !important;
}

.dark-mode .card-footer {
    background: var(--color-card) !important;
    border-top-color: var(--color-border) !important;
}

/* ============================================================
   ALERTAS
   ============================================================ */
.alert {
    border-radius: var(--radius-sm);
    border: none;
    padding: 1rem 1.25rem;
}

.alert-success {
    background: rgba(40, 167, 69, 0.15) !important;
    color: #155724 !important;
    border: 1px solid rgba(40, 167, 69, 0.3) !important;
}

.alert-info {
    background: rgba(23, 162, 184, 0.15) !important;
    color: #0c5460 !important;
    border: 1px solid rgba(23, 162, 184, 0.3) !important;
}

.alert-warning {
    background: rgba(255, 193, 7, 0.15) !important;
    color: #856404 !important;
    border: 1px solid rgba(255, 193, 7, 0.3) !important;
}

.alert-danger {
    background: rgba(220, 53, 69, 0.15) !important;
    color: #721c24 !important;
    border: 1px solid rgba(220, 53, 69, 0.3) !important;
}

.dark-mode .alert-success {
    background: rgba(40, 167, 69, 0.15) !important;
    color: #7FD99A !important;
    border-color: rgba(40, 167, 69, 0.3) !important;
}

.dark-mode .alert-success strong,
.dark-mode .alert-success i {
    color: #7FD99A !important;
}

.dark-mode .alert-info {
    background: rgba(23, 162, 184, 0.15) !important;
    color: #7FD4E6 !important;
    border-color: rgba(23, 162, 184, 0.3) !important;
}

.dark-mode .alert-warning {
    background: rgba(255, 193, 7, 0.15) !important;
    color: #FFE066 !important;
    border-color: rgba(255, 193, 7, 0.3) !important;
}

.dark-mode .alert-danger {
    background: rgba(220, 53, 69, 0.15) !important;
    color: #F5A3AB !important;
    border-color: rgba(220, 53, 69, 0.3) !important;
}

.dark-mode .alert a {
    color: var(--color-accent) !important;
}

/* ============================================================
   FORMULARIOS
   ============================================================ */
.form-control,
.form-select,
input:not([type="checkbox"]):not([type="radio"]),
select,
textarea {
    background: var(--color-card) !important;
    color: var(--color-text) !important;
    border: 1px solid var(--color-border) !important;
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    transition: border-color var(--transition), box-shadow var(--transition);
}

.form-control:focus,
.form-select:focus,
input:focus,
select:focus,
textarea:focus {
    border-color: var(--color-primary) !important;
    box-shadow: 0 0 0 3px rgba(33, 50, 74, 0.15) !important;
    outline: none;
}

.form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-text) !important;
}

.dark-mode .form-control,
.dark-mode .form-select,
.dark-mode input:not([type="checkbox"]):not([type="radio"]),
.dark-mode select,
.dark-mode textarea {
    background: #0D1117 !important;
    border-color: var(--color-border) !important;
    color: var(--color-text) !important;
}

.dark-mode .form-control:focus,
.dark-mode .form-select:focus {
    border-color: var(--color-accent) !important;
    box-shadow: 0 0 0 3px rgba(79, 123, 234, 0.2) !important;
}

.dark-mode ::placeholder {
    color: var(--color-text-sec) !important;
    opacity: 0.7;
}

/* Password Toggle */
.password-wrapper {
    position: relative;
}

.password-input {
    padding-right: 3.5rem;
}

.password-toggle {
    position: absolute;
    right: 0.6rem;
    top: 50%;
    transform: translateY(-50%);
    background: transparent !important;
    border: none !important;
    padding: 0.25rem;
    cursor: pointer;
    color: var(--color-text-sec);
    border-radius: 999px;
}

.password-toggle:hover {
    color: var(--color-primary);
}

.dark-mode .password-toggle {
    color: var(--color-text-sec) !important;
}

.dark-mode .password-toggle:hover {
    color: var(--color-accent) !important;
}

/* ============================================================
   TABLAS
   ============================================================ */
.table {
    width: 100%;
    background: var(--color-card) !important;
    border-collapse: collapse;
    margin-bottom: 0;
}

.table th,
.table td {
    padding: 1rem;
    border-bottom: 1px solid var(--color-border) !important;
    text-align: left;
    vertical-align: middle;
    color: var(--color-text) !important;
    background: var(--color-card) !important;
}

.table thead th {
    background: rgba(0, 0, 0, 0.02) !important;
    font-weight: 600;
    color: var(--color-text) !important;
    border-bottom: 2px solid var(--color-border) !important;
}

.table tbody tr {
    background: var(--color-card) !important;
}

.table-hover tbody tr:hover {
    background: rgba(0, 0, 0, 0.02) !important;
}

.table-responsive {
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--color-card) !important;
}

/* MODO OSCURO - Tablas */
.dark-mode .table {
    background: var(--color-card) !important;
}

.dark-mode .table th,
.dark-mode .table td {
    color: var(--color-text) !important;
    background: var(--color-card) !important;
    border-bottom-color: var(--color-border) !important;
}

.dark-mode .table thead th {
    background: rgba(255, 255, 255, 0.03) !important;
    color: var(--color-text) !important;
    border-bottom-color: var(--color-border) !important;
}

.dark-mode .table tbody tr {
    background: var(--color-card) !important;
}

.dark-mode .table-hover tbody tr:hover {
    background: rgba(255, 255, 255, 0.03) !important;
}

.dark-mode .table-hover tbody tr:hover td {
    background: rgba(255, 255, 255, 0.03) !important;
}

.dark-mode .table-responsive {
    background: var(--color-card) !important;
}

/* ============================================================
   PRODUCTOS - CARDS
   ============================================================ */
.product-card {
    position: relative;
    transition: all var(--transition);
}

.product-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg);
}

.product-image-container {
    position: relative;
    background: var(--color-bg) !important;
    padding: 1rem;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.product-card img {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    transition: transform var(--transition);
}

.product-card:hover img {
    transform: scale(1.05);
}

.product-placeholder {
    color: var(--color-text-sec) !important;
    opacity: 0.5;
}

.price,
.product-price {
    font-size: 1.5rem;
    color: var(--color-primary) !important;
    font-weight: 700;
}

/* MODO OSCURO - Productos */
.dark-mode .product-image-container {
    background: #0D1117 !important;
}

.dark-mode .product-placeholder {
    color: var(--color-text-sec) !important;
}

.dark-mode .price,
.dark-mode .product-price {
    color: var(--color-accent) !important;
}

/* ============================================================
   WISHLIST - FONDO NEGRO PARA IMÁGENES
   ============================================================ */
.dark-mode .wishlist .product-image-container,
.dark-mode .wishlist .card-img-top,
.dark-mode [class*="wishlist"] .product-image-container,
.dark-mode .wishlist-item img,
.dark-mode .wishlist .card img {
    background: #000000 !important;
}

.dark-mode .wishlist .product-placeholder,
.dark-mode .wishlist .fa-image,
.dark-mode [class*="wishlist"] .text-muted.fa-image,
.dark-mode .wishlist i.fa-image {
    background: #000000 !important;
    color: #444 !important;
}

.dark-mode .wishlist .text-center.p-4,
.dark-mode .wishlist .card .text-center {
    background: #000000 !important;
}

/* Botón Wishlist */
.btn-wishlist {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95) !important;
    border: none !important;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition);
    z-index: 10;
    box-shadow: var(--shadow-sm);
}

.btn-wishlist i {
    color: var(--color-danger) !important;
    font-size: 1.1rem;
}

.btn-wishlist:hover {
    background: var(--color-danger) !important;
    transform: scale(1.1);
}

.btn-wishlist:hover i {
    color: #fff !important;
}

.dark-mode .btn-wishlist {
    background: rgba(13, 17, 23, 0.95) !important;
}

.dark-mode .btn-wishlist i {
    color: #ff6b6b !important;
}

/* ============================================================
   SIDEBAR CATEGORÍAS - EFECTO GLOW
   ============================================================ */
.list-group-item {
    background: var(--color-card) !important;
    color: var(--color-text) !important;
    border: 2px solid transparent !important;
    border-bottom: 1px solid var(--color-border) !important;
    transition: all var(--transition);
    position: relative;
}

.list-group-item:hover {
    background: var(--color-card) !important;
    border-color: var(--color-primary) !important;
    box-shadow: 0 0 10px rgba(33, 50, 74, 0.3), inset 0 0 0 1px var(--color-primary);
}

/* Estilo activo con efecto glow */
.list-group-item.active {
    background: var(--color-card) !important;
    border: 2px solid var(--color-primary) !important;
    color: var(--color-primary) !important;
    box-shadow: 0 0 15px rgba(33, 50, 74, 0.4), inset 0 0 0 1px var(--color-primary);
}

.list-group-item.active i,
.list-group-item.active span {
    color: var(--color-primary) !important;
}

.dark-mode .list-group-item {
    background: var(--color-card) !important;
    color: var(--color-text) !important;
    border-bottom-color: var(--color-border) !important;
}

.dark-mode .list-group-item:hover {
    border-color: var(--color-accent) !important;
    box-shadow: 0 0 15px rgba(79, 123, 234, 0.3), inset 0 0 0 1px var(--color-accent);
}

.dark-mode .list-group-item.active {
    background: var(--color-card) !important;
    border: 2px solid var(--color-accent) !important;
    color: var(--color-accent) !important;
    box-shadow: 0 0 20px rgba(79, 123, 234, 0.4), inset 0 0 0 1px var(--color-accent);
}

.dark-mode .list-group-item.active i,
.dark-mode .list-group-item.active span {
    color: var(--color-accent) !important;
}

/* ============================================================
   BREADCRUMB
   ============================================================ */
.breadcrumb {
    background: var(--color-card) !important;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border) !important;
}

.breadcrumb-item a {
    color: var(--color-primary) !important;
}

.breadcrumb-item.active {
    color: var(--color-text-sec) !important;
}

.dark-mode .breadcrumb {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .breadcrumb-item a {
    color: var(--color-accent) !important;
}

/* ============================================================
   CARRITO
   ============================================================ */
.cart-summary {
    background: var(--color-card) !important;
    border-radius: var(--radius-md);
    padding: 1.5rem;
    border: 1px solid var(--color-border) !important;
}

.cart-summary * {
    color: var(--color-text) !important;
}

.dark-mode .cart-summary {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .table tbody tr td {
    background: var(--color-card) !important;
    color: var(--color-text) !important;
}

.dark-mode .table td small,
.dark-mode .table td .text-muted {
    color: var(--color-text-sec) !important;
}

.quantity-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 1px solid var(--color-border) !important;
    background: var(--color-card) !important;
    color: var(--color-text) !important;
    transition: all var(--transition);
}

.quantity-btn:hover:not(:disabled) {
    background: var(--color-primary) !important;
    color: #fff !important;
    border-color: var(--color-primary) !important;
}

.dark-mode .quantity-btn {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
    color: var(--color-text) !important;
}

.dark-mode .quantity-btn:hover:not(:disabled) {
    background: var(--color-accent) !important;
    border-color: var(--color-accent) !important;
    color: #fff !important;
}

.quantity-input {
    width: 60px;
    text-align: center;
}

/* ============================================================
   BADGES
   ============================================================ */
.badge {
    padding: 0.4em 0.7em;
    font-size: 0.8rem;
    font-weight: 600;
    border-radius: 6px;
}

.badge-available,
.bg-success {
    background: var(--color-success) !important;
    color: #fff !important;
}

.badge-unavailable,
.bg-danger {
    background: var(--color-danger) !important;
    color: #fff !important;
}

.bg-warning {
    background: var(--color-warning) !important;
    color: #000 !important;
}

.bg-info {
    background: var(--color-info) !important;
    color: #fff !important;
}

.bg-secondary {
    background: #6c757d !important;
    color: #fff !important;
}

.bg-primary {
    background: var(--color-primary) !important;
    color: #fff !important;
}

/* ============================================================
   WALLET
   ============================================================ */
.wallet-header {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%) !important;
    color: #fff !important;
    border-radius: var(--radius-lg);
    padding: 2rem;
}

/* ✅ CORREGIDO: Textos en wallet header deben ser blancos */
.wallet-header *,
.wallet-header h1,
.wallet-header h2,
.wallet-header h3,
.wallet-header h4,
.wallet-header h5,
.wallet-header p,
.wallet-header span,
.wallet-header small,
.wallet-header .lead,
.wallet-header .text-muted {
    color: #fff !important;
}

.wallet-header .text-muted,
.wallet-header p.lead,
.wallet-header small {
    color: rgba(255, 255, 255, 0.85) !important;
}

.wallet-balance {
    font-size: 3rem;
    font-weight: 700;
    color: #fff !important;
}

.recarga-option {
    background: var(--color-card) !important;
    border: 2px solid var(--color-border) !important;
    border-radius: var(--radius-sm);
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
    color: var(--color-text) !important;
}

.recarga-option:hover {
    border-color: var(--color-primary) !important;
}

.recarga-option.selected {
    border-color: var(--color-primary) !important;
    background: var(--color-primary) !important;
    color: #fff !important;
}

/* ✅ CORREGIDO: Texto de límites en wallet */
.wallet-card .card-body p,
.wallet-card .card-body small,
.wallet-card .text-muted,
.limites-info,
.limites-info * {
    color: var(--color-text-sec) !important;
}

.dark-mode .wallet-card .card-body p,
.dark-mode .wallet-card .card-body small,
.dark-mode .wallet-card .text-muted {
    color: var(--color-text-sec) !important;
}

.dark-mode .recarga-option {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
    color: var(--color-text) !important;
}

.dark-mode .recarga-option:hover {
    border-color: var(--color-accent) !important;
}

.dark-mode .recarga-option.selected {
    background: var(--color-accent) !important;
    border-color: var(--color-accent) !important;
    color: #fff !important;
}

.transaccion-item {
    background: var(--color-bg) !important;
    border-left: 4px solid var(--color-primary) !important;
    padding: 1rem;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    margin-bottom: 0.75rem;
}

.dark-mode .transaccion-item {
    background: rgba(255, 255, 255, 0.02) !important;
    border-left-color: var(--color-accent) !important;
}

.limites-info {
    background: var(--color-bg) !important;
    border-radius: var(--radius-sm);
    padding: 1rem;
}

.dark-mode .limites-info {
    background: rgba(255, 255, 255, 0.02) !important;
    color: var(--color-text-sec) !important;
}

.dark-mode .limites-info * {
    color: var(--color-text-sec) !important;
}

/* ============================================================
   HISTORIAL - DETALLES DE PRODUCTOS
   ============================================================ */
/* ✅ CORREGIDO: Texto de productos en historial */
.dark-mode .pedido-detalles,
.dark-mode .pedido-detalles *,
.dark-mode .detalles-producto,
.dark-mode .detalles-producto *,
.dark-mode .list-unstyled li,
.dark-mode .list-unstyled li *,
.dark-mode .pedido-item small,
.dark-mode ul.list-unstyled li {
    color: var(--color-text) !important;
}

/* Específico para "3x Producto ID: 7 - $230.00 c/u" */
.dark-mode .accordion-body li,
.dark-mode .accordion-body small,
.dark-mode .collapse li,
.dark-mode .collapse small,
.dark-mode [class*="detalle"] li,
.dark-mode [class*="detalle"] small {
    color: var(--color-text) !important;
}

.dark-mode .accordion-body .text-muted,
.dark-mode .collapse .text-muted {
    color: var(--color-text-sec) !important;
}

/* ============================================================
   ADMIN - ESTADÍSTICAS Y MÉTRICAS
   ============================================================ */

/* Tarjetas de estadísticas */
.stat-card,
.card.border-0.text-center {
    background: var(--color-card) !important;
    border: 1px solid var(--color-border) !important;
}

.stat-card .card-body,
.card.border-0.text-center .card-body {
    background: var(--color-card) !important;
}

.stat-icon,
.card.border-0.text-center i.fa-3x,
.card.border-0.text-center i.fa-2x {
    color: var(--color-primary) !important;
}

.stat-number,
.card.border-0.text-center h3 {
    color: var(--color-text) !important;
}

.stat-label,
.card.border-0.text-center p {
    color: var(--color-text-sec) !important;
}

/* MODO OSCURO - Estadísticas */
.dark-mode .stat-card,
.dark-mode .card.border-0.text-center {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .stat-icon,
.dark-mode .card.border-0.text-center i.fa-3x,
.dark-mode .card.border-0.text-center i.fa-2x {
    color: var(--color-accent) !important;
}

.dark-mode .stat-number,
.dark-mode .card.border-0.text-center h3 {
    color: var(--color-text) !important;
}

/* ============================================================
   ADMIN USUARIO - ESTADO DEL CARRITO Y HISTORIAL
   ============================================================ */
/* ✅ CORREGIDO: Cards de métricas de usuario */
.dark-mode .row .col-md-3 .card,
.dark-mode .row .col-md-4 .card,
.dark-mode .row .col-md-6 .card,
.dark-mode .row .col-lg-3 .card,
.dark-mode .row .col-lg-4 .card,
.dark-mode .row .col-lg-6 .card {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
}

/* Métricas inline como "Productos en Carrito Actual" */
.dark-mode .border.rounded,
.dark-mode .p-3.border.rounded,
.dark-mode .p-4.border.rounded,
.dark-mode .mb-3.p-3,
.dark-mode .mb-4.p-3,
.dark-mode [class*="metric"],
.dark-mode [class*="stat"] {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .border.rounded *,
.dark-mode .p-3.border.rounded *,
.dark-mode .p-4.border.rounded * {
    color: var(--color-text) !important;
}

.dark-mode .border.rounded .text-muted,
.dark-mode .p-3.border.rounded .text-muted {
    color: var(--color-text-sec) !important;
}

/* Historial de actividad en carrito */
.dark-mode .list-group .list-group-item,
.dark-mode .historial-item,
.dark-mode .activity-item {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
    color: var(--color-text) !important;
}

.dark-mode .list-group .list-group-item * {
    color: var(--color-text) !important;
}

.dark-mode .list-group .list-group-item .text-muted,
.dark-mode .list-group .list-group-item small {
    color: var(--color-text-sec) !important;
}

/* Items de pedidos */
.pedido-item,
.border.rounded,
.p-3.border.rounded {
    background: var(--color-bg) !important;
    border: 1px solid var(--color-border) !important;
    border-radius: var(--radius-sm) !important;
}

.dark-mode .pedido-item,
.dark-mode .border.rounded:not(.list-group-item),
.dark-mode .p-3.border.rounded {
    background: rgba(255, 255, 255, 0.02) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .pedido-item *,
.dark-mode .border.rounded *,
.dark-mode .p-3.border.rounded * {
    color: var(--color-text) !important;
}

.dark-mode .pedido-item .text-muted,
.dark-mode .border.rounded .text-muted {
    color: var(--color-text-sec) !important;
}

/* ============================================================
   ADMIN CATEGORÍAS - TABLAS DE SUBCATEGORÍAS
   ============================================================ */
/* ✅ CORREGIDO: Tablas anidadas y botones */
.dark-mode .table-sm,
.dark-mode .table-sm th,
.dark-mode .table-sm td {
    background: var(--color-card) !important;
    color: var(--color-text) !important;
    border-color: var(--color-border) !important;
}

/* Evitar esquinas cortadas */
.dark-mode .table-responsive {
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--color-border) !important;
}

.dark-mode .card .table-responsive {
    border: none !important;
    border-radius: 0;
}

/* Botón editar en categorías */
.dark-mode .btn-sm.btn-warning,
.dark-mode .btn-warning.btn-sm {
    background: var(--color-warning) !important;
    color: #000 !important;
    border-color: var(--color-warning) !important;
}

.dark-mode .btn-sm.btn-warning i {
    color: #000 !important;
}

/* Botón outline info para editar */
.dark-mode .btn-outline-info {
    border-color: var(--color-info) !important;
    color: var(--color-info) !important;
    background: transparent !important;
}

.dark-mode .btn-outline-info:hover {
    background: var(--color-info) !important;
    color: #fff !important;
}

/* ============================================================
   ADMIN - PÁGINAS GENERALES
   ============================================================ */
.dark-mode .container,
.dark-mode .container-fluid {
    color: var(--color-text) !important;
}

.dark-mode .bg-white,
.dark-mode .bg-light {
    background: var(--color-card) !important;
}

.dark-mode .text-dark {
    color: var(--color-text) !important;
}

.dark-mode .text-muted {
    color: var(--color-text-sec) !important;
}

.dark-mode .text-primary {
    color: var(--color-accent) !important;
}

.dark-mode a:not(.btn):not(.nav-link):not(.dropdown-item):not(.list-group-item) {
    color: var(--color-accent) !important;
}

.dark-mode .display-1,
.dark-mode .display-2,
.dark-mode .display-3,
.dark-mode .display-4,
.dark-mode .display-5,
.dark-mode .display-6 {
    color: var(--color-text) !important;
}

.dark-mode .lead {
    color: var(--color-text-sec) !important;
}

/* ============================================================
   ANALYTICS ESPECÍFICO
   ============================================================ */
.dark-mode .row .col-md-3 .card *,
.dark-mode .row .col-md-4 .card *,
.dark-mode .row .col-lg-3 .card *,
.dark-mode .row .col-lg-4 .card * {
    color: var(--color-text) !important;
}

.dark-mode .row .col-md-3 .card i,
.dark-mode .row .col-md-4 .card i,
.dark-mode .row .col-lg-3 .card i,
.dark-mode .row .col-lg-4 .card i {
    color: var(--color-accent) !important;
}

/* ============================================================
   FOOTER
   ============================================================ */
footer {
    margin-top: 4rem;
    padding: 2rem;
    text-align: center;
    background: var(--color-primary) !important;
    border-top: 1px solid var(--color-border);
    color: #ffffff !important;
}

footer a,
footer p,
footer small,
footer * {
    color: rgba(255, 255, 255, 0.9) !important;
}

footer a:hover {
    color: #fff !important;
}

.dark-mode footer {
    background: #11151C !important;
    border-top-color: var(--color-border) !important;
}

.dark-mode footer a,
.dark-mode footer p,
.dark-mode footer small,
.dark-mode footer * {
    color: var(--color-text-sec) !important;
}

/* ============================================================
   ICONOS
   ============================================================ */
.dark-mode i,
.dark-mode .fa,
.dark-mode .fas,
.dark-mode .far,
.dark-mode .fab {
    color: var(--color-text) !important;
}

.dark-mode .navbar-custom i,
.dark-mode .nav-link i {
    color: #ffffff !important;
}

.dark-mode .btn-primary i,
.dark-mode .btn-success i,
.dark-mode .btn-danger i,
.dark-mode .btn-info i {
    color: #fff !important;
}

.dark-mode .btn-warning i {
    color: #000 !important;
}

.dark-mode .card-header i {
    color: #fff !important;
}

/* ============================================================
   PAGINACIÓN
   ============================================================ */
.pagination .page-link {
    background: var(--color-card) !important;
    color: var(--color-text) !important;
    border-color: var(--color-border) !important;
}

.pagination .page-item.active .page-link {
    background: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
    color: #fff !important;
}

.dark-mode .pagination .page-link {
    background: var(--color-card) !important;
    color: var(--color-text) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .pagination .page-item.active .page-link {
    background: var(--color-accent) !important;
    border-color: var(--color-accent) !important;
}

.dark-mode .pagination .page-link:hover {
    background: rgba(255, 255, 255, 0.05) !important;
}

/* ============================================================
   MODAL
   ============================================================ */
.modal-content {
    background: var(--color-card) !important;
    border: 1px solid var(--color-border) !important;
    border-radius: var(--radius-lg);
}

.modal-header {
    border-bottom-color: var(--color-border) !important;
}

.modal-footer {
    border-top-color: var(--color-border) !important;
}

.dark-mode .modal-content {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .modal-title {
    color: var(--color-text) !important;
}

.dark-mode .btn-close {
    filter: invert(1);
}

/* ============================================================
   UTILIDADES
   ============================================================ */
.dark-mode .border {
    border-color: var(--color-border) !important;
}

.dark-mode .shadow,
.dark-mode .shadow-sm,
.dark-mode .shadow-lg {
    box-shadow: var(--shadow-md) !important;
}

.hover-lift {
    transition: transform var(--transition);
}

.hover-lift:hover {
    transform: translateY(-5px);
}

/* ============================================================
   ANIMACIONES
   ============================================================ */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 0.8s ease-in-out infinite;
}

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 768px) {
    .navbar-custom {
        padding: 0.5rem 1rem;
    }
    
    img.navbar-logo {
        width: 50px !important;
        max-height: 50px !important;
    }
    
    .wallet-balance {
        font-size: 2rem;
    }
    
    .dropdown-menu {
        min-width: 180px !important;
    }
    
    .product-card:hover {
        transform: none;
    }
}

@media (max-width: 576px) {
    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .table td, .table th {
        padding: 0.5rem;
        font-size: 0.85rem;
    }
}

/* ============================================================
 *  AUTOCOMPLETE / BÚSQUEDA EN TIEMPO REAL - FIX Z-INDEX
 *  ============================================================ */
.autocomplete-wrapper {
    position: relative;
}

.autocomplete-results,
.search-results,
.autocomplete-list,
#search-autocomplete-list,
[id*="autocomplete"] {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 9999 !important;
    background: var(--color-card) !important;
    border: 1px solid var(--color-border) !important;
    border-radius: 0 0 var(--radius-sm) var(--radius-sm) !important;
    box-shadow: var(--shadow-lg) !important;
    max-height: 300px !important;
    overflow-y: auto !important;
}

.autocomplete-results .autocomplete-item,
.search-results .search-item,
.autocomplete-list li,
[id*="autocomplete"] li {
    padding: 0.75rem 1rem !important;
    cursor: pointer !important;
    border-bottom: 1px solid var(--color-border) !important;
    display: flex !important;
    align-items: center !important;
    gap: 0.75rem !important;
    color: var(--color-text) !important;
    background: var(--color-card) !important;
}

.autocomplete-results .autocomplete-item:hover,
.search-results .search-item:hover,
.autocomplete-list li:hover,
[id*="autocomplete"] li:hover {
    background: rgba(0, 0, 0, 0.05) !important;
}

.autocomplete-results .autocomplete-item:last-child,
.autocomplete-list li:last-child {
    border-bottom: none !important;
}

.autocomplete-results .autocomplete-item img,
.search-results .search-item img {
    width: 40px !important;
    height: 40px !important;
    object-fit: contain !important;
    border-radius: 4px !important;
    background: var(--color-bg) !important;
}

.autocomplete-results .autocomplete-item .item-info {
    flex: 1;
}

.autocomplete-results .autocomplete-item .item-name {
    font-weight: 600;
    color: var(--color-text);
}

.autocomplete-results .autocomplete-item .item-price {
    font-size: 0.9rem;
    color: var(--color-primary);
    font-weight: 700;
}

.autocomplete-results .autocomplete-item .item-category {
    font-size: 0.8rem;
    color: var(--color-text-sec);
}

/* Modo oscuro */
.dark-mode .autocomplete-results,
.dark-mode .search-results,
.dark-mode .autocomplete-list,
.dark-mode [id*="autocomplete"] {
    background: var(--color-card) !important;
    border-color: var(--color-border) !important;
}

.dark-mode .autocomplete-results .autocomplete-item,
.dark-mode .search-results .search-item,
.dark-mode .autocomplete-list li,
.dark-mode [id*="autocomplete"] li {
    color: var(--color-text) !important;
    background: var(--color-card) !important;
    border-bottom-color: var(--color-border) !important;
}

.dark-mode .autocomplete-results .autocomplete-item:hover,
.dark-mode .search-results .search-item:hover,
.dark-mode .autocomplete-list li:hover,
.dark-mode [id*="autocomplete"] li:hover {
    background: rgba(255, 255, 255, 0.05) !important;
}

.dark-mode .autocomplete-results .autocomplete-item .item-price {
    color: var(--color-accent);
}

--- Archivo: ./jsmain.js ---
let cartCount = 0;


function addToCart() {
cartCount++;
document.getElementById("cart-count").innerText = cartCount;
}


--- Archivo: ./app.py ---
from flask import Flask, render_template, request, redirect, url_for, flash, session, jsonify, Response, stream_with_context, make_response
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
from functools import wraps
from datetime import datetime, timedelta
import pymysql
import os
import time
import json
import csv
from io import StringIO
from queue import Queue, Empty
from threading import Lock
from werkzeug.utils import secure_filename

pymysql.install_as_MySQLdb()

app = Flask(__name__)
app.config['SECRET_KEY'] = 'tu-clave-secreta-aqui-cambiala'

# Configuración de MySQL/MariaDB
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://root:321@localhost:3306/axion_store?charset=utf8mb4'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

# Opciones optimizadas para laptop
app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {
    'pool_pre_ping': True,
    'pool_recycle': 3600,
    'pool_size': 5,
    'max_overflow': 10,
    'connect_args': {
        'connect_timeout': 60,
        'charset': 'utf8mb4'
    }
}

db = SQLAlchemy(app)

# --------------------
# Real-time notifications (SSE) - in-memory queues
# --------------------
_notif_queues = {}
_notif_lock = Lock()

def _get_queue_for_user(user_id):
    with _notif_lock:
        q = _notif_queues.get(user_id)
        if q is None:
            q = Queue()
            _notif_queues[user_id] = q
        return q

def notify_user(user_id, message):
    """Push a notification message to a user's queue (non-blocking)."""
    try:
        q = _get_queue_for_user(user_id)
        q.put(message)
    except Exception as e:
        app.logger.error(f'notify_user error: {e}')

# Configuración de uploads
app.config['UPLOAD_FOLDER'] = os.path.join(app.static_folder, 'img')
app.config['MAX_CONTENT_LENGTH'] = 2 * 1024 * 1024  # 2 MB
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'webp'}

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

# ==================== CONSTANTES DE VALIDACIÓN ====================

class ValidationLimits:
    MIN_NOMBRE_LENGTH = 3
    MIN_PASSWORD_LENGTH = 6
    MAX_RECARGA = 10000
    MIN_RECARGA = 1

# ==================== MODELOS DE BASE DE DATOS ====================

class Usuario(db.Model):
    __tablename__ = 'users'
    ID_Users = db.Column(db.Integer, primary_key=True)
    nombre = db.Column(db.String(100), nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password = db.Column(db.String(200), nullable=False)
    fecha_registro = db.Column(db.DateTime, default=datetime.utcnow)
    es_admin = db.Column(db.Boolean, default=False)

    # === MÉTRICAS DE COMPRAS ===
    total_compras = db.Column(db.Integer, default=0)
    total_gastado = db.Column(db.Float, default=0.0)
    ticket_promedio = db.Column(db.Float, default=0.0)
    ultimo_pedido_fecha = db.Column(db.DateTime)
    dias_desde_ultima_compra = db.Column(db.Integer)

    # === MÉTRICAS DE WALLET ===
    total_recargas = db.Column(db.Integer, default=0)
    dinero_recargado_total = db.Column(db.Float, default=0.0)
    recarga_promedio = db.Column(db.Float, default=0.0)
    ultima_recarga_fecha = db.Column(db.DateTime)

    # === MÉTRICAS DE CARRITO ===
    productos_carrito_actual = db.Column(db.Integer, default=0)
    valor_carrito_actual = db.Column(db.Float, default=0.0)
    productos_agregados_carrito_total = db.Column(db.Integer, default=0)
    carritos_abandonados = db.Column(db.Integer, default=0)

    # === MÉTRICAS DE CONVERSIÓN ===
    tasa_conversion = db.Column(db.Float, default=0.0)

    # === SEGMENTACIÓN (SIN VIP) ===
    segmento_cliente = db.Column(db.String(50), default='nuevo')  # valores: nuevo, activo, inactivo
    ultima_actividad = db.Column(db.DateTime, default=datetime.utcnow)

    # Relaciones
    wallet = db.relationship('Wallet', backref='usuario', uselist=False)
    pedidos = db.relationship('Pedido', backref='usuario', lazy=True)
    carritos = db.relationship('Carrito', backref='usuario', lazy=True)


class Producto(db.Model):
    __tablename__ = 'producto'
    ID_Producto = db.Column(db.Integer, primary_key=True)
    nombre = db.Column(db.String(200), nullable=False, index=True)
    precio = db.Column(db.Float, nullable=False)
    imagen = db.Column(db.String(300))
    disponible = db.Column(db.Boolean, default=True)
    stock = db.Column(db.Integer, default=0)
    ID_Subcategoria = db.Column(db.Integer, db.ForeignKey('subcategoria.ID_Subcategoria'), index=True)
    ID_Categoria = db.Column(db.Integer, db.ForeignKey('categoria.ID_Categoria'), index=True)


class Categoria(db.Model):
    __tablename__ = 'categoria'
    ID_Categoria = db.Column(db.Integer, primary_key=True)
    nombre = db.Column(db.String(100), unique=True, nullable=False, index=True)
    descripcion = db.Column(db.Text)
    icono = db.Column(db.String(50))
    activa = db.Column(db.Boolean, default=True, index=True)
    orden = db.Column(db.Integer, default=0, index=True)
    fecha_creacion = db.Column(db.DateTime, default=datetime.utcnow)

    subcategorias = db.relationship('Subcategoria', backref='categoria', lazy=True, cascade='all, delete-orphan')
    productos = db.relationship('Producto', backref='categoria', lazy=True)


class Subcategoria(db.Model):
    __tablename__ = 'subcategoria'
    ID_Subcategoria = db.Column(db.Integer, primary_key=True)
    ID_Categoria = db.Column(db.Integer, db.ForeignKey('categoria.ID_Categoria'), nullable=False, index=True)
    nombre = db.Column(db.String(100), nullable=False, index=True)
    descripcion = db.Column(db.Text)
    activa = db.Column(db.Boolean, default=True, index=True)
    orden = db.Column(db.Integer, default=0)
    fecha_creacion = db.Column(db.DateTime, default=datetime.utcnow)

    productos = db.relationship('Producto', backref='subcategoria', lazy=True)

    def to_dict(self):
        """Convierte el objeto a diccionario serializable para JSON"""
        return {
            'ID_Subcategoria': self.ID_Subcategoria,
            'nombre': self.nombre,
            'descripcion': self.descripcion or '',
            'activa': self.activa,
            'orden': self.orden
        }


class MetricaCategoria(db.Model):
    __tablename__ = 'metricas_categoria'
    ID_Metrica = db.Column(db.Integer, primary_key=True)
    ID_Categoria = db.Column(db.Integer, db.ForeignKey('categoria.ID_Categoria'), nullable=False, unique=True, index=True)

    total_productos_vendidos = db.Column(db.Integer, default=0)
    total_pedidos = db.Column(db.Integer, default=0)
    ingresos_totales = db.Column(db.Float, default=0.0)
    ticket_promedio = db.Column(db.Float, default=0.0)

    total_agregados_carrito = db.Column(db.Integer, default=0)
    total_abandonos = db.Column(db.Integer, default=0)
    valor_abandonos = db.Column(db.Float, default=0.0)

    tasa_conversion = db.Column(db.Float, default=0.0)

    productos_activos = db.Column(db.Integer, default=0)
    productos_sin_stock = db.Column(db.Integer, default=0)

    ultima_actualizacion = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    categoria = db.relationship('Categoria', backref=db.backref('metricas', uselist=False))


class MetricaSubcategoria(db.Model):
    __tablename__ = 'metricas_subcategoria'
    ID_Metrica = db.Column(db.Integer, primary_key=True)
    ID_Subcategoria = db.Column(db.Integer, db.ForeignKey('subcategoria.ID_Subcategoria'), nullable=False, unique=True, index=True)
    ID_Categoria = db.Column(db.Integer, db.ForeignKey('categoria.ID_Categoria'), nullable=False, index=True)

    total_productos_vendidos = db.Column(db.Integer, default=0)
    total_pedidos = db.Column(db.Integer, default=0)
    ingresos_totales = db.Column(db.Float, default=0.0)
    ticket_promedio = db.Column(db.Float, default=0.0)

    total_agregados_carrito = db.Column(db.Integer, default=0)
    total_abandonos = db.Column(db.Integer, default=0)
    valor_abandonos = db.Column(db.Float, default=0.0)

    tasa_conversion = db.Column(db.Float, default=0.0)

    productos_activos = db.Column(db.Integer, default=0)
    productos_sin_stock = db.Column(db.Integer, default=0)

    ultima_actualizacion = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    subcategoria = db.relationship('Subcategoria', backref=db.backref('metricas', uselist=False))
    categoria = db.relationship('Categoria')


class Wallet(db.Model):
    __tablename__ = 'wallet'
    ID_Wallet = db.Column(db.Integer, primary_key=True)
    ID_Users = db.Column(db.Integer, db.ForeignKey('users.ID_Users'), nullable=False, index=True)
    saldo = db.Column(db.Float, default=50.0)


class Carrito(db.Model):
    __tablename__ = 'carrito'
    ID_Carrito = db.Column(db.Integer, primary_key=True)
    ID_Users = db.Column(db.Integer, db.ForeignKey('users.ID_Users'), nullable=False, index=True)
    ID_Producto = db.Column(db.Integer, db.ForeignKey('producto.ID_Producto'), nullable=False, index=True)
    cantidad = db.Column(db.Integer, default=1)
    producto = db.relationship('Producto', backref='carritos')


class Pedido(db.Model):
    __tablename__ = 'pedido'
    ID_Pedido = db.Column(db.Integer, primary_key=True)
    ID_Users = db.Column(db.Integer, db.ForeignKey('users.ID_Users'), nullable=False, index=True)
    total = db.Column(db.Float, nullable=False)
    fecha = db.Column(db.DateTime, default=datetime.utcnow)
    estado = db.Column(db.String(20), default='pagado')
    detalles = db.relationship('DetallePedido', backref='pedido', lazy=True)


class DetallePedido(db.Model):
    __tablename__ = 'detalle_pedido'
    ID_Detalle_Pedido = db.Column(db.Integer, primary_key=True)
    ID_Pedido = db.Column(db.Integer, db.ForeignKey('pedido.ID_Pedido'), nullable=False, index=True)
    ID_Producto = db.Column(db.Integer, db.ForeignKey('producto.ID_Producto'), nullable=False, index=True)
    cantidad = db.Column(db.Integer, nullable=False)
    precio_unitario = db.Column(db.Float, nullable=False)
    producto = db.relationship('Producto', backref='detalles_pedido')


class HistorialCarrito(db.Model):
    __tablename__ = 'historial_carrito'
    ID_Historial = db.Column(db.Integer, primary_key=True)
    ID_Users = db.Column(db.Integer, db.ForeignKey('users.ID_Users'), nullable=False, index=True)
    ID_Producto = db.Column(db.Integer, db.ForeignKey('producto.ID_Producto'), nullable=False, index=True)
    accion = db.Column(db.String(20), nullable=False, index=True)
    cantidad = db.Column(db.Integer, nullable=False)
    precio_momento = db.Column(db.Float, nullable=False)
    valor_total = db.Column(db.Float, nullable=False)
    fecha = db.Column(db.DateTime, default=datetime.utcnow, index=True)
    ID_Pedido = db.Column(db.Integer, db.ForeignKey('pedido.ID_Pedido'))

    usuario = db.relationship('Usuario')
    producto = db.relationship('Producto', backref='historial_carrito')
    pedido = db.relationship('Pedido', backref='items_originales')


class TransaccionWallet(db.Model):
    __tablename__ = 'transacciones_wallet'
    ID_Transaccion = db.Column(db.Integer, primary_key=True)
    ID_Wallet = db.Column(db.Integer, db.ForeignKey('wallet.ID_Wallet'), nullable=False, index=True)
    ID_Users = db.Column(db.Integer, db.ForeignKey('users.ID_Users'), nullable=False, index=True)
    tipo = db.Column(db.String(20), nullable=False, index=True)
    monto = db.Column(db.Float, nullable=False)
    saldo_anterior = db.Column(db.Float, nullable=False)
    saldo_nuevo = db.Column(db.Float, nullable=False)
    descripcion = db.Column(db.String(200))
    ID_Pedido = db.Column(db.Integer, db.ForeignKey('pedido.ID_Pedido'))
    fecha = db.Column(db.DateTime, default=datetime.utcnow, index=True)

    wallet = db.relationship('Wallet', backref='transacciones')
    usuario = db.relationship('Usuario')
    pedido = db.relationship('Pedido')


class Wishlist(db.Model):
    __tablename__ = 'wishlist'
    ID_Wishlist = db.Column(db.Integer, primary_key=True)
    ID_Users = db.Column(db.Integer, db.ForeignKey('users.ID_Users'), nullable=False, index=True)
    ID_Producto = db.Column(db.Integer, db.ForeignKey('producto.ID_Producto'), nullable=False, index=True)
    fecha_agregado = db.Column(db.DateTime, default=datetime.utcnow)

    usuario = db.relationship('Usuario', backref=db.backref('wishlists', lazy=True))
    producto = db.relationship('Producto', backref=db.backref('en_wishlists', lazy=True))

    __table_args__ = (db.UniqueConstraint('ID_Users', 'ID_Producto', name='unique_user_product_wishlist'),)


# ==================== FUNCIÓN PARA CREAR TABLAS ====================

def crear_tablas_db():
    """
    Crea todas las tablas en la base de datos si no existen.
    Compatible con MariaDB/MySQL.
    """
    with app.app_context():
        try:
            # Crear todas las tablas definidas en los modelos
            db.create_all()

            # Verificar y corregir columnas faltantes que pueden causar errores en tiempo de ejecución.
            # Ej: algunos dumps/instalaciones antiguas pueden no contener la columna 'ID_Subcategoria' en 'producto'.
            try:
                # Comprobar existencia de la columna en information_schema
                res = db.session.execute(db.text("""
                    SELECT COUNT(*) AS cnt FROM information_schema.COLUMNS
                    WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'producto' AND COLUMN_NAME = 'ID_Subcategoria'
                """)).fetchone()

                if not res or int(res[0]) == 0:
                    # Agregar la columna como NULLABLE para compatibilidad retroactiva
                    db.session.execute(db.text("ALTER TABLE producto ADD COLUMN ID_Subcategoria INT NULL"))
                    # Agregar índice para mejorar consultas que lo utilicen
                    try:
                        db.session.execute(db.text("ALTER TABLE producto ADD INDEX idx_producto_id_subcategoria (ID_Subcategoria)"))
                    except Exception:
                        # índice puede ya existir en algunos motores
                        pass

                    # Intentar añadir FK si la tabla subcategoria existe
                    tbl = db.session.execute(db.text("SELECT COUNT(*) FROM information_schema.TABLES WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'subcategoria'"))
                    if tbl and int(tbl.fetchone()[0] or 0) > 0:
                        try:
                            db.session.execute(db.text(
                                "ALTER TABLE producto ADD CONSTRAINT fk_producto_subcategoria FOREIGN KEY (ID_Subcategoria) REFERENCES subcategoria(ID_Subcategoria) ON DELETE SET NULL ON UPDATE CASCADE"
                            ))
                        except Exception:
                            # Si no se puede añadir la FK (por permisos o ya existe), continuar sin fallar
                            pass

                    db.session.commit()
                    app.logger.info('Columna faltante ID_Subcategoria añadida a producto')
            except Exception as e:
                # No queremos que una corrección automática impida la creación de tablas; logueamos y continuamos
                db.session.rollback()
                app.logger.warning(f'No se pudo verificar/crear columna ID_Subcategoria automáticamente: {e}')

            print("✓ Tablas verificadas/creadas exitosamente en la base de datos")
            return True
        except Exception as e:
            print(f"✗ Error al crear tablas: {str(e)}")
            app.logger.error(f'Error al crear tablas: {str(e)}')
            return False


def verificar_conexion_db():
    """
    Verifica la conexión a la base de datos y crea las tablas si es necesario.
    """
    with app.app_context():
        try:
            # Intentar ejecutar una consulta simple
            db.session.execute(db.text('SELECT 1'))
            print("✓ Conexión a la base de datos establecida")

            # Crear tablas si no existen
            crear_tablas_db()
            return True
        except Exception as e:
            print(f"✗ Error de conexión a la base de datos: {str(e)}")
            app.logger.error(f'Error de conexión DB: {str(e)}')
            return False


# ==================== FUNCIÓN DE ACTUALIZACIÓN DE MÉTRICAS ====================

def actualizar_metricas_usuario(usuario_id):
    """
    Actualiza TODAS las métricas del usuario de forma eficiente.
    """
    try:
        usuario = Usuario.query.get(usuario_id)
        if not usuario:
            return

        # === MÉTRICAS DE COMPRAS ===
        stats_pedidos = db.session.query(
            db.func.count(Pedido.ID_Pedido).label('total'),
            db.func.sum(Pedido.total).label('gastado'),
            db.func.max(Pedido.fecha).label('ultimo')
        ).filter(Pedido.ID_Users == usuario_id).first()

        usuario.total_compras = stats_pedidos.total or 0
        usuario.total_gastado = float(stats_pedidos.gastado or 0.0)
        usuario.ticket_promedio = (usuario.total_gastado / usuario.total_compras) if usuario.total_compras > 0 else 0.0
        usuario.ultimo_pedido_fecha = stats_pedidos.ultimo

        if usuario.ultimo_pedido_fecha:
            usuario.dias_desde_ultima_compra = (datetime.utcnow() - usuario.ultimo_pedido_fecha).days

        # === MÉTRICAS DE WALLET ===
        stats_recargas = db.session.query(
            db.func.count(TransaccionWallet.ID_Transaccion).label('total'),
            db.func.sum(TransaccionWallet.monto).label('dinero'),
            db.func.max(TransaccionWallet.fecha).label('ultima')
        ).filter(
            TransaccionWallet.ID_Users == usuario_id,
            TransaccionWallet.tipo == 'recarga'
        ).first()

        usuario.total_recargas = stats_recargas.total or 0
        usuario.dinero_recargado_total = float(stats_recargas.dinero or 0.0)
        usuario.recarga_promedio = (usuario.dinero_recargado_total / usuario.total_recargas) if usuario.total_recargas > 0 else 0.0
        usuario.ultima_recarga_fecha = stats_recargas.ultima

        # === MÉTRICAS DE CARRITO ACTUAL ===
        stats_carrito = db.session.query(
            db.func.sum(Carrito.cantidad).label('items'),
            db.func.sum(Carrito.cantidad * Producto.precio).label('valor')
        ).join(Producto).filter(Carrito.ID_Users == usuario_id).first()

        usuario.productos_carrito_actual = int(stats_carrito.items or 0)
        usuario.valor_carrito_actual = float(stats_carrito.valor or 0.0)

        # === MÉTRICAS HISTÓRICAS DE CARRITO ===
        total_agregados = db.session.query(
            db.func.sum(HistorialCarrito.cantidad)
        ).filter(
            HistorialCarrito.ID_Users == usuario_id,
            HistorialCarrito.accion == 'agregar'
        ).scalar() or 0
        usuario.productos_agregados_carrito_total = int(total_agregados)

        total_abandonos = db.session.query(
            db.func.count(db.distinct(db.func.date(HistorialCarrito.fecha)))
        ).filter(
            HistorialCarrito.ID_Users == usuario_id,
            HistorialCarrito.accion == 'abandonar'
        ).scalar() or 0
        usuario.carritos_abandonados = int(total_abandonos)

        # === TASA DE CONVERSIÓN ===
        if usuario.productos_agregados_carrito_total > 0:
            total_comprados = db.session.query(
                db.func.sum(DetallePedido.cantidad)
            ).join(Pedido).filter(Pedido.ID_Users == usuario_id).scalar() or 0
            usuario.tasa_conversion = (total_comprados / usuario.productos_agregados_carrito_total) * 100
        else:
            usuario.tasa_conversion = 0.0

        # === SEGMENTACIÓN AUTOMÁTICA (SIN VIP) ===
        if usuario.total_compras == 0:
            usuario.segmento_cliente = 'nuevo'
        elif usuario.dias_desde_ultima_compra and usuario.dias_desde_ultima_compra > 60:
            usuario.segmento_cliente = 'inactivo'
        else:
            usuario.segmento_cliente = 'activo'

        usuario.ultima_actividad = datetime.utcnow()
        db.session.commit()

    except Exception as e:
        db.session.rollback()
        app.logger.error(f'Error actualizando métricas usuario {usuario_id}: {str(e)}')


# ==================== FUNCIONES DE MÉTRICAS DE CATEGORÍAS ====================

def actualizar_metricas_categoria(categoria_id):
    """Actualiza TODAS las métricas de una categoría específica"""
    try:
        categoria = Categoria.query.get(categoria_id)
        if not categoria:
            return

        metricas = MetricaCategoria.query.filter_by(ID_Categoria=categoria_id).first()
        if not metricas:
            metricas = MetricaCategoria(ID_Categoria=categoria_id)
            db.session.add(metricas)

        # === MÉTRICAS DE VENTAS ===
        ventas_stats = db.session.query(
            db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('total_vendido'),
            db.func.count(db.distinct(Pedido.ID_Pedido)).label('total_pedidos'),
            db.func.coalesce(db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario), 0).label('ingresos')
        ).join(Producto).join(Pedido).filter(
            Producto.ID_Categoria == categoria_id
        ).first()

        metricas.total_productos_vendidos = int(ventas_stats.total_vendido or 0)
        metricas.total_pedidos = int(ventas_stats.total_pedidos or 0)
        metricas.ingresos_totales = float(ventas_stats.ingresos or 0.0)
        metricas.ticket_promedio = (metricas.ingresos_totales / metricas.total_pedidos) if metricas.total_pedidos > 0 else 0.0

        # === MÉTRICAS DE CARRITO ===
        agregados = db.session.query(
            db.func.coalesce(db.func.sum(HistorialCarrito.cantidad), 0)
        ).join(Producto).filter(
            Producto.ID_Categoria == categoria_id,
            HistorialCarrito.accion == 'agregar'
        ).scalar() or 0
        metricas.total_agregados_carrito = int(agregados)

        abandonos_stats = db.session.query(
            db.func.coalesce(db.func.sum(HistorialCarrito.cantidad), 0).label('total'),
            db.func.coalesce(db.func.sum(HistorialCarrito.valor_total), 0).label('valor')
        ).join(Producto).filter(
            Producto.ID_Categoria == categoria_id,
            HistorialCarrito.accion == 'abandonar'
        ).first()

        metricas.total_abandonos = int(abandonos_stats.total or 0)
        metricas.valor_abandonos = float(abandonos_stats.valor or 0.0)

        # === TASA DE CONVERSIÓN ===
        if metricas.total_agregados_carrito > 0:
            metricas.tasa_conversion = (metricas.total_productos_vendidos / metricas.total_agregados_carrito) * 100
        else:
            metricas.tasa_conversion = 0.0

        # === MÉTRICAS DE PRODUCTOS ===
        metricas.productos_activos = Producto.query.filter_by(ID_Categoria=categoria_id, disponible=True).count()
        metricas.productos_sin_stock = Producto.query.filter_by(ID_Categoria=categoria_id, stock=0).count()

        metricas.ultima_actualizacion = datetime.utcnow()
        db.session.commit()

    except Exception as e:
        db.session.rollback()
        app.logger.error(f'Error actualizando métricas categoría {categoria_id}: {str(e)}')


def actualizar_metricas_subcategoria(subcategoria_id):
    """Actualiza métricas de una subcategoría específica"""
    try:
        subcategoria = Subcategoria.query.get(subcategoria_id)
        if not subcategoria:
            return

        metricas = MetricaSubcategoria.query.filter_by(ID_Subcategoria=subcategoria_id).first()
        if not metricas:
            metricas = MetricaSubcategoria(
                ID_Subcategoria=subcategoria_id,
                ID_Categoria=subcategoria.ID_Categoria
            )
            db.session.add(metricas)

        # === MÉTRICAS DE VENTAS ===
        ventas_stats = db.session.query(
            db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('total_vendido'),
            db.func.count(db.distinct(Pedido.ID_Pedido)).label('total_pedidos'),
            db.func.coalesce(db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario), 0).label('ingresos')
        ).join(Producto).join(Pedido).filter(
            Producto.ID_Subcategoria == subcategoria_id
        ).first()

        metricas.total_productos_vendidos = int(ventas_stats.total_vendido or 0)
        metricas.total_pedidos = int(ventas_stats.total_pedidos or 0)
        metricas.ingresos_totales = float(ventas_stats.ingresos or 0.0)
        metricas.ticket_promedio = (metricas.ingresos_totales / metricas.total_pedidos) if metricas.total_pedidos > 0 else 0.0

        # === MÉTRICAS DE CARRITO ===
        agregados = db.session.query(
            db.func.coalesce(db.func.sum(HistorialCarrito.cantidad), 0)
        ).join(Producto).filter(
            Producto.ID_Subcategoria == subcategoria_id,
            HistorialCarrito.accion == 'agregar'
        ).scalar() or 0
        metricas.total_agregados_carrito = int(agregados)

        abandonos_stats = db.session.query(
            db.func.coalesce(db.func.sum(HistorialCarrito.cantidad), 0).label('total'),
            db.func.coalesce(db.func.sum(HistorialCarrito.valor_total), 0).label('valor')
        ).join(Producto).filter(
            Producto.ID_Subcategoria == subcategoria_id,
            HistorialCarrito.accion == 'abandonar'
        ).first()

        metricas.total_abandonos = int(abandonos_stats.total or 0)
        metricas.valor_abandonos = float(abandonos_stats.valor or 0.0)

        # === TASA DE CONVERSIÓN ===
        if metricas.total_agregados_carrito > 0:
            metricas.tasa_conversion = (metricas.total_productos_vendidos / metricas.total_agregados_carrito) * 100
        else:
            metricas.tasa_conversion = 0.0

        # === MÉTRICAS DE PRODUCTOS ===
        metricas.productos_activos = Producto.query.filter_by(ID_Subcategoria=subcategoria_id, disponible=True).count()
        metricas.productos_sin_stock = Producto.query.filter_by(ID_Subcategoria=subcategoria_id, stock=0).count()

        metricas.ultima_actualizacion = datetime.utcnow()
        db.session.commit()

    except Exception as e:
        db.session.rollback()
        app.logger.error(f'Error actualizando métricas subcategoría {subcategoria_id}: {str(e)}')


def actualizar_todas_metricas_categorias():
    """Actualiza métricas de TODAS las categorías y subcategorías"""
    try:
        categorias = Categoria.query.all()
        for cat in categorias:
            actualizar_metricas_categoria(cat.ID_Categoria)

        subcategorias = Subcategoria.query.all()
        for sub in subcategorias:
            actualizar_metricas_subcategoria(sub.ID_Subcategoria)

        app.logger.info('✓ Métricas de categorías actualizadas exitosamente')

    except Exception as e:
        app.logger.error(f'Error actualizando todas las métricas: {str(e)}')


# ==================== DECORADORES ====================

@app.context_processor
def inject_cart_count():
    try:
        user_id = session.get('user_id')
        if not user_id:
            return dict(cart_count=0, wishlist_count=0)

        cart_total = db.session.query(db.func.sum(Carrito.cantidad)).filter(
            Carrito.ID_Users == user_id
        ).scalar() or 0

        wishlist_total = Wishlist.query.filter_by(ID_Users=user_id).count()

        return dict(cart_count=cart_total, wishlist_count=wishlist_total)
    except Exception:
        return dict(cart_count=0, wishlist_count=0)


def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            flash('Debes iniciar sesión para acceder a esta página', 'warning')
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function


def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            flash('Debes iniciar sesión', 'warning')
            return redirect(url_for('login'))
        usuario = Usuario.query.get(session['user_id'])
        if not usuario or not usuario.es_admin:
            flash('No tienes permisos para acceder a esta página', 'danger')
            return redirect(url_for('home'))
        return f(*args, **kwargs)
    return decorated_function


# ==================== RUTAS PRINCIPALES ====================

@app.route('/')
def index():
    if 'user_id' in session:
        return redirect(url_for('home'))
    return render_template('index.html')


@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        try:
            nombre = request.form.get('nombre')
            email = request.form.get('email')
            password = request.form.get('password')
            confirm_password = request.form.get('confirm_password')

            if not all([nombre, email, password, confirm_password]):
                flash('Todos los campos son obligatorios', 'danger')
                return redirect(url_for('register'))

            if len(nombre) < ValidationLimits.MIN_NOMBRE_LENGTH:
                flash(f'El nombre debe tener al menos {ValidationLimits.MIN_NOMBRE_LENGTH} caracteres', 'danger')
                return redirect(url_for('register'))

            if len(password) < ValidationLimits.MIN_PASSWORD_LENGTH:
                flash(f'La contraseña debe tener al menos {ValidationLimits.MIN_PASSWORD_LENGTH} caracteres', 'danger')
                return redirect(url_for('register'))

            if password != confirm_password:
                flash('Las contraseñas no coinciden', 'danger')
                return redirect(url_for('register'))

            usuario_existente = Usuario.query.filter_by(email=email).first()
            if usuario_existente:
                flash('El correo electrónico ya está registrado', 'danger')
                return redirect(url_for('register'))

            hashed_password = generate_password_hash(password, method='pbkdf2:sha256')
            nuevo_usuario = Usuario(nombre=nombre, email=email, password=hashed_password)

            db.session.add(nuevo_usuario)
            db.session.commit()

            wallet = Wallet(ID_Users=nuevo_usuario.ID_Users, saldo=50.0)
            db.session.add(wallet)
            db.session.commit()

            session['user_id'] = nuevo_usuario.ID_Users
            session['user_name'] = nuevo_usuario.nombre
            session['user_email'] = nuevo_usuario.email
            session['is_admin'] = nuevo_usuario.es_admin

            flash('¡Registro exitoso! Has iniciado sesión automáticamente', 'success')
            return redirect(url_for('home'))

        except Exception as e:
            db.session.rollback()
            flash('Error al registrar usuario. Por favor intenta de nuevo.', 'danger')
            app.logger.error(f'Error en registro: {str(e)}')
            return redirect(url_for('register'))

    return render_template('register.html')


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        try:
            email = request.form.get('email')
            password = request.form.get('password')

            if not email or not password:
                flash('Por favor completa todos los campos', 'warning')
                return redirect(url_for('login'))

            usuario = Usuario.query.filter_by(email=email).first()

            if usuario and check_password_hash(usuario.password, password):
                session['user_id'] = usuario.ID_Users
                session['user_name'] = usuario.nombre
                session['user_email'] = usuario.email
                session['is_admin'] = usuario.es_admin
                flash(f'¡Bienvenido de nuevo, {usuario.nombre}!', 'success')

                if usuario.es_admin:
                    return redirect(url_for('admin_dashboard'))
                return redirect(url_for('home'))
            else:
                flash('Correo electrónico o contraseña incorrectos', 'danger')
                return redirect(url_for('login'))

        except Exception as e:
            flash('Error al iniciar sesión. Por favor intenta de nuevo.', 'danger')
            app.logger.error(f'Error en login: {str(e)}')
            return redirect(url_for('login'))

    return render_template('login.html')


@app.route('/logout')
def logout():
    session.clear()
    flash('Has cerrado sesión exitosamente', 'info')
    return redirect(url_for('index'))


# ==================== AUTOCOMPLETE SEARCH API ====================

@app.route('/api/search_autocomplete')
def api_search_autocomplete():
    q = request.args.get('q', '')
    try:
        if not q:
            return jsonify([])

        results = Producto.query.filter(
            Producto.disponible.is_(True),
            Producto.nombre.ilike(f"%{q}%")
        ).order_by(Producto.nombre.asc()).limit(10).all()

        suggestions = []
        for p in results:
            categoria_nombre = p.categoria.nombre if p.categoria else None
            suggestions.append({
                "id": p.ID_Producto,
                "nombre": p.nombre,
                "precio": p.precio,
                "imagen": p.imagen,
                "categoria": categoria_nombre
            })
        return jsonify(suggestions)
    except Exception as e:
        app.logger.error(f'Error en autocomplete API: {e}')
        return jsonify([]), 500


# ==================== NOTIFICATIONS (SSE) ====================

@app.route('/notifications/stream')
@login_required
def notifications_stream():
    user_id = session.get('user_id')

    def event_stream(uid):
        q = _get_queue_for_user(uid)
        while True:
            try:
                data = q.get(timeout=15)
                payload = {"message": data, "ts": datetime.utcnow().isoformat()}
                yield f"data: {json.dumps(payload)}\n\n"
            except Empty:
                yield ": keep-alive\n\n"

    return Response(stream_with_context(event_stream(user_id)), mimetype='text/event-stream')


# ==================== CARRITO (CON TRACKING) ====================

@app.route('/add_to_cart/<int:producto_id>')
@login_required
def add_to_cart(producto_id):
    try:
        usuario_id = session['user_id']
        producto = Producto.query.get_or_404(producto_id)

        if not producto.disponible or producto.stock <= 0:
            flash(f'{producto.nombre} no está disponible actualmente', 'warning')
            return redirect(url_for('home'))

        item = Carrito.query.filter_by(ID_Users=usuario_id, ID_Producto=producto_id).first()
        cantidad_agregada = 1

        if item:
            if producto.stock >= item.cantidad + 1:
                item.cantidad += 1
            else:
                flash('No hay más stock disponible para este producto', 'warning')
                return redirect(url_for('home'))
        else:
            nuevo = Carrito(ID_Users=usuario_id, ID_Producto=producto_id, cantidad=1)
            db.session.add(nuevo)

        historial = HistorialCarrito(
            ID_Users=usuario_id,
            ID_Producto=producto_id,
            accion='agregar',
            cantidad=cantidad_agregada,
            precio_momento=producto.precio,
            valor_total=producto.precio * cantidad_agregada
        )
        db.session.add(historial)
        db.session.commit()

        actualizar_metricas_usuario(usuario_id)

        if producto.ID_Categoria:
            actualizar_metricas_categoria(producto.ID_Categoria)
        if producto.ID_Subcategoria:
            actualizar_metricas_subcategoria(producto.ID_Subcategoria)

        try:
            notify_user(usuario_id, f'"{producto.nombre}" agregado al carrito')
        except Exception:
            pass

        flash(f'✓ {producto.nombre} agregado al carrito', 'success')
        return redirect(url_for('home'))
    except Exception as e:
        db.session.rollback()
        flash('Error al agregar el producto al carrito', 'danger')
        app.logger.error(f'Error al agregar al carrito: {str(e)}')
        return redirect(url_for('home'))


@app.route('/cart')
@login_required
def cart():
    usuario_id = session['user_id']
    items = Carrito.query.filter_by(ID_Users=usuario_id).all()

    productos = []
    total = 0.0
    for i in items:
        producto = Producto.query.get(i.ID_Producto)
        if producto:
            subtotal = producto.precio * i.cantidad
            productos.append({
                "ID_Carrito": i.ID_Carrito,
                "ID_Producto": producto.ID_Producto,
                "nombre": producto.nombre,
                "precio": producto.precio,
                "cantidad": i.cantidad,
                "subtotal": subtotal,
                "stock_disponible": producto.stock
            })
            total += subtotal

    wallet = Wallet.query.filter_by(ID_Users=usuario_id).first()
    saldo = wallet.saldo if wallet else 0.0

    return render_template('cart.html', productos=productos, total=total, saldo=saldo)


@app.route('/update_cart_quantity/<int:cart_id>', methods=['POST'])
@login_required
def update_cart_quantity(cart_id):
    try:
        usuario_id = session['user_id']
        nueva_cantidad = int(request.form.get('cantidad', 1))

        item = Carrito.query.filter_by(ID_Carrito=cart_id, ID_Users=usuario_id).first_or_404()
        producto = Producto.query.get(item.ID_Producto)

        if not producto.disponible:
            flash('Producto no disponible', 'warning')
            return redirect(url_for('cart'))

        if nueva_cantidad <= 0:
            historial = HistorialCarrito(
                ID_Users=usuario_id,
                ID_Producto=item.ID_Producto,
                accion='quitar',
                cantidad=item.cantidad,
                precio_momento=producto.precio,
                valor_total=producto.precio * item.cantidad
            )
            db.session.add(historial)
            db.session.delete(item)
            flash('Producto eliminado del carrito', 'info')

        elif nueva_cantidad > producto.stock:
            flash(f'Solo hay {producto.stock} unidades disponibles', 'warning')

        else:
            diferencia = nueva_cantidad - item.cantidad

            if diferencia > 0:
                historial = HistorialCarrito(
                    ID_Users=usuario_id,
                    ID_Producto=item.ID_Producto,
                    accion='agregar',
                    cantidad=diferencia,
                    precio_momento=producto.precio,
                    valor_total=producto.precio * diferencia
                )
            else:
                historial = HistorialCarrito(
                    ID_Users=usuario_id,
                    ID_Producto=item.ID_Producto,
                    accion='quitar',
                    cantidad=abs(diferencia),
                    precio_momento=producto.precio,
                    valor_total=producto.precio * abs(diferencia)
                )

            db.session.add(historial)
            item.cantidad = nueva_cantidad
            flash('Cantidad actualizada', 'success')

        db.session.commit()
        actualizar_metricas_usuario(usuario_id)

    except Exception as e:
        db.session.rollback()
        flash('Error al actualizar cantidad', 'danger')
        app.logger.error(f'Error al actualizar cantidad: {str(e)}')

    return redirect(url_for('cart'))


@app.route('/remove_from_cart/<int:cart_id>')
@login_required
def remove_from_cart(cart_id):
    try:
        usuario_id = session['user_id']
        item = Carrito.query.filter_by(ID_Carrito=cart_id, ID_Users=usuario_id).first_or_404()
        producto = Producto.query.get(item.ID_Producto)

        historial = HistorialCarrito(
            ID_Users=usuario_id,
            ID_Producto=item.ID_Producto,
            accion='quitar',
            cantidad=item.cantidad,
            precio_momento=producto.precio if producto else 0,
            valor_total=(producto.precio * item.cantidad) if producto else 0
        )
        db.session.add(historial)

        db.session.delete(item)
        db.session.commit()

        actualizar_metricas_usuario(usuario_id)

        flash('Item eliminado del carrito', 'info')
    except Exception as e:
        db.session.rollback()
        flash('Error al eliminar item', 'danger')
        app.logger.error(f'Error al eliminar item: {str(e)}')

    return redirect(url_for('cart'))


@app.route('/clear_cart')
@login_required
def clear_cart():
    """VACIAR CARRITO = ABANDONAR"""
    try:
        usuario_id = session['user_id']
        items = Carrito.query.filter_by(ID_Users=usuario_id).all()

        for item in items:
            producto = Producto.query.get(item.ID_Producto)
            historial = HistorialCarrito(
                ID_Users=usuario_id,
                ID_Producto=item.ID_Producto,
                accion='abandonar',
                cantidad=item.cantidad,
                precio_momento=producto.precio if producto else 0,
                valor_total=(producto.precio * item.cantidad) if producto else 0
            )
            db.session.add(historial)

        Carrito.query.filter_by(ID_Users=usuario_id).delete()
        db.session.commit()

        actualizar_metricas_usuario(usuario_id)

        flash('Carrito vaciado', 'info')
    except Exception as e:
        db.session.rollback()
        flash('Error al vaciar carrito', 'danger')
        app.logger.error(f'Error al vaciar carrito: {str(e)}')

    return redirect(url_for('cart'))


@app.route('/comprar', methods=['POST'])
@login_required
def comprar():
    usuario_id = session['user_id']
    try:
        items = Carrito.query.filter_by(ID_Users=usuario_id).all()
        if not items:
            flash("Tu carrito está vacío", "warning")
            return redirect(url_for('cart'))

        total = 0.0
        for item in items:
            producto = Producto.query.get(item.ID_Producto)
            if not producto:
                flash("Un producto en tu carrito ya no existe", "danger")
                return redirect(url_for('cart'))
            if producto.stock < item.cantidad:
                flash(f'Stock insuficiente para {producto.nombre}', 'danger')
                return redirect(url_for('cart'))
            total += producto.precio * item.cantidad

        wallet = Wallet.query.filter_by(ID_Users=usuario_id).first()

        if not wallet or wallet.saldo < total:
            saldo_faltante = total - (wallet.saldo if wallet else 0)
            flash(f'Saldo insuficiente. Te faltan ${saldo_faltante:.2f}. Por favor recarga tu wallet.', 'danger')
            return redirect(url_for('wallet'))

        saldo_anterior = wallet.saldo
        wallet.saldo -= total

        pedido = Pedido(ID_Users=usuario_id, total=total)
        db.session.add(pedido)
        db.session.flush()

        transaccion = TransaccionWallet(
            ID_Wallet=wallet.ID_Wallet,
            ID_Users=usuario_id,
            tipo='compra',
            monto=-total,
            saldo_anterior=saldo_anterior,
            saldo_nuevo=wallet.saldo,
            descripcion=f'Compra - Pedido #{pedido.ID_Pedido}',
            ID_Pedido=pedido.ID_Pedido
        )
        db.session.add(transaccion)

        categorias_afectadas = set()
        subcategorias_afectadas = set()

        for item in items:
            producto = Producto.query.get(item.ID_Producto)

            detalle = DetallePedido(
                ID_Pedido=pedido.ID_Pedido,
                ID_Producto=producto.ID_Producto,
                cantidad=item.cantidad,
                precio_unitario=producto.precio
            )
            db.session.add(detalle)

            producto.stock -= item.cantidad

            historial_compra = HistorialCarrito(
                ID_Users=usuario_id,
                ID_Producto=producto.ID_Producto,
                accion='comprar',
                cantidad=item.cantidad,
                precio_momento=producto.precio,
                valor_total=producto.precio * item.cantidad,
                ID_Pedido=pedido.ID_Pedido
            )
            db.session.add(historial_compra)

            if producto.ID_Categoria:
                categorias_afectadas.add(producto.ID_Categoria)
            if producto.ID_Subcategoria:
                subcategorias_afectadas.add(producto.ID_Subcategoria)

        Carrito.query.filter_by(ID_Users=usuario_id).delete()

        db.session.commit()

        actualizar_metricas_usuario(usuario_id)

        for cat_id in categorias_afectadas:
            actualizar_metricas_categoria(cat_id)

        for sub_id in subcategorias_afectadas:
            actualizar_metricas_subcategoria(sub_id)

        try:
            notify_user(usuario_id, f'Compra realizada. Pedido #{pedido.ID_Pedido}')
        except Exception:
            pass

        flash(f"✓ Compra realizada con éxito. Pedido #{pedido.ID_Pedido}", "success")
        return redirect(url_for('historial'))

    except Exception as e:
        db.session.rollback()
        flash("Error al procesar la compra", "danger")
        app.logger.error(f'Error en comprar: {str(e)}')
        return redirect(url_for('cart'))


@app.route('/historial')
@login_required
def historial():
    usuario_id = session['user_id']
    pedidos = Pedido.query.filter_by(ID_Users=usuario_id).order_by(Pedido.fecha.desc()).all()
    return render_template("historial.html", pedidos=pedidos)


# ==================== PRODUCT DETAIL ====================

@app.route('/product/<int:producto_id>')
def product_detail(producto_id):
    producto = Producto.query.get_or_404(producto_id)
    categoria = Categoria.query.get(producto.ID_Categoria) if producto.ID_Categoria else None
    subcategoria = Subcategoria.query.get(producto.ID_Subcategoria) if producto.ID_Subcategoria else None

    related_products = []
    if producto.ID_Categoria:
        related_products = Producto.query.filter(
            Producto.ID_Categoria == producto.ID_Categoria,
            Producto.ID_Producto != producto.ID_Producto,
            Producto.disponible.is_(True)
        ).order_by(Producto.nombre.asc()).limit(6).all()

    return render_template('product.html', producto=producto, categoria=categoria,
                         subcategoria=subcategoria, related_products=related_products)


# ==================== WALLET (CON TRACKING) ====================

@app.route('/wallet')
@login_required
def wallet():
    usuario_id = session['user_id']
    wallet = Wallet.query.filter_by(ID_Users=usuario_id).first()
    return render_template('wallet.html', wallet=wallet)


@app.route('/recargar_saldo', methods=['POST'])
@login_required
def recargar_saldo():
    try:
        usuario_id = session['user_id']
        monto = float(request.form.get('monto', 0))

        if monto <= 0:
            flash('El monto debe ser mayor a 0', 'warning')
            return redirect(url_for('wallet'))

        if monto < ValidationLimits.MIN_RECARGA:
            flash(f'El monto mínimo de recarga es ${ValidationLimits.MIN_RECARGA}', 'warning')
            return redirect(url_for('wallet'))

        if monto > ValidationLimits.MAX_RECARGA:
            flash(f'El monto máximo es ${ValidationLimits.MAX_RECARGA:,}', 'warning')
            return redirect(url_for('wallet'))

        wallet = Wallet.query.filter_by(ID_Users=usuario_id).first()
        saldo_anterior = wallet.saldo
        wallet.saldo += monto

        transaccion = TransaccionWallet(
            ID_Wallet=wallet.ID_Wallet,
            ID_Users=usuario_id,
            tipo='recarga',
            monto=monto,
            saldo_anterior=saldo_anterior,
            saldo_nuevo=wallet.saldo,
            descripcion='Recarga de saldo'
        )
        db.session.add(transaccion)
        db.session.commit()

        actualizar_metricas_usuario(usuario_id)

        try:
            notify_user(usuario_id, f'Se recargaron ${monto:.2f} en tu wallet')
        except Exception:
            pass

        flash(f'¡Saldo recargado! Se agregaron ${monto:.2f} a tu wallet', 'success')
        return redirect(url_for('wallet'))

    except Exception as e:
        db.session.rollback()
        flash('Error al recargar saldo', 'danger')
        app.logger.error(f'Error al recargar saldo: {str(e)}')
        return redirect(url_for('wallet'))


# ==================== MI PERFIL ====================

@app.route('/perfil')
@login_required
def perfil():
    usuario_id = session['user_id']
    usuario = Usuario.query.get_or_404(usuario_id)
    wallet = Wallet.query.filter_by(ID_Users=usuario_id).first()

    total_pedidos = Pedido.query.filter_by(ID_Users=usuario_id).count()

    ultimos_pedidos = Pedido.query.filter_by(ID_Users=usuario_id)\
        .order_by(Pedido.fecha.desc()).limit(5).all()

    ultimas_transacciones = TransaccionWallet.query.filter_by(ID_Users=usuario_id)\
        .order_by(TransaccionWallet.fecha.desc()).limit(5).all()

    return render_template('perfil.html',
                         usuario=usuario,
                         wallet=wallet,
                         total_pedidos=total_pedidos,
                         ultimos_pedidos=ultimos_pedidos,
                         ultimas_transacciones=ultimas_transacciones)


@app.route('/perfil/editar', methods=['GET', 'POST'])
@login_required
def editar_perfil():
    usuario_id = session['user_id']
    usuario = Usuario.query.get_or_404(usuario_id)

    if request.method == 'POST':
        try:
            nombre = request.form.get('nombre')
            email = request.form.get('email')
            password_actual = request.form.get('password_actual')
            password_nueva = request.form.get('password_nueva')

            if nombre and len(nombre) >= ValidationLimits.MIN_NOMBRE_LENGTH:
                usuario.nombre = nombre
                session['user_name'] = nombre

            if email and email != usuario.email:
                existe = Usuario.query.filter_by(email=email).first()
                if existe:
                    flash('Este email ya está registrado', 'danger')
                    return redirect(url_for('editar_perfil'))
                usuario.email = email
                session['user_email'] = email

            if password_actual and password_nueva:
                if check_password_hash(usuario.password, password_actual):
                    if len(password_nueva) >= ValidationLimits.MIN_PASSWORD_LENGTH:
                        usuario.password = generate_password_hash(password_nueva, method='pbkdf2:sha256')
                        flash('Contraseña actualizada correctamente', 'success')
                    else:
                        flash(f'La nueva contraseña debe tener al menos {ValidationLimits.MIN_PASSWORD_LENGTH} caracteres', 'warning')
                else:
                    flash('La contraseña actual es incorrecta', 'danger')
                    return redirect(url_for('editar_perfil'))

            db.session.commit()
            flash('Perfil actualizado correctamente', 'success')
            return redirect(url_for('perfil'))

        except Exception as e:
            db.session.rollback()
            flash('Error al actualizar perfil', 'danger')
            app.logger.error(f'Error al actualizar perfil: {str(e)}')

    return render_template('editar_perfil.html', usuario=usuario)


# ==================== WISHLIST ====================

@app.route('/add_to_wishlist/<int:producto_id>')
@login_required
def add_to_wishlist(producto_id):
    try:
        usuario_id = session['user_id']
        producto = Producto.query.get_or_404(producto_id)

        existente = Wishlist.query.filter_by(
            ID_Users=usuario_id,
            ID_Producto=producto_id
        ).first()

        if existente:
            flash(f'{producto.nombre} ya está en tu lista de deseos', 'info')
            return redirect(url_for('home'))

        nuevo_item = Wishlist(ID_Users=usuario_id, ID_Producto=producto_id)
        db.session.add(nuevo_item)
        db.session.commit()

        flash(f'✓ {producto.nombre} agregado a tu lista de deseos', 'success')
        return redirect(url_for('home'))

    except Exception as e:
        db.session.rollback()
        flash('Error al agregar a la lista de deseos', 'danger')
        app.logger.error(f'Error al agregar a wishlist: {str(e)}')
        return redirect(url_for('home'))


@app.route('/remove_from_wishlist/<int:producto_id>')
@login_required
def remove_from_wishlist(producto_id):
    try:
        usuario_id = session['user_id']
        item = Wishlist.query.filter_by(
            ID_Users=usuario_id,
            ID_Producto=producto_id
        ).first_or_404()

        db.session.delete(item)
        db.session.commit()

        flash('Producto eliminado de tu lista de deseos', 'info')
        return redirect(url_for('wishlist'))

    except Exception as e:
        db.session.rollback()
        flash('Error al eliminar de la lista de deseos', 'danger')
        app.logger.error(f'Error al eliminar de wishlist: {str(e)}')
        return redirect(url_for('wishlist'))


@app.route('/wishlist')
@login_required
def wishlist():
    usuario_id = session['user_id']
    wishlist_items = Wishlist.query.filter_by(ID_Users=usuario_id).all()

    productos = []
    for item in wishlist_items:
        producto = Producto.query.get(item.ID_Producto)
        if producto:
            productos.append({
                "ID_Producto": producto.ID_Producto,
                "nombre": producto.nombre,
                "precio": producto.precio,
                "imagen": producto.imagen,
                "disponible": producto.disponible,
                "stock": producto.stock,
                "fecha_agregado": item.fecha_agregado
            })

    return render_template('wishlist.html', productos=productos)


@app.route('/wishlist_to_cart/<int:producto_id>')
@login_required
def wishlist_to_cart(producto_id):
    """Mover producto de wishlist al carrito"""
    try:
        usuario_id = session['user_id']

        wishlist_item = Wishlist.query.filter_by(
            ID_Users=usuario_id,
            ID_Producto=producto_id
        ).first_or_404()

        producto = Producto.query.get_or_404(producto_id)

        item_carrito = Carrito.query.filter_by(
            ID_Users=usuario_id,
            ID_Producto=producto_id
        ).first()

        if item_carrito:
            if producto.stock >= item_carrito.cantidad + 1:
                item_carrito.cantidad += 1
            else:
                flash('No hay suficiente stock disponible', 'warning')
                return redirect(url_for('wishlist'))
        else:
            nuevo_carrito = Carrito(ID_Users=usuario_id, ID_Producto=producto_id, cantidad=1)
            db.session.add(nuevo_carrito)

        historial = HistorialCarrito(
            ID_Users=usuario_id,
            ID_Producto=producto_id,
            accion='agregar',
            cantidad=1,
            precio_momento=producto.precio,
            valor_total=producto.precio
        )
        db.session.add(historial)

        db.session.delete(wishlist_item)
        db.session.commit()

        actualizar_metricas_usuario(usuario_id)

        try:
            notify_user(usuario_id, f'"{producto.nombre}" movido de wishlist al carrito')
        except Exception:
            pass

        flash(f'✓ {producto.nombre} movido al carrito', 'success')
        return redirect(url_for('wishlist'))

    except Exception as e:
        db.session.rollback()
        flash('Error al mover producto al carrito', 'danger')
        app.logger.error(f'Error en wishlist_to_cart: {str(e)}')
        return redirect(url_for('wishlist'))


# ==================== PANEL DE ADMINISTRACIÓN ====================

@app.route('/admin')
@admin_required
def admin_dashboard():
    total_usuarios = Usuario.query.count()
    total_productos = Producto.query.count()
    total_pedidos = Pedido.query.count()
    total_ventas = db.session.query(db.func.sum(Pedido.total)).scalar() or 0

    pedidos_recientes = Pedido.query.order_by(Pedido.fecha.desc()).limit(5).all()

    # ✅ NUEVOS DATOS PARA GRÁFICA COMPARATIVA
    # Métricas generales
    total_productos_vendidos = db.session.query(
        db.func.sum(DetallePedido.cantidad)
    ).scalar() or 0

    total_abandonos = db.session.query(
        db.func.sum(HistorialCarrito.cantidad)
    ).filter(HistorialCarrito.accion == 'abandonar').scalar() or 0

    productos_en_carritos = db.session.query(
        db.func.sum(Carrito.cantidad)
    ).scalar() or 0

    # Datos para gráfica de los últimos 30 días
    hace_30_dias = datetime.utcnow() - timedelta(days=30)

    # Ventas por día
    ventas_diarias = db.session.query(
        db.func.date(Pedido.fecha).label('fecha'),
        db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('vendidos')
    ).join(DetallePedido).filter(
        Pedido.fecha >= hace_30_dias
    ).group_by(db.func.date(Pedido.fecha)).order_by('fecha').all()

    # Abandonos por día
    abandonos_diarios = db.session.query(
        db.func.date(HistorialCarrito.fecha).label('fecha'),
        db.func.coalesce(db.func.sum(HistorialCarrito.cantidad), 0).label('abandonados')
    ).filter(
        HistorialCarrito.accion == 'abandonar',
        HistorialCarrito.fecha >= hace_30_dias
    ).group_by(db.func.date(HistorialCarrito.fecha)).order_by('fecha').all()

    # Métricas de categorías para el dashboard
    categorias_metricas = []
    categorias = Categoria.query.filter_by(activa=True).order_by(Categoria.orden).all()

    for cat in categorias:
        metricas = MetricaCategoria.query.filter_by(ID_Categoria=cat.ID_Categoria).first()
        categorias_metricas.append({
            'nombre': cat.nombre,
            'icono': cat.icono,
            'productos_activos': metricas.productos_activos if metricas else Producto.query.filter_by(ID_Categoria=cat.ID_Categoria, disponible=True).count(),
            'total_vendidos': metricas.total_productos_vendidos if metricas else 0,
            'ingresos': metricas.ingresos_totales if metricas else 0,
            'tasa_conversion': metricas.tasa_conversion if metricas else 0
        })

    now = datetime.utcnow()
    last7 = (now - timedelta(days=7)).strftime('%Y-%m-%d')
    last30 = (now - timedelta(days=30)).strftime('%Y-%m-%d')
    last90 = (now - timedelta(days=90)).strftime('%Y-%m-%d')
    now_str = now.strftime('%Y-%m-%d')

    return render_template('admin/dashboard.html',
                         total_usuarios=total_usuarios,
                         total_productos=total_productos,
                         total_pedidos=total_pedidos,
                         total_ventas=total_ventas,
                         pedidos_recientes=pedidos_recientes,
                         categorias_metricas=categorias_metricas,
                         # ✅ Nuevos datos para gráfica
                         total_productos_vendidos=total_productos_vendidos,
                         total_abandonos=total_abandonos,
                         productos_en_carritos=productos_en_carritos,
                         ventas_diarias=ventas_diarias,
                         abandonos_diarios=abandonos_diarios,
                         now=now_str,
                         last7=last7,
                         last30=last30,
                         last90=last90)


@app.route('/admin/usuarios')
@admin_required
def admin_usuarios():
    usuarios = Usuario.query.all()
    return render_template('admin/usuarios.html', usuarios=usuarios)


@app.route('/admin/productos')
@admin_required
def admin_productos():
    productos = Producto.query.all()
    return render_template('admin/productos.html', productos=productos)


@app.route('/admin/productos/eliminar/<int:producto_id>')
@admin_required
def admin_eliminar_producto(producto_id):
    try:
        producto = Producto.query.get_or_404(producto_id)

        detalle_existente = DetallePedido.query.filter_by(ID_Producto=producto_id).first()
        if detalle_existente:
            flash('No se puede eliminar este producto porque pertenece a pedidos históricos.', 'danger')
            return redirect(url_for('admin_productos'))

        Carrito.query.filter_by(ID_Producto=producto_id).delete()
        Wishlist.query.filter_by(ID_Producto=producto_id).delete()
        db.session.delete(producto)
        db.session.commit()
        flash('Producto eliminado exitosamente', 'success')
    except Exception as e:
        db.session.rollback()
        flash('Error al eliminar producto', 'danger')
        app.logger.error(f'Error al eliminar producto: {str(e)}')

    return redirect(url_for('admin_productos'))


@app.route('/admin/pedidos')
@admin_required
def admin_pedidos():
    pedidos = Pedido.query.order_by(Pedido.fecha.desc()).all()
    return render_template('admin/pedidos.html', pedidos=pedidos)


@app.route('/admin/usuarios/agregar_saldo/<int:usuario_id>', methods=['POST'])
@admin_required
def admin_agregar_saldo(usuario_id):
    try:
        monto = float(request.form.get('monto', 0))
        wallet = Wallet.query.filter_by(ID_Users=usuario_id).first()

        if wallet and monto > 0:
            saldo_anterior = wallet.saldo
            wallet.saldo += monto

            transaccion = TransaccionWallet(
                ID_Wallet=wallet.ID_Wallet,
                ID_Users=usuario_id,
                tipo='admin',
                monto=monto,
                saldo_anterior=saldo_anterior,
                saldo_nuevo=wallet.saldo,
                descripcion='Recarga administrativa por admin'
            )
            db.session.add(transaccion)
            db.session.commit()

            actualizar_metricas_usuario(usuario_id)

            try:
                notify_user(usuario_id, f'Se agregó saldo por un admin: ${monto:.2f}')
            except Exception:
                pass

            flash('Saldo agregado exitosamente', 'success')
        else:
            flash('Wallet no encontrada o monto inválido', 'danger')
    except Exception as e:
        db.session.rollback()
        flash('Error al agregar saldo', 'danger')
        app.logger.error(f'Error al agregar saldo: {str(e)}')

    return redirect(url_for('admin_usuarios'))


# ==========================================
# GESTIÓN DE CATEGORÍAS - ADMIN
# ==========================================

@app.route('/admin/categorias')
@admin_required
def admin_categorias():
    categorias = Categoria.query.order_by(Categoria.orden, Categoria.nombre).all()
    return render_template('admin/categorias.html', categorias=categorias)


@app.route('/admin/categorias/referencia')
@admin_required
def admin_categorias_referencia():
    categorias = Categoria.query.order_by(Categoria.orden, Categoria.nombre).all()
    return render_template('admin/categorias_referencia.html', categorias=categorias)


@app.route('/admin/categorias/agregar', methods=['GET', 'POST'])
@admin_required
def admin_agregar_categoria():
    if request.method == 'POST':
        try:
            nombre = request.form.get('nombre')
            descripcion = request.form.get('descripcion')
            icono = request.form.get('icono', 'fa-box')
            orden = int(request.form.get('orden', 0))
            activa = request.form.get('activa', 'on') == 'on'

            existe = Categoria.query.filter_by(nombre=nombre).first()
            if existe:
                flash(f'Ya existe una categoría con el nombre "{nombre}"', 'warning')
                return redirect(url_for('admin_agregar_categoria'))

            nueva_categoria = Categoria(
                nombre=nombre,
                descripcion=descripcion,
                icono=icono,
                orden=orden,
                activa=activa
            )

            db.session.add(nueva_categoria)
            db.session.commit()

            metricas = MetricaCategoria(ID_Categoria=nueva_categoria.ID_Categoria)
            db.session.add(metricas)
            db.session.commit()

            flash(f'✓ Categoría "{nombre}" creada exitosamente', 'success')
            return redirect(url_for('admin_categorias'))

        except ValueError as e:
            flash(f'Error en los datos: {str(e)}', 'danger')
        except Exception as e:
            db.session.rollback()
            flash(f'Error al crear categoría: {str(e)}', 'danger')
            app.logger.error(f'Error al crear categoría: {str(e)}')

    return render_template('admin/agregar_categoria.html')


@app.route('/admin/categorias/editar/<int:categoria_id>', methods=['GET', 'POST'])
@admin_required
def admin_editar_categoria(categoria_id):
    categoria = Categoria.query.get_or_404(categoria_id)

    if request.method == 'POST':
        try:
            nombre = request.form.get('nombre')

            existe = Categoria.query.filter(
                Categoria.nombre == nombre,
                Categoria.ID_Categoria != categoria_id
            ).first()

            if existe:
                flash(f'Ya existe otra categoría con el nombre "{nombre}"', 'warning')
                return redirect(url_for('admin_editar_categoria', categoria_id=categoria_id))

            categoria.nombre = nombre
            categoria.descripcion = request.form.get('descripcion')
            categoria.icono = request.form.get('icono', 'fa-box')
            categoria.orden = int(request.form.get('orden', 0))
            categoria.activa = request.form.get('activa') == 'on'

            db.session.commit()
            flash(f'✓ Categoría "{nombre}" actualizada exitosamente', 'success')
            return redirect(url_for('admin_categorias'))

        except ValueError as e:
            flash(f'Error en los datos: {str(e)}', 'danger')
        except Exception as e:
            db.session.rollback()
            flash(f'Error al actualizar categoría: {str(e)}', 'danger')
            app.logger.error(f'Error al actualizar categoría: {str(e)}')

    return render_template('admin/editar_categoria.html', categoria=categoria)


@app.route('/admin/categorias/eliminar/<int:categoria_id>')
@admin_required
def admin_eliminar_categoria(categoria_id):
    try:
        categoria = Categoria.query.get_or_404(categoria_id)

        productos_count = Producto.query.filter_by(ID_Categoria=categoria_id).count()
        if productos_count > 0:
            flash(f'No se puede eliminar: la categoría "{categoria.nombre}" tiene {productos_count} producto(s) asociado(s)', 'danger')
            return redirect(url_for('admin_categorias'))

        nombre = categoria.nombre
        db.session.delete(categoria)
        db.session.commit()

        flash(f'✓ Categoría "{nombre}" eliminada exitosamente', 'success')

    except Exception as e:
        db.session.rollback()
        flash(f'Error al eliminar categoría: {str(e)}', 'danger')
        app.logger.error(f'Error al eliminar categoría: {str(e)}')

    return redirect(url_for('admin_categorias'))


# ==========================================
# GESTIÓN DE SUBCATEGORÍAS - ADMIN
# ==========================================

@app.route('/admin/subcategorias/agregar', methods=['GET', 'POST'])
@admin_required
def admin_agregar_subcategoria():
    categorias = Categoria.query.filter_by(activa=True).order_by(Categoria.nombre).all()

    if request.method == 'POST':
        try:
            ID_Categoria = int(request.form.get('ID_Categoria'))
            nombre = request.form.get('nombre')
            descripcion = request.form.get('descripcion')
            orden = int(request.form.get('orden', 0))
            activa = request.form.get('activa', 'on') == 'on'

            categoria_padre = Categoria.query.get(ID_Categoria)
            if not categoria_padre:
                flash('La categoría seleccionada no existe', 'danger')
                return redirect(url_for('admin_agregar_subcategoria'))

            existe = Subcategoria.query.filter_by(
                ID_Categoria=ID_Categoria,
                nombre=nombre
            ).first()

            if existe:
                flash(f'Ya existe una subcategoría "{nombre}" en la categoría "{categoria_padre.nombre}"', 'warning')
                return redirect(url_for('admin_agregar_subcategoria'))

            nueva_subcategoria = Subcategoria(
                ID_Categoria=ID_Categoria,
                nombre=nombre,
                descripcion=descripcion,
                orden=orden,
                activa=activa
            )

            db.session.add(nueva_subcategoria)
            db.session.commit()

            metricas = MetricaSubcategoria(
                ID_Subcategoria=nueva_subcategoria.ID_Subcategoria,
                ID_Categoria=ID_Categoria
            )
            db.session.add(metricas)
            db.session.commit()

            flash(f'✓ Subcategoría "{nombre}" creada en "{categoria_padre.nombre}"', 'success')
            return redirect(url_for('admin_categorias'))

        except ValueError as e:
            flash(f'Error en los datos: {str(e)}', 'danger')
        except Exception as e:
            db.session.rollback()
            flash(f'Error al crear subcategoría: {str(e)}', 'danger')
            app.logger.error(f'Error al crear subcategoría: {str(e)}')

    return render_template('admin/agregar_subcategoria.html', categorias=categorias)


@app.route('/admin/subcategorias/editar/<int:subcategoria_id>', methods=['GET', 'POST'])
@admin_required
def admin_editar_subcategoria(subcategoria_id):
    subcategoria = Subcategoria.query.get_or_404(subcategoria_id)
    categorias = Categoria.query.filter_by(activa=True).order_by(Categoria.nombre).all()

    if request.method == 'POST':
        try:
            ID_Categoria = int(request.form.get('ID_Categoria'))
            nombre = request.form.get('nombre')

            existe = Subcategoria.query.filter(
                Subcategoria.ID_Categoria == ID_Categoria,
                Subcategoria.nombre == nombre,
                Subcategoria.ID_Subcategoria != subcategoria_id
            ).first()

            if existe:
                flash(f'Ya existe otra subcategoría con el nombre "{nombre}" en esta categoría', 'warning')
                return redirect(url_for('admin_editar_subcategoria', subcategoria_id=subcategoria_id))

            subcategoria.ID_Categoria = ID_Categoria
            subcategoria.nombre = nombre
            subcategoria.descripcion = request.form.get('descripcion')
            subcategoria.orden = int(request.form.get('orden', 0))
            subcategoria.activa = request.form.get('activa') == 'on'

            metricas = MetricaSubcategoria.query.filter_by(ID_Subcategoria=subcategoria_id).first()
            if metricas:
                metricas.ID_Categoria = ID_Categoria

            db.session.commit()
            flash(f'✓ Subcategoría "{nombre}" actualizada exitosamente', 'success')
            return redirect(url_for('admin_categorias'))

        except ValueError as e:
            flash(f'Error en los datos: {str(e)}', 'danger')
        except Exception as e:
            db.session.rollback()
            flash(f'Error al actualizar subcategoría: {str(e)}', 'danger')
            app.logger.error(f'Error al actualizar subcategoría: {str(e)}')

    return render_template('admin/editar_subcategoria.html',
                         subcategoria=subcategoria,
                         categorias=categorias)


@app.route('/admin/subcategorias/eliminar/<int:subcategoria_id>')
@admin_required
def admin_eliminar_subcategoria(subcategoria_id):
    try:
        subcategoria = Subcategoria.query.get_or_404(subcategoria_id)

        productos_count = Producto.query.filter_by(ID_Subcategoria=subcategoria_id).count()
        if productos_count > 0:
            flash(f'No se puede eliminar: la subcategoría "{subcategoria.nombre}" tiene {productos_count} producto(s) asociado(s)', 'danger')
            return redirect(url_for('admin_categorias'))

        nombre = subcategoria.nombre
        db.session.delete(subcategoria)
        db.session.commit()

        flash(f'✓ Subcategoría "{nombre}" eliminada exitosamente', 'success')

    except Exception as e:
        db.session.rollback()
        flash(f'Error al eliminar subcategoría: {str(e)}', 'danger')
        app.logger.error(f'Error al eliminar subcategoría: {str(e)}')

    return redirect(url_for('admin_categorias'))


# ==========================================
# GESTIÓN DE PRODUCTOS - ADMIN
# ==========================================

@app.route('/admin/productos/agregar', methods=['GET', 'POST'])
@admin_required
def admin_agregar_producto():
    categorias = Categoria.query.filter_by(activa=True).order_by(Categoria.orden, Categoria.nombre).all()

    if request.method == 'POST':
        try:
            nombre = request.form.get('nombre')
            precio = float(request.form.get('precio'))
            stock = int(request.form.get('stock'))
            disponible = request.form.get('disponible') == 'on'

            ID_Categoria = request.form.get('ID_Categoria')
            ID_Subcategoria = request.form.get('ID_Subcategoria')

            if ID_Categoria and ID_Categoria.strip():
                ID_Categoria = int(ID_Categoria)
            else:
                ID_Categoria = None

            if ID_Subcategoria and ID_Subcategoria.strip():
                ID_Subcategoria = int(ID_Subcategoria)
            else:
                ID_Subcategoria = None

            if ID_Subcategoria and not ID_Categoria:
                subcategoria = Subcategoria.query.get(ID_Subcategoria)
                if subcategoria:
                    ID_Categoria = subcategoria.ID_Categoria
                    flash('Se asignó automáticamente la categoría de la subcategoría seleccionada', 'info')

            imagen_file = request.files.get('imagen_file')
            imagen_path = None

            if imagen_file and imagen_file.filename:
                if allowed_file(imagen_file.filename):
                    filename = secure_filename(imagen_file.filename)
                    filename = f"{int(time.time())}_{filename}"
                    save_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
                    imagen_file.save(save_path)
                    imagen_path = f"img/{filename}"
                else:
                    flash('Tipo de archivo no permitido. Use: png, jpg, jpeg, gif, webp', 'warning')
                    return redirect(url_for('admin_agregar_producto'))
            else:
                imagen_path = request.form.get('imagen') or None

            nuevo_producto = Producto(
                nombre=nombre,
                precio=precio,
                stock=stock,
                imagen=imagen_path,
                disponible=disponible,
                ID_Categoria=ID_Categoria,
                ID_Subcategoria=ID_Subcategoria
            )

            db.session.add(nuevo_producto)
            db.session.commit()

            flash(f'✓ Producto "{nombre}" agregado exitosamente', 'success')
            return redirect(url_for('admin_productos'))

        except ValueError as e:
            flash(f'Error en los datos ingresados: {str(e)}', 'danger')
            app.logger.error(f'Error de validación en agregar producto: {str(e)}')
        except Exception as e:
            db.session.rollback()
            flash(f'Error al agregar producto: {str(e)}', 'danger')
            app.logger.error(f'Error al agregar producto: {str(e)}')

    return render_template('admin/agregar_producto.html', categorias=categorias)


@app.route('/admin/productos/editar/<int:producto_id>', methods=['GET', 'POST'])
@admin_required
def admin_editar_producto(producto_id):
    producto = Producto.query.get_or_404(producto_id)
    categorias = Categoria.query.filter_by(activa=True).order_by(Categoria.orden, Categoria.nombre).all()

    if request.method == 'POST':
        try:
            producto.nombre = request.form.get('nombre')
            producto.precio = float(request.form.get('precio'))
            producto.stock = int(request.form.get('stock'))
            producto.disponible = request.form.get('disponible') == 'on'

            ID_Categoria = request.form.get('ID_Categoria')
            ID_Subcategoria = request.form.get('ID_Subcategoria')

            if ID_Categoria and ID_Categoria.strip():
                producto.ID_Categoria = int(ID_Categoria)
            else:
                producto.ID_Categoria = None

            if ID_Subcategoria and ID_Subcategoria.strip():
                producto.ID_Subcategoria = int(ID_Subcategoria)
            else:
                producto.ID_Subcategoria = None

            if producto.ID_Subcategoria and not producto.ID_Categoria:
                subcategoria = Subcategoria.query.get(producto.ID_Subcategoria)
                if subcategoria:
                    producto.ID_Categoria = subcategoria.ID_Categoria

            imagen_file = request.files.get('imagen_file')
            if imagen_file and imagen_file.filename:
                if allowed_file(imagen_file.filename):
                    filename = secure_filename(imagen_file.filename)
                    filename = f"{int(time.time())}_{filename}"
                    save_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
                    imagen_file.save(save_path)
                    producto.imagen = f"img/{filename}"
                else:
                    flash('Tipo de archivo no permitido', 'warning')
                    return redirect(url_for('admin_editar_producto', producto_id=producto_id))
            else:
                nueva_url = request.form.get('imagen')
                if nueva_url:
                    producto.imagen = nueva_url

            db.session.commit()
            flash(f'✓ Producto "{producto.nombre}" actualizado exitosamente', 'success')
            return redirect(url_for('admin_productos'))

        except ValueError as e:
            flash(f'Error en los datos: {str(e)}', 'danger')
        except Exception as e:
            db.session.rollback()
            flash(f'Error al actualizar producto: {str(e)}', 'danger')
            app.logger.error(f'Error al actualizar producto: {str(e)}')

    return render_template('admin/editar_producto.html', producto=producto, categorias=categorias)


# ==========================================
# RUTA HOME (con filtros y paginación)
# ==========================================

@app.route('/home')
def home():
    search_query = request.args.get('search', '')
    sort_by = request.args.get('sort', 'nombre')
    categoria_id = request.args.get('categoria', type=int)
    subcategoria_id = request.args.get('subcategoria', type=int)

    query = Producto.query

    if search_query:
        query = query.filter(Producto.nombre.ilike(f'%{search_query}%'))

    if categoria_id == -1:
        query = query.filter(Producto.ID_Categoria.is_(None))
    elif categoria_id:
        query = query.filter(Producto.ID_Categoria == categoria_id)

    if subcategoria_id == -1:
        query = query.filter(Producto.ID_Subcategoria.is_(None))
    elif subcategoria_id:
        query = query.filter(Producto.ID_Subcategoria == subcategoria_id)

    if sort_by == 'precio_asc':
        query = query.order_by(Producto.precio.asc())
    elif sort_by == 'precio_desc':
        query = query.order_by(Producto.precio.desc())
    elif sort_by == 'stock':
        query = query.order_by(Producto.stock.desc())
    else:
        query = query.order_by(Producto.nombre.asc())

    categorias = Categoria.query.filter_by(activa=True).order_by(Categoria.orden).all()

    productos_sin_categoria = Producto.query.filter(Producto.ID_Categoria.is_(None)).count()

    # Paginación
    page = request.args.get('page', 1, type=int)
    per_page = 12

    query = query.filter_by(disponible=True)
    productos = query.paginate(page=page, per_page=per_page, error_out=False)

    return render_template('home.html',
                         productos=productos,
                         search_query=search_query,
                         sort_by=sort_by,
                         categorias=categorias,
                         categoria_actual=categoria_id,
                         subcategoria_actual=subcategoria_id,
                         productos_sin_categoria=productos_sin_categoria)


# ==========================================
# API para obtener subcategorías (AJAX)
# ==========================================

@app.route('/api/subcategorias/<int:categoria_id>')
def api_subcategorias(categoria_id):
    """Retorna las subcategorías de una categoría en formato JSON"""
    try:
        subcategorias = Subcategoria.query.filter_by(
            ID_Categoria=categoria_id,
            activa=True
        ).order_by(Subcategoria.orden, Subcategoria.nombre).all()

        return jsonify([sub.to_dict() for sub in subcategorias])
    except Exception as e:
        app.logger.error(f'Error en API subcategorias: {str(e)}')
        return jsonify([]), 500


# ==========================================
# ANALYTICS DE CATEGORÍAS
# ==========================================

# @app.route('/admin/analytics/categorias')
# @admin_required
# def admin_analytics_categorias():
#     try:
#         categorias_por_ingresos = db.session.query(
#             Categoria.ID_Categoria,
#             Categoria.nombre,
#             Categoria.icono,
#             MetricaCategoria.ingresos_totales,
#             MetricaCategoria.total_productos_vendidos,
#             MetricaCategoria.total_pedidos,
#             MetricaCategoria.tasa_conversion,
#             MetricaCategoria.total_agregados_carrito,
#             MetricaCategoria.valor_abandonos
#         ).join(MetricaCategoria).filter(
#             Categoria.activa == True
#         ).order_by(MetricaCategoria.ingresos_totales.desc()).all()
#
#         mejor_conversion = db.session.query(
#             Categoria.nombre,
#             Categoria.icono,
#             MetricaCategoria.tasa_conversion,
#             MetricaCategoria.total_agregados_carrito,
#             MetricaCategoria.total_productos_vendidos
#         ).join(MetricaCategoria).filter(
#             Categoria.activa == True,
#             MetricaCategoria.total_agregados_carrito > 0
#         ).order_by(MetricaCategoria.tasa_conversion.desc()).first()
#
#         mas_abandonos = db.session.query(
#             Categoria.nombre,
#             Categoria.icono,
#             MetricaCategoria.valor_abandonos,
#             MetricaCategoria.total_abandonos
#         ).join(MetricaCategoria).filter(
#             Categoria.activa == True
#         ).order_by(MetricaCategoria.valor_abandonos.desc()).limit(5).all()
#
#         productos_top_por_categoria = {}
#         categorias = Categoria.query.filter_by(activa=True).all()
#
#         for cat in categorias:
#             productos = db.session.query(
#                 Producto.nombre,
#                 Producto.imagen,
#                 Producto.precio,
#                 db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('total_vendido'),
#                 db.func.coalesce(db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario), 0).label('ingresos')
#             ).outerjoin(DetallePedido).filter(
#                 Producto.ID_Categoria == cat.ID_Categoria
#             ).group_by(Producto.ID_Producto).order_by(
#                 db.desc('total_vendido')
#             ).limit(10).all()
#
#             if productos and any(p.total_vendido > 0 for p in productos):
#                 productos_top_por_categoria[cat.nombre] = [p for p in productos if p.total_vendido > 0]
#
#         subcategorias_ranking = db.session.query(
#             Subcategoria.nombre,
#             Categoria.nombre.label('categoria_nombre'),
#             Categoria.icono,
#             MetricaSubcategoria.ingresos_totales,
#             MetricaSubcategoria.total_productos_vendidos,
#             MetricaSubcategoria.tasa_conversion
#         ).join(Categoria).join(MetricaSubcategoria).filter(
#             Subcategoria.activa == True
#         ).order_by(MetricaSubcategoria.ingresos_totales.desc()).limit(15).all()
#
#         distribucion_ventas = []
#         total_ventas_global = db.session.query(
#             db.func.sum(MetricaCategoria.ingresos_totales)
#         ).scalar() or 1
#
#         for cat in categorias:
#             metricas = MetricaCategoria.query.filter_by(ID_Categoria=cat.ID_Categoria).first()
#             if metricas and metricas.ingresos_totales > 0:
#                 porcentaje = (metricas.ingresos_totales / total_ventas_global) * 100
#                 distribucion_ventas.append({
#                     'nombre': cat.nombre,
#                     'ingresos': metricas.ingresos_totales,
#                     'porcentaje': porcentaje
#                 })
#
#         productos_mejor_conversion = db.session.query(
#             Producto.nombre,
#             Producto.imagen,
#             Categoria.nombre.label('categoria'),
#             db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('vendidos'),
#             db.func.coalesce(db.func.sum(
#                 db.case(
#                     (HistorialCarrito.accion == 'agregar', HistorialCarrito.cantidad),
#                     else_=0
#                 )
#             ), 0).label('agregados')
#         ).outerjoin(Categoria).outerjoin(DetallePedido).outerjoin(HistorialCarrito).group_by(
#             Producto.ID_Producto
#         ).all()
#
#         productos_conversion = []
#         for p in productos_mejor_conversion:
#             vendidos = p.vendidos or 0
#             agregados = p.agregados or 0
#             if agregados > 0 and vendidos > 0:
#                 conversion = (vendidos / agregados) * 100
#                 productos_conversion.append({
#                     'nombre': p.nombre,
#                     'imagen': p.imagen,
#                     'categoria': p.categoria or 'Sin categoría',
#                     'vendidos': vendidos,
#                     'agregados': agregados,
#                     'conversion': conversion
#                 })
#
#         productos_conversion.sort(key=lambda x: x['conversion'], reverse=True)
#         productos_conversion = productos_conversion[:10]
#
#         categorias_mas_agregadas = db.session.query(
#             Categoria.nombre,
#             Categoria.icono,
#             MetricaCategoria.total_agregados_carrito,
#             MetricaCategoria.total_productos_vendidos,
#             MetricaCategoria.tasa_conversion
#         ).join(MetricaCategoria).filter(
#             Categoria.activa == True
#         ).order_by(MetricaCategoria.total_agregados_carrito.desc()).limit(5).all()
#
#         pedidos_recientes = Pedido.query.order_by(Pedido.fecha.desc()).limit(10).all()
#
#         usuarios_activos_hoy = Usuario.query.filter(
#             Usuario.ultima_actividad >= datetime.utcnow() - timedelta(days=1)
#         ).count()
#
#         return render_template('admin/analytics_categorias.html',
#             categorias_por_ingresos=categorias_por_ingresos,
#             mejor_conversion=mejor_conversion,
#             mas_abandonos=mas_abandonos,
#             productos_top_por_categoria=productos_top_por_categoria,
#             subcategorias_ranking=subcategorias_ranking,
#             distribucion_ventas=distribucion_ventas,
#             productos_mejor_conversion=productos_conversion,
#             categorias_mas_agregadas=categorias_mas_agregadas,
#             pedidos_recientes=pedidos_recientes,
#             usuarios_activos_hoy=usuarios_activos_hoy
#         )
#
#     except Exception as e:
#         flash(f'Error al cargar analytics de categorías: {str(e)}', 'danger')
#         app.logger.error(f'Error en analytics categorías: {str(e)}')
#         return redirect(url_for('admin_analytics'))


@app.route('/admin/analytics/categoria/<int:categoria_id>')
@admin_required
def admin_analytics_categoria_detalle(categoria_id):
    try:
        categoria = Categoria.query.get_or_404(categoria_id)
        metricas = MetricaCategoria.query.filter_by(ID_Categoria=categoria_id).first()

        if not metricas:
            actualizar_metricas_categoria(categoria_id)
            metricas = MetricaCategoria.query.filter_by(ID_Categoria=categoria_id).first()

        # Productos de la categoría
        productos = db.session.query(
            Producto.ID_Producto,
            Producto.nombre,
            Producto.imagen,
            Producto.precio,
            Producto.stock,
            db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('total_vendido'),
            db.func.coalesce(db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario), 0).label('ingresos')
        ).outerjoin(
            DetallePedido, DetallePedido.ID_Producto == Producto.ID_Producto
        ).filter(
            Producto.ID_Categoria == categoria_id
        ).group_by(Producto.ID_Producto
        ).order_by(db.desc('total_vendido')
        ).all()

        # Subcategorías
        subcategorias = db.session.query(
            Subcategoria,
            MetricaSubcategoria
        ).outerjoin(
            MetricaSubcategoria, MetricaSubcategoria.ID_Subcategoria == Subcategoria.ID_Subcategoria
        ).filter(
            Subcategoria.ID_Categoria == categoria_id
        ).all()

        # Ventas diarias de la categoría
        hace_30_dias = datetime.utcnow() - timedelta(days=30)
        ventas_diarias = db.session.query(
            db.func.date(Pedido.fecha).label('fecha'),
            db.func.coalesce(db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario), 0).label('ingresos'),
            db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('unidades')
        ).join(
            DetallePedido, DetallePedido.ID_Pedido == Pedido.ID_Pedido
        ).join(
            Producto, Producto.ID_Producto == DetallePedido.ID_Producto
        ).filter(
            Producto.ID_Categoria == categoria_id,
            Pedido.fecha >= hace_30_dias
        ).group_by(db.func.date(Pedido.fecha)
        ).order_by('fecha').all()

        # Top clientes
        top_clientes = db.session.query(
            Usuario.nombre,
            Usuario.email,
            db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('productos_comprados'),
            db.func.coalesce(db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario), 0).label('total_gastado')
        ).join(
            Pedido, Pedido.ID_Users == Usuario.ID_Users
        ).join(
            DetallePedido, DetallePedido.ID_Pedido == Pedido.ID_Pedido
        ).join(
            Producto, Producto.ID_Producto == DetallePedido.ID_Producto
        ).filter(
            Producto.ID_Categoria == categoria_id
        ).group_by(Usuario.ID_Users
        ).order_by(db.desc('total_gastado')
        ).limit(10).all()

        return render_template('admin/analytics_categoria_detalle.html',
            categoria=categoria,
            metricas=metricas,
            productos=productos,
            subcategorias=subcategorias,
            ventas_diarias=ventas_diarias,
            top_clientes=top_clientes
        )

    except Exception as e:
        flash(f'Error: {str(e)}', 'danger')
        app.logger.error(f'Error en detalle categoría: {str(e)}')
        return redirect(url_for('admin_analytics'))


@app.route('/admin/actualizar_metricas_categorias')
@admin_required
def admin_actualizar_metricas_categorias():
    try:
        actualizar_todas_metricas_categorias()
        flash('✓ Métricas de categorías actualizadas exitosamente', 'success')
    except Exception as e:
        flash(f'Error al actualizar métricas: {str(e)}', 'danger')
        app.logger.error(f'Error actualizando métricas: {str(e)}')

    return redirect(url_for('admin_analytics_categorias'))


# ==================== PANEL DE ANALYTICS GENERAL ====================

# ==================== PANEL DE ANALYTICS INTEGRADO (CON CATEGORÍAS) ====================

@app.route('/admin/analytics')
@admin_required
def admin_analytics():
    try:
        # === MÉTRICAS GENERALES ===
        total_usuarios = Usuario.query.count()
        total_productos = Producto.query.count()
        total_pedidos = Pedido.query.count()
        total_ventas = db.session.query(db.func.sum(Pedido.total)).scalar() or 0

        ticket_promedio_global = total_ventas / total_pedidos if total_pedidos > 0 else 0

        # === SEGMENTACIÓN DE USUARIOS ===
        usuarios_por_segmento = db.session.query(
            Usuario.segmento_cliente,
            db.func.count(Usuario.ID_Users).label('cantidad')
        ).group_by(Usuario.segmento_cliente).all()

        segmentacion = {seg: cant for seg, cant in usuarios_por_segmento}

        # === TOP CLIENTES ===
        top_clientes = Usuario.query.filter(
            Usuario.total_compras > 0
        ).order_by(Usuario.total_gastado.desc()).limit(10).all()

        # === PRODUCTOS MÁS VENDIDOS ===
        productos_mas_vendidos = db.session.query(
            Producto.nombre,
            Producto.imagen,
            Producto.precio,
            db.func.sum(DetallePedido.cantidad).label('total_vendido'),
            db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario).label('ingresos')
        ).join(DetallePedido, DetallePedido.ID_Producto == Producto.ID_Producto
        ).group_by(Producto.ID_Producto
        ).order_by(db.desc('total_vendido')
        ).limit(10).all()

        # === PRODUCTOS BAJO STOCK ===
        productos_bajo_stock = Producto.query.filter(
            Producto.stock > 0,
            Producto.stock <= 10,
            Producto.disponible == True
        ).order_by(Producto.stock.asc()).limit(10).all()

        # === PRODUCTOS ABANDONADOS ===
        productos_abandonados = db.session.query(
            Producto.nombre,
            Producto.imagen,
            Producto.precio,
            db.func.count(HistorialCarrito.ID_Historial).label('veces_agregado'),
            db.func.sum(HistorialCarrito.valor_total).label('valor_perdido')
        ).join(HistorialCarrito, HistorialCarrito.ID_Producto == Producto.ID_Producto
        ).filter(
            HistorialCarrito.accion == 'abandonar'
        ).group_by(Producto.ID_Producto
        ).order_by(db.desc('valor_perdido')
        ).limit(10).all()

        # === MÉTRICAS DE WALLET ===
        total_recargado = db.session.query(
            db.func.sum(TransaccionWallet.monto)
        ).filter(TransaccionWallet.tipo == 'recarga').scalar() or 0

        total_recargas = db.session.query(
            db.func.count(TransaccionWallet.ID_Transaccion)
        ).filter(TransaccionWallet.tipo == 'recarga').scalar() or 0

        recarga_promedio_global = total_recargado / total_recargas if total_recargas > 0 else 0

        saldo_total_usuarios = db.session.query(
            db.func.sum(Wallet.saldo)
        ).scalar() or 0

        # === MÉTRICAS DE CONVERSIÓN ===
        total_productos_agregados = db.session.query(
            db.func.sum(HistorialCarrito.cantidad)
        ).filter(HistorialCarrito.accion == 'agregar').scalar() or 0

        total_productos_comprados = db.session.query(
            db.func.sum(DetallePedido.cantidad)
        ).scalar() or 0

        tasa_conversion_global = (total_productos_comprados / total_productos_agregados * 100) if total_productos_agregados > 0 else 0

        total_abandonos = db.session.query(
            db.func.count(db.distinct(HistorialCarrito.ID_Users))
        ).filter(HistorialCarrito.accion == 'abandonar').scalar() or 0

        valor_abandonos = db.session.query(
            db.func.sum(HistorialCarrito.valor_total)
        ).filter(HistorialCarrito.accion == 'abandonar').scalar() or 0

        # === VENTAS DIARIAS (ÚLTIMOS 30 DÍAS) ===
        hace_30_dias = datetime.utcnow() - timedelta(days=30)
        ventas_diarias = db.session.query(
            db.func.date(Pedido.fecha).label('fecha'),
            db.func.sum(Pedido.total).label('total_dia'),
            db.func.count(Pedido.ID_Pedido).label('pedidos_dia')
        ).filter(Pedido.fecha >= hace_30_dias
        ).group_by(db.func.date(Pedido.fecha)
        ).order_by('fecha').all()

        # === USUARIOS NUEVOS DIARIOS ===
        usuarios_nuevos_diarios = db.session.query(
            db.func.date(Usuario.fecha_registro).label('fecha'),
            db.func.count(Usuario.ID_Users).label('nuevos')
        ).filter(Usuario.fecha_registro >= hace_30_dias
        ).group_by(db.func.date(Usuario.fecha_registro)
        ).order_by('fecha').all()

        # === PEDIDOS RECIENTES ===
        pedidos_recientes = Pedido.query.order_by(
            Pedido.fecha.desc()
        ).limit(10).all()

        # === USUARIOS ACTIVOS HOY ===
        usuarios_activos_hoy = Usuario.query.filter(
            Usuario.ultima_actividad >= datetime.utcnow() - timedelta(days=1)
        ).count()

        # ✅ === ANALYTICS DE CATEGORÍAS (INTEGRADO) ===

        # Categorías por ingresos
        categorias_por_ingresos = db.session.query(
            Categoria.ID_Categoria,
            Categoria.nombre,
            Categoria.icono,
            MetricaCategoria.ingresos_totales,
            MetricaCategoria.total_productos_vendidos,
            MetricaCategoria.total_pedidos,
            MetricaCategoria.tasa_conversion,
            MetricaCategoria.total_agregados_carrito,
            MetricaCategoria.valor_abandonos
        ).join(
            MetricaCategoria, MetricaCategoria.ID_Categoria == Categoria.ID_Categoria
        ).filter(
            Categoria.activa == True
        ).order_by(MetricaCategoria.ingresos_totales.desc()).all()

        # Mejor conversión
        mejor_conversion = db.session.query(
            Categoria.nombre,
            Categoria.icono,
            MetricaCategoria.tasa_conversion,
            MetricaCategoria.total_agregados_carrito,
            MetricaCategoria.total_productos_vendidos
        ).join(
            MetricaCategoria, MetricaCategoria.ID_Categoria == Categoria.ID_Categoria
        ).filter(
            Categoria.activa == True,
            MetricaCategoria.total_agregados_carrito > 0
        ).order_by(MetricaCategoria.tasa_conversion.desc()).first()

        # Más abandonos
        mas_abandonos = db.session.query(
            Categoria.nombre,
            Categoria.icono,
            MetricaCategoria.valor_abandonos,
            MetricaCategoria.total_abandonos
        ).join(
            MetricaCategoria, MetricaCategoria.ID_Categoria == Categoria.ID_Categoria
        ).filter(
            Categoria.activa == True
        ).order_by(MetricaCategoria.valor_abandonos.desc()).limit(5).all()

        # Top productos por categoría
        productos_top_por_categoria = {}
        categorias = Categoria.query.filter_by(activa=True).all()

        for cat in categorias:
            productos = db.session.query(
                Producto.nombre,
                Producto.imagen,
                Producto.precio,
                db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('total_vendido'),
                db.func.coalesce(db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario), 0).label('ingresos')
            ).outerjoin(
                DetallePedido, DetallePedido.ID_Producto == Producto.ID_Producto
            ).filter(
                Producto.ID_Categoria == cat.ID_Categoria
            ).group_by(Producto.ID_Producto
            ).order_by(db.desc('total_vendido')
            ).limit(10).all()

            if productos and any(p.total_vendido > 0 for p in productos):
                productos_top_por_categoria[cat.nombre] = [p for p in productos if p.total_vendido > 0]

        # Ranking de subcategorías
        subcategorias_ranking = db.session.query(
            Subcategoria.nombre,
            Categoria.nombre.label('categoria_nombre'),
            Categoria.icono,
            MetricaSubcategoria.ingresos_totales,
            MetricaSubcategoria.total_productos_vendidos,
            MetricaSubcategoria.tasa_conversion
        ).join(
            Categoria, Categoria.ID_Categoria == Subcategoria.ID_Categoria
        ).join(
            MetricaSubcategoria, MetricaSubcategoria.ID_Subcategoria == Subcategoria.ID_Subcategoria
        ).filter(
            Subcategoria.activa == True
        ).order_by(MetricaSubcategoria.ingresos_totales.desc()).limit(15).all()

        # Distribución de ventas
        distribucion_ventas = []
        total_ventas_global = db.session.query(
            db.func.sum(MetricaCategoria.ingresos_totales)
        ).scalar() or 1

        for cat in categorias:
            metricas = MetricaCategoria.query.filter_by(ID_Categoria=cat.ID_Categoria).first()
            if metricas and metricas.ingresos_totales > 0:
                porcentaje = (metricas.ingresos_totales / total_ventas_global) * 100
                distribucion_ventas.append({
                    'nombre': cat.nombre,
                    'ingresos': metricas.ingresos_totales,
                    'porcentaje': porcentaje,
                    'icono': cat.icono
                })

        # Productos con mejor conversión
        productos_mejor_conversion = db.session.query(
            Producto.nombre,
            Producto.imagen,
            Categoria.nombre.label('categoria'),
            db.func.coalesce(db.func.sum(DetallePedido.cantidad), 0).label('vendidos'),
            db.func.coalesce(db.func.sum(
                db.case(
                    (HistorialCarrito.accion == 'agregar', HistorialCarrito.cantidad),
                    else_=0
                )
            ), 0).label('agregados')
        ).outerjoin(
            Categoria, Categoria.ID_Categoria == Producto.ID_Categoria
        ).outerjoin(
            DetallePedido, DetallePedido.ID_Producto == Producto.ID_Producto
        ).outerjoin(
            HistorialCarrito, HistorialCarrito.ID_Producto == Producto.ID_Producto
        ).group_by(Producto.ID_Producto).all()

        productos_conversion = []
        for p in productos_mejor_conversion:
            vendidos = p.vendidos or 0
            agregados = p.agregados or 0
            if agregados > 0 and vendidos > 0:
                conversion = (vendidos / agregados) * 100
                productos_conversion.append({
                    'nombre': p.nombre,
                    'imagen': p.imagen,
                    'categoria': p.categoria or 'Sin categoría',
                    'vendidos': vendidos,
                    'agregados': agregados,
                    'conversion': conversion
                })

        productos_conversion.sort(key=lambda x: x['conversion'], reverse=True)
        productos_conversion = productos_conversion[:10]

        # Categorías más agregadas
        categorias_mas_agregadas = db.session.query(
            Categoria.nombre,
            Categoria.icono,
            MetricaCategoria.total_agregados_carrito,
            MetricaCategoria.total_productos_vendidos,
            MetricaCategoria.tasa_conversion
        ).join(
            MetricaCategoria, MetricaCategoria.ID_Categoria == Categoria.ID_Categoria
        ).filter(
            Categoria.activa == True
        ).order_by(MetricaCategoria.total_agregados_carrito.desc()).limit(5).all()

        return render_template('admin/analytics.html',
            # Métricas generales
            total_usuarios=total_usuarios,
            total_productos=total_productos,
            total_pedidos=total_pedidos,
            total_ventas=total_ventas,
            ticket_promedio_global=ticket_promedio_global,
            segmentacion=segmentacion,
            top_clientes=top_clientes,
            productos_mas_vendidos=productos_mas_vendidos,
            productos_bajo_stock=productos_bajo_stock,
            productos_abandonados=productos_abandonados,
            total_recargado=total_recargado,
            total_recargas=total_recargas,
            recarga_promedio_global=recarga_promedio_global,
            saldo_total_usuarios=saldo_total_usuarios,
            tasa_conversion_global=tasa_conversion_global,
            total_abandonos=total_abandonos,
            valor_abandonos=valor_abandonos,
            ventas_diarias=ventas_diarias,
            usuarios_nuevos_diarios=usuarios_nuevos_diarios,
            pedidos_recientes=pedidos_recientes,
            usuarios_activos_hoy=usuarios_activos_hoy,
            # ✅ Analytics de categorías (integrado)
            categorias_por_ingresos=categorias_por_ingresos,
            mejor_conversion=mejor_conversion,
            mas_abandonos=mas_abandonos,
            productos_top_por_categoria=productos_top_por_categoria,
            subcategorias_ranking=subcategorias_ranking,
            distribucion_ventas=distribucion_ventas,
            productos_mejor_conversion=productos_conversion,
            categorias_mas_agregadas=categorias_mas_agregadas
        )

    except Exception as e:
        flash(f'Error al cargar analytics: {str(e)}', 'danger')
        app.logger.error(f'Error en analytics: {str(e)}')
        return redirect(url_for('admin_dashboard'))


@app.route('/admin/usuario/<int:usuario_id>/metricas')
@admin_required
def admin_usuario_metricas(usuario_id):
    try:
        usuario = Usuario.query.get_or_404(usuario_id)

        transacciones = TransaccionWallet.query.filter_by(
            ID_Users=usuario_id
        ).order_by(TransaccionWallet.fecha.desc()).limit(50).all()

        recargas = [t for t in transacciones if t.tipo == 'recarga']
        compras = [t for t in transacciones if t.tipo == 'compra']
        admin_recargas = [t for t in transacciones if t.tipo == 'admin']

        historial_carrito = db.session.query(
            HistorialCarrito,
            Producto.nombre.label('producto_nombre')
        ).join(Producto).filter(
            HistorialCarrito.ID_Users == usuario_id
        ).order_by(HistorialCarrito.fecha.desc()).limit(100).all()

        agregados = [(h[0], h[1]) for h in historial_carrito if h[0].accion == 'agregar']
        quitados = [(h[0], h[1]) for h in historial_carrito if h[0].accion == 'quitar']
        comprados = [(h[0], h[1]) for h in historial_carrito if h[0].accion == 'comprar']
        abandonados = [(h[0], h[1]) for h in historial_carrito if h[0].accion == 'abandonar']

        productos_favoritos = db.session.query(
            Producto.nombre,
            Producto.imagen,
            db.func.sum(DetallePedido.cantidad).label('total_comprado'),
            db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario).label('gasto_total')
        ).join(DetallePedido).join(Pedido).filter(
            Pedido.ID_Users == usuario_id
        ).group_by(Producto.ID_Producto).order_by(
            db.desc('total_comprado')
        ).limit(10).all()

        productos_no_comprados = db.session.query(
            Producto.nombre,
            Producto.imagen,
            Producto.precio,
            db.func.sum(HistorialCarrito.cantidad).label('veces_agregado'),
            db.func.sum(HistorialCarrito.valor_total).label('valor_total')
        ).join(HistorialCarrito).filter(
            HistorialCarrito.ID_Users == usuario_id,
            HistorialCarrito.accion == 'abandonar'
        ).group_by(Producto.ID_Producto).order_by(
            db.desc('veces_agregado')
        ).limit(10).all()

        if usuario.total_compras > 1:
            pedidos_fechas = [p.fecha for p in usuario.pedidos]
            pedidos_fechas.sort()
            diferencias = [(pedidos_fechas[i+1] - pedidos_fechas[i]).days for i in range(len(pedidos_fechas)-1)]
            promedio_dias_entre_compras = sum(diferencias) / len(diferencias) if diferencias else 0
        else:
            promedio_dias_entre_compras = 0

        return render_template('admin/usuario_metricas.html',
            usuario=usuario,
            transacciones=transacciones,
            recargas=recargas,
            compras=compras,
            admin_recargas=admin_recargas,
            historial_carrito=historial_carrito,
            agregados=agregados,
            quitados=quitados,
            comprados=comprados,
            abandonados=abandonados,
            productos_favoritos=productos_favoritos,
            productos_no_comprados=productos_no_comprados,
            promedio_dias_entre_compras=promedio_dias_entre_compras
        )

    except Exception as e:
        flash(f'Error al cargar métricas del usuario: {str(e)}', 'danger')
        app.logger.error(f'Error en métricas de usuario: {str(e)}')
        return redirect(url_for('admin_usuarios'))


# ==================== EXPORTAR CSV ====================

@app.route('/admin/exportar/usuarios_csv')
@admin_required
def exportar_usuarios_csv():
    try:
        si = StringIO()
        writer = csv.writer(si)

        writer.writerow([
            'ID_Usuario', 'Nombre', 'Email', 'Fecha_Registro', 'Segmento',
            'Total_Compras', 'Total_Gastado', 'Ticket_Promedio',
            'Total_Recargas', 'Dinero_Recargado', 'Recarga_Promedio',
            'Productos_Carrito_Actual', 'Valor_Carrito_Actual',
            'Total_Productos_Agregados', 'Carritos_Abandonados',
            'Tasa_Conversion', 'Dias_Desde_Ultima_Compra', 'Saldo_Actual'
        ])

        usuarios = Usuario.query.all()
        for u in usuarios:
            writer.writerow([
                u.ID_Users,
                u.nombre,
                u.email,
                u.fecha_registro.strftime('%Y-%m-%d') if u.fecha_registro else '',
                u.segmento_cliente,
                u.total_compras,
                f'{u.total_gastado:.2f}',
                f'{u.ticket_promedio:.2f}',
                u.total_recargas,
                f'{u.dinero_recargado_total:.2f}',
                f'{u.recarga_promedio:.2f}',
                u.productos_carrito_actual,
                f'{u.valor_carrito_actual:.2f}',
                u.productos_agregados_carrito_total,
                u.carritos_abandonados,
                f'{u.tasa_conversion:.2f}',
                u.dias_desde_ultima_compra or '',
                f'{u.wallet.saldo:.2f}' if u.wallet else '0.00'
            ])

        output = make_response(si.getvalue())
        output.headers["Content-Disposition"] = "attachment; filename=usuarios_analytics.csv"
        output.headers["Content-type"] = "text/csv"

        return output

    except Exception as e:
        flash(f'Error al exportar CSV: {str(e)}', 'danger')
        app.logger.error(f'Error en exportar CSV: {str(e)}')
        return redirect(url_for('admin_analytics'))


@app.route('/admin/exportar/productos_csv')
@admin_required
def exportar_productos_csv():
    try:
        si = StringIO()
        writer = csv.writer(si)

        writer.writerow([
            'ID_Producto', 'Nombre', 'Precio', 'Stock', 'Disponible',
            'Total_Vendido', 'Ingresos_Totales',
            'Veces_Agregado_Carrito', 'Veces_Abandonado',
            'Tasa_Conversion_Producto'
        ])

        productos = Producto.query.all()
        for p in productos:
            total_vendido = db.session.query(
                db.func.sum(DetallePedido.cantidad)
            ).filter(DetallePedido.ID_Producto == p.ID_Producto).scalar() or 0

            ingresos = db.session.query(
                db.func.sum(DetallePedido.cantidad * DetallePedido.precio_unitario)
            ).filter(DetallePedido.ID_Producto == p.ID_Producto).scalar() or 0

            veces_agregado = db.session.query(
                db.func.sum(HistorialCarrito.cantidad)
            ).filter(
                HistorialCarrito.ID_Producto == p.ID_Producto,
                HistorialCarrito.accion == 'agregar'
            ).scalar() or 0

            veces_abandonado = db.session.query(
                db.func.sum(HistorialCarrito.cantidad)
            ).filter(
                HistorialCarrito.ID_Producto == p.ID_Producto,
                HistorialCarrito.accion == 'abandonar'
            ).scalar() or 0

            tasa_conv = (total_vendido / veces_agregado * 100) if veces_agregado > 0 else 0

            writer.writerow([
                p.ID_Producto,
                p.nombre,
                f'{p.precio:.2f}',
                p.stock,
                'Sí' if p.disponible else 'No',
                total_vendido,
                f'{ingresos:.2f}',
                veces_agregado,
                veces_abandonado,
                f'{tasa_conv:.2f}%'
            ])

        output = make_response(si.getvalue())
        output.headers["Content-Disposition"] = "attachment; filename=productos_analytics.csv"
        output.headers["Content-type"] = "text/csv"

        return output

    except Exception as e:
        flash(f'Error al exportar CSV: {str(e)}', 'danger')
        app.logger.error(f'Error en exportar CSV: {str(e)}')
        return redirect(url_for('admin_analytics'))


@app.route('/admin/exportar/ventas_csv')
@admin_required
def exportar_ventas_csv():
    """Exporta ventas (detalles de pedidos) en formato CSV. Parámetros GET opcionales: desde=YYYY-MM-DD, hasta=YYYY-MM-DD"""
    try:
        desde = request.args.get('desde')
        hasta = request.args.get('hasta')
        fmt = '%Y-%m-%d'

        q = Pedido.query
        if desde:
            try:
                d_from = datetime.strptime(desde, fmt)
                q = q.filter(Pedido.fecha >= d_from)
            except Exception:
                pass
        if hasta:
            try:
                d_to = datetime.strptime(hasta, fmt)
                # incluir todo el día
                d_to_end = d_to.replace(hour=23, minute=59, second=59)
                q = q.filter(Pedido.fecha <= d_to_end)
            except Exception:
                pass

        pedidos = q.order_by(Pedido.fecha.desc()).all()

        si = StringIO()
        writer = csv.writer(si)

        writer.writerow([
            'ID_Pedido', 'Fecha', 'ID_Usuario', 'Email_Usuario', 'ID_Producto', 'Nombre_Producto',
            'Cantidad', 'Precio_Unitario', 'Subtotal_Item', 'Total_Pedido', 'Categoria', 'Subcategoria'
        ])

        for pedido in pedidos:
            usuario = Usuario.query.get(pedido.ID_Users) if pedido.ID_Users else None
            detalles = DetallePedido.query.filter_by(ID_Pedido=pedido.ID_Pedido).all()
            total_pedido = pedido.total
            if not detalles:
                # registrar fila del pedido sin items
                writer.writerow([
                    pedido.ID_Pedido,
                    pedido.fecha.strftime('%Y-%m-%d %H:%M:%S'),
                    usuario.ID_Users if usuario else '',
                    usuario.email if usuario else '',
                    '', '', '', '', '',
                    f'{total_pedido:.2f}', '', ''
                ])
            else:
                for d in detalles:
                    producto = Producto.query.get(d.ID_Producto)
                    categoria = None
                    subcat = None
                    if producto:
                        categoria = Categoria.query.get(producto.ID_Categoria) if producto.ID_Categoria else None
                        subcat = Subcategoria.query.get(producto.ID_Subcategoria) if producto.ID_Subcategoria else None
                    subtotal = (d.cantidad or 0) * (d.precio_unitario or 0)
                    writer.writerow([
                        pedido.ID_Pedido,
                        pedido.fecha.strftime('%Y-%m-%d %H:%M:%S'),
                        usuario.ID_Users if usuario else '',
                        usuario.email if usuario else '',
                        producto.ID_Producto if producto else d.ID_Producto,
                        producto.nombre if producto else '',
                        d.cantidad,
                        f'{d.precio_unitario:.2f}',
                        f'{subtotal:.2f}',
                        f'{total_pedido:.2f}',
                        categoria.nombre if categoria else '',
                        subcat.nombre if subcat else ''
                    ])

        filename = 'ventas'
        if desde: filename += f'_{desde}'
        if hasta: filename += f'_{hasta}'
        filename += '.csv'

        output = make_response(si.getvalue())
        output.headers["Content-Disposition"] = f"attachment; filename={filename}"
        output.headers["Content-type"] = "text/csv"
        return output

    except Exception as e:
        flash(f'Error al exportar ventas CSV: {str(e)}', 'danger')
        app.logger.error(f'Error en exportar ventas CSV: {str(e)}')
        return redirect(url_for('admin_dashboard'))


@app.route('/admin/exportar/ventas_simple_csv')
@admin_required
def exportar_ventas_simple_csv():
    """Exporta resumen de ventas (one-row-per-pedido) en CSV. Parámetros GET opcionales: desde=YYYY-MM-DD, hasta=YYYY-MM-DD.
    Limita el rango a 90 días para evitar exportaciones demasiado grandes.
    """
    try:
        desde = request.args.get('desde')
        hasta = request.args.get('hasta')
        fmt = '%Y-%m-%d'
        now = datetime.utcnow()

        # Determinar rango por defecto (últimos 30 días)
        if desde:
            try:
                d_from = datetime.strptime(desde, fmt)
            except Exception:
                d_from = now - timedelta(days=30)
        else:
            d_from = now - timedelta(days=30)

        if hasta:
            try:
                d_to = datetime.strptime(hasta, fmt)
            except Exception:
                d_to = now
        else:
            d_to = now

        # incluir todo el día final
        d_to_end = d_to.replace(hour=23, minute=59, second=59)

        # Validar rango máximo
        max_days = 90
        if (d_to_end - d_from).days > max_days:
            flash(f'El rango máximo permitido para exportar es de {max_days} días. Por favor selecciona un rango menor.', 'warning')
            return redirect(url_for('admin_dashboard'))

        pedidos = Pedido.query.filter(Pedido.fecha >= d_from, Pedido.fecha <= d_to_end).order_by(Pedido.fecha.desc()).all()

        si = StringIO()
        writer = csv.writer(si)

        writer.writerow([
            'ID_Pedido', 'Fecha', 'ID_Usuario', 'Email_Usuario', 'Cantidad_Items', 'Productos_Resumen', 'Total_Pedido', 'Estado'
        ])

        for pedido in pedidos:
            usuario = Usuario.query.get(pedido.ID_Users) if pedido.ID_Users else None
            detalles = DetallePedido.query.filter_by(ID_Pedido=pedido.ID_Pedido).all()
            cantidad_items = sum([d.cantidad or 0 for d in detalles]) if detalles else 0
            productos_resumen = ''
            if detalles:
                partes = []
                for d in detalles:
                    prod = Producto.query.get(d.ID_Producto)
                    nombre = prod.nombre if prod else f'ID_{d.ID_Producto}'
                    partes.append(f"{nombre} x{d.cantidad}")
                productos_resumen = '; '.join(partes)

            writer.writerow([
                pedido.ID_Pedido,
                pedido.fecha.strftime('%Y-%m-%d %H:%M:%S'),
                usuario.ID_Users if usuario else '',
                usuario.email if usuario else '',
                cantidad_items,
                productos_resumen,
                f'{pedido.total:.2f}',
                pedido.estado
            ])

        filename = f"ventas_simple_{d_from.strftime('%Y%m%d')}_{d_to.strftime('%Y%m%d')}.csv"
        output = make_response(si.getvalue())
        output.headers["Content-Disposition"] = f"attachment; filename={filename}"
        output.headers["Content-type"] = "text/csv"
        return output

    except Exception as e:
        flash(f'Error al exportar ventas (simple) CSV: {str(e)}', 'danger')
        app.logger.error(f'Error en exportar ventas simple CSV: {str(e)}')
        return redirect(url_for('admin_dashboard'))


# ==================== MANEJADORES DE ERRORES ====================

@app.errorhandler(404)
def page_not_found(e):
    return render_template('errors/404.html'), 404

@app.errorhandler(500)
def internal_server_error(e):
    return render_template('errors/500.html'), 500

@app.errorhandler(403)
def forbidden(e):
    return render_template('errors/403.html'), 403

@app.errorhandler(400)
def bad_request(e):
    return render_template('errors/400.html'), 400


# ==================== INICIALIZACIÓN ====================

def insertar_productos_ejemplo():
    """Inserta datos de ejemplo si la base de datos está vacía"""
    with app.app_context():
        try:
            if Producto.query.count() == 0:
                productos_ejemplo = [
                    Producto(nombre='Tarjeta Gráfica GTX 1650', precio=230,
                            imagen='img/Gtx.png', disponible=True, stock=15),
                    Producto(nombre='Tarjeta gráfica RTX 4090', precio=1800,
                            imagen='img/RTX4090.png', disponible=False, stock=0),
                    Producto(nombre='Monitor Xiaomi G34', precio=500,
                            imagen='img/MonitorXiaomiG34.png', disponible=True, stock=8),
                ]

                for producto in productos_ejemplo:
                    db.session.add(producto)

                db.session.commit()
                print("✓ Productos de ejemplo insertados correctamente")
            else:
                print("✓ Ya existen productos en la base de datos")

            admin = Usuario.query.filter_by(email='admin@axionstore.com').first()
            if not admin:
                hashed_password = generate_password_hash('admin123', method='pbkdf2:sha256')
                admin = Usuario(
                    nombre='Administrador',
                    email='admin@axionstore.com',
                    password=hashed_password,
                    es_admin=True
                )
                db.session.add(admin)
                db.session.commit()

                wallet = Wallet(ID_Users=admin.ID_Users, saldo=10000.0)
                db.session.add(wallet)
                db.session.commit()
                print("✓ Usuario administrador creado: admin@axionstore.com / admin123")

        except Exception as e:
            db.session.rollback()
            print(f"Error al insertar datos: {str(e)}")


def inicializar_aplicacion():
    """
    Función principal de inicialización que:
    1. Verifica la conexión a la base de datos
    2. Crea las tablas si no existen
    3. Inserta datos de ejemplo
    """
    print("=" * 50)
    print("INICIALIZANDO AXION STORE")
    print("=" * 50)

    with app.app_context():
        # Paso 1: Crear tablas
        print("\n[1/3] Creando/verificando tablas en la base de datos...")
        try:
            db.create_all()
            print("✓ Tablas creadas/verificadas exitosamente")
        except Exception as e:
            print(f"✗ Error al crear tablas: {str(e)}")
            return False

        # Paso 2: Verificar conexión
        print("\n[2/3] Verificando conexión a la base de datos...")
        try:
            db.session.execute(db.text('SELECT 1'))
            print("✓ Conexión establecida correctamente")
        except Exception as e:
            print(f"✗ Error de conexión: {str(e)}")
            return False

        # Paso 3: Insertar datos de ejemplo
        print("\n[3/3] Verificando datos iniciales...")
        insertar_productos_ejemplo()

    print("\n" + "=" * 50)
    print("✓ INICIALIZACIÓN COMPLETADA")
    print("=" * 50)
    return True


# ==================== PUNTO DE ENTRADA ====================

if __name__ == '__main__':
    # Inicializar la aplicación (crear tablas, datos de ejemplo, etc.)
    if inicializar_aplicacion():
        # Ejecutar el servidor
        app.run(debug=True, host='0.0.0.0', port=5000)
    else:
        print("Error: No se pudo inicializar la aplicación")

