{% extends 'base.html' %}
{% block title %}Agregar Producto - Admin{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- FORMULARIO PRINCIPAL -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Agregar Nuevo Producto
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_agregar_producto') }}" enctype="multipart/form-data">
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto *</label>
                            <input type="text" name="nombre" class="form-control" required maxlength="200">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Precio ($) *</label>
                                    <input type="number" step="0.01" name="precio" class="form-control" required min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Stock *</label>
                                    <input type="number" name="stock" class="form-control" required min="0">
                                </div>
                            </div>
                        </div>

                        <!-- CATEGORÍAS -->
                        <div class="card mb-3 bg-light border">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-tags"></i> Categorización
                                    <a href="{{ url_for('admin_categorias_referencia') }}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-outline-info float-end">
                                        <i class="fas fa-book"></i> Ver Referencia
                                    </a>
                                </h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">
                                        Categoría Principal
                                        <small class="text-muted">(Opcional)</small>
                                    </label>
                                    <select name="ID_Categoria" id="selectCategoria" class="form-select" onchange="cargarSubcategorias()">
                                        <option value="">-- Sin categoría --</option>
                                        {% for cat in categorias %}
                                        <option value="{{ cat.ID_Categoria }}" 
                                                data-subcategorias='[{% for sub in cat.subcategorias %}{"ID_Subcategoria": {{ sub.ID_Subcategoria }}, "nombre": "{{ sub.nombre|e }}", "activa": {{ "true" if sub.activa else "false" }}}{% if not loop.last %},{% endif %}{% endfor %}]'>
                                            [ID: {{ cat.ID_Categoria }}] {{ cat.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Subcategoría
                                        <small class="text-muted">(Opcional)</small>
                                    </label>
                                    <select name="ID_Subcategoria" id="selectSubcategoria" class="form-select" disabled>
                                        <option value="">-- Primero selecciona una categoría --</option>
                                    </select>
                                    <small class="text-muted">
                                        Selecciona primero una categoría para ver sus subcategorías
                                    </small>
                                </div>

                                <div id="previewCategoria" class="alert alert-secondary d-none">
                                    <strong>Seleccionado:</strong> <span id="textCategoria"></span>
                                </div>
                            </div>
                        </div>

                        <!-- IMAGEN -->
                        <div class="mb-3">
                            <label class="form-label">Imagen del Producto</label>
                            <input type="file" name="imagen_file" class="form-control" accept="image/*" onchange="previewImagen(event)">
                            <small class="text-muted">Formatos permitidos: PNG, JPG, JPEG, GIF, WEBP (máx 2MB)</small>
                            <div class="mt-2">
                                <small class="text-muted">O ingresa URL de imagen:</small>
                                <input type="text" name="imagen" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                            </div>
                            <div id="imagePreview" class="mt-2"></div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="disponible" id="disponible" checked>
                            <label class="form-check-label" for="disponible">
                                <strong>Producto disponible para la venta</strong>
                            </label>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Agregar Producto
                            </button>
                            <a href="{{ url_for('admin_productos') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- PANEL DE AYUDA -->
        <div class="col-md-4">
            <div class="card shadow mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Ayuda
                    </h5>
                </div>
                <div class="card-body">
                    <h6>Categorías Disponibles:</h6>
                    
                    {% if categorias %}
                    <ul class="list-unstyled">
                        {% for cat in categorias %}
                        <li class="mb-3">
                            <i class="{{ cat.icono or 'fa-box' }}"></i> 
                            <strong>{{ cat.nombre }}</strong>
                            <span class="badge bg-secondary">ID: {{ cat.ID_Categoria }}</span>
                            
                            {% if cat.subcategorias %}
                            <ul class="mt-2 small">
                                {% for sub in cat.subcategorias|sort(attribute='orden') %}
                                <li>
                                    {{ sub.nombre }}
                                    <span class="badge bg-light text-dark">ID: {{ sub.ID_Subcategoria }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="alert alert-warning">
                        No hay categorías creadas.
                        <a href="{{ url_for('admin_agregar_categoria') }}" class="alert-link">Crear ahora</a>
                    </div>
                    {% endif %}
                    
                    <hr>
                    
                    <h6>Consejos:</h6>
                    <ul class="small">
                        <li>Si no asignas categoría, el producto aparecerá en "Sin categoría"</li>
                        <li>Puedes asignar solo categoría principal sin subcategoría</li>
                        <li>La subcategoría es opcional</li>
                        <li>Usa la referencia para ver todos los IDs</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Importante
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li>Los campos con (*) son obligatorios</li>
                        <li>El precio debe ser mayor a 0</li>
                        <li>El stock puede ser 0 (sin stock)</li>
                        <li>Si el stock es 0, considera marcar como "No disponible"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function cargarSubcategorias() {
    const selectCat = document.getElementById('selectCategoria');
    const selectSub = document.getElementById('selectSubcategoria');
    const preview = document.getElementById('previewCategoria');
    const textCategoria = document.getElementById('textCategoria');
    
    const selectedOption = selectCat.options[selectCat.selectedIndex];
    const categoriaId = selectCat.value;
    const categoriaNombre = selectedOption.text;
    
    // Limpiar subcategorías
    selectSub.innerHTML = '<option value="">-- Seleccionar subcategoría (opcional) --</option>';
    
    if (!categoriaId) {
        selectSub.disabled = true;
        preview.classList.add('d-none');
        return;
    }
    
    selectSub.disabled = false;
    
    // Obtener subcategorías del atributo data
    try {
        const subcategorias = JSON.parse(selectedOption.dataset.subcategorias || '[]');
        
        if (subcategorias.length > 0) {
            subcategorias.forEach(sub => {
                if (sub.activa) {
                    const option = document.createElement('option');
                    option.value = sub.ID_Subcategoria;
                    option.textContent = `[ID: ${sub.ID_Subcategoria}] ${sub.nombre}`;
                    selectSub.appendChild(option);
                }
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '-- No hay subcategorías disponibles --';
            selectSub.appendChild(option);
        }
    } catch (e) {
        console.error('Error cargando subcategorías:', e);
    }
    
    // Mostrar preview
    preview.classList.remove('d-none');
    textCategoria.textContent = categoriaNombre;
}

// Actualizar preview cuando cambia subcategoría
document.getElementById('selectSubcategoria').addEventListener('change', function() {
    const selectCat = document.getElementById('selectCategoria');
    const textCategoria = document.getElementById('textCategoria');
    
    const categoriaNombre = selectCat.options[selectCat.selectedIndex].text;
    const subcategoriaNombre = this.options[this.selectedIndex].text;
    
    if (this.value) {
        textCategoria.textContent = `${categoriaNombre} → ${subcategoriaNombre}`;
    } else {
        textCategoria.textContent = categoriaNombre;
    }
});

function previewImagen(event) {
    const preview = document.getElementById('imagePreview');
    const file = event.target.files[0];
    
    if (file) {
        // Validar tamaño
        if (file.size > 2 * 1024 * 1024) {
            alert('La imagen es muy grande. Máximo 2MB.');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px;">`;
        }
        reader.readAsDataURL(file);
    }
}
</script>
{% endblock %}
